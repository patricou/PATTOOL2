<!-- Standard Title Section -->
<div class="pat-title">
    <h2>{{ "EVENTCREATION.TITLE" | translate }}</h2>
    <app-navigation-buttons></app-navigation-buttons>
</div>

<!-- Main Content -->
<div class="container mt-0">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <form #f="ngForm" novalidate autocomplete="false" (ngSubmit)=" f.valid && saveEvenement(f.value, f.valid) " class="modern-form">
                
                <!-- Basic Information Card -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-info-circle"></i>
                        <h3>{{ "EVENTHOME.BASIC_INFO" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        
                        <!-- Author (Read-only) -->
                        <div class="form-group">
                            <label for="authorLastName" class="form-label">
                                <i class="fa fa-user"></i>
                                {{ "EVENTCREATION.EVENTAUTHORNAME" | translate }}
                            </label>
                            <div class="input-group">
                                <input id="authorLastName" readonly [(ngModel)]="author" name="author" type="text"
                                    class="form-control" required>
                                <div class="input-group-text">
                                    <small class="text-muted">ID: {{user.id}}</small>
                                </div>
                            </div>
                        </div>

                        <!-- Event Name -->
                        <div class="form-group" [class.has-error]="EvenementName.invalid && f.submitted">
                            <label for="EvenementName" class="form-label">
                                <i class="fa fa-tag"></i>
                                {{ "EVENTCREATION.EVENTNAME" | translate }}
                                <span class="required">*</span>
                            </label>
                            <input id="EvenementName" #EvenementName="ngModel" [(ngModel)]="evenement.evenementName"
                                name="EvenementName" type="text" placeholder="{{ 'EVENTCREATION.EVENTNAMEPLHD' | translate }}"
                                class="form-control" required [disabled]="!canEditEventFields()">
                            <div class="error-message" [hidden]="!EvenementName.invalid || !f.submitted">
                                <i class="fa fa-exclamation-triangle"></i>
                                {{ "EVENTCREATION.EVENTNAMEERR" | translate }}
                            </div>
                        </div>

                        <!-- Event Description -->
                        <div class="form-group" [class.has-error]="CommentsV.invalid && f.submitted">
                            <label for="comments" class="form-label">
                                <i class="fa fa-align-left"></i>
                                {{ "EVENTCREATION.EVENTDESC" | translate }}
                                <span class="required">*</span>
                            </label>
                            <textarea #CommentsV="ngModel" [(ngModel)]="evenement.comments" class="form-control" id="comments"
                                required name="comments" rows="3" placeholder="Décrivez votre événement..." [disabled]="!canEditEventFields()"></textarea>
                            <div class="error-message" [hidden]="!CommentsV.invalid || !f.submitted">
                                <i class="fa fa-exclamation-triangle"></i>
                                {{ "EVENTCREATION.EVENTDESCERR" | translate }}
                            </div>
                        </div>

                        <!-- Visibility -->
                        <div class="form-group" [class.has-error]="visibility.invalid && f.submitted">
                            <label for="visibility" class="form-label">
                                <i class="fa fa-eye"></i>
                                {{ "EVENTCREATION.VISIBILITY" | translate }}
                                <span class="required">*</span>
                            </label>
                            <select id="visibility" [style.color]="typeColor" #visibility="ngModel"
                                [(ngModel)]="evenement.visibility" name="visibility" class="form-control" required (change)="onVisibilityChange()">
                                <option value="" disabled selected>{{"EVENTCREATION.VISIBILITYPLHD" | translate }}</option>
                                <option value="public">{{"EVENTCREATION.PUBLIC" | translate }}</option>
                                <option value="private">{{"EVENTCREATION.PRIVATE" | translate }}</option>
                                <option value="friends">{{"EVENTCREATION.FRIENDS" | translate }}</option>
                                <option value="friendGroups">{{"EVENTCREATION.FRIEND_GROUPS" | translate }}</option>
                            </select>
                            <div class="error-message" [hidden]="!visibility.invalid || !f.submitted">
                                <i class="fa fa-exclamation-triangle"></i>
                                {{ "EVENTCREATION.VISIBILITYERR" | translate }}
                            </div>
                            
                            <!-- Friend Groups Selection (shown when "friendGroups" is selected) -->
                            <div *ngIf="evenement.visibility === 'friendGroups'" class="mt-3">
                                <label class="form-label">
                                    {{ "EVENTCREATION.SELECT_FRIEND_GROUPS" | translate }}
                                </label>
                                <div class="friend-groups-checkboxes">
                                    <div *ngFor="let group of friendGroups" class="form-check">
                                        <input 
                                            class="form-check-input" 
                                            type="checkbox" 
                                            [id]="'group-' + group.id"
                                            [checked]="isFriendGroupSelected(group.id)"
                                            (change)="toggleFriendGroup(group.id, $event)"
                                        />
                                        <label class="form-check-label" [for]="'group-' + group.id">
                                            {{ group.name }}
                                        </label>
                                    </div>
                                    <div *ngIf="friendGroups.length === 0" class="text-muted">
                                        {{ "EVENTCREATION.NO_FRIEND_GROUPS" | translate }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Text input 
            <div class="form-group row" [class.has-danger]="EvenementName.invalid && f.submitted">
                <label class="col-md-4 col-form-label" for="EvenementStatus">{{ "EVENTCREATION.EVENTSTATUS" | translate }}</label>
                <div class="col-md-6">
                    <input id="EvenementStatus" readonly #EvenementStatus="ngModel" [(ngModel)]="evenement.status" name="EvenementStatus" type="text" placeholder="{{ 'EVENTCREATION.EVENTSTATUSLHD' | translate }}" class="form-control input-md" required>
                    <small class="text-danger" [hidden]="!EvenementStatus.invalid || !f.submitted" type="danger">{{ "EVENTCREATION.EVENTSTATUSERR" | translate }}</small>
                </div>
            </div> -->
                <!-- Event Details Card -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-cogs"></i>
                        <h3>{{ "EVENTHOME.EVENT_DETAILS" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Event Type -->
                            <div class="col-md-6">
                                <div class="form-group" [class.has-error]="typeV.invalid && f.submitted">
                                    <label for="typeV" class="form-label">
                                        <i class="fa fa-list-alt"></i>
                                        {{ "EVENTCREATION.EVENTTYPE" | translate }}
                                        <span class="required">*</span>
                                    </label>
                                    <select id="typeV" [style.color]="typeColor" #typeV="ngModel" [(ngModel)]="evenement.type"
                                        name="type" class="form-control" required (change)="typeChange()">
                                        <option value="" disabled>{{"EVENTCREATION.EVENTTYPEPLHD" | translate }}</option>
                                        <option *ngFor="let type of getSortedEventTypes()" [value]="type.value">
                                            {{ type.label | translate }}
                                        </option>
                                    </select>
                                    <div class="error-message" [hidden]="!typeV.invalid || !f.submitted">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        {{ "EVENTCREATION.EVENTTYPEERR" | translate }}
                                    </div>
                                </div>
                            </div>

                            <!-- Difficulty Level -->
                            <div class="col-md-6">
                                <div class="form-group" [class.has-error]="diffculty.invalid && f.submitted">
                                    <label for="diffculty" class="form-label">
                                        <i class="fa fa-signal"></i>
                                        {{ "EVENTCREATION.DIFF" | translate }}
                                        <span class="required">*</span>
                                    </label>
                                    <select id="diffculty" [style.color]="diffColor" #diffculty="ngModel"
                                        [(ngModel)]="evenement.diffculty" name="diffculty" class="form-control" required
                                        (change)="diffChange()">
                                        <option value="" disabled selected>{{"EVENTCREATION.EVENTDIFFPLHD" | translate }}</option>
                                        <option value="0">{{"EVENTCREATION.DIFF.NA" | translate }}</option>
                                        <option value="1">{{"EVENTCREATION.DIFF.0" | translate }}</option>
                                        <option value="2">{{"EVENTCREATION.DIFF.1" | translate }}</option>
                                        <option value="3">{{"EVENTCREATION.DIFF.2" | translate }}</option>
                                        <option value="4">{{"EVENTCREATION.DIFF.3" | translate }}</option>
                                        <option value="5">{{"EVENTCREATION.DIFF.4" | translate }}</option>
                                    </select>
                                    <div class="error-message" [hidden]="!diffculty.invalid || !f.submitted">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        {{ "EVENTCREATION.DIFFERR" | translate }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Date & Time Card -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-calendar"></i>
                        <h3>{{ "EVENTHOME.DATE_AND_TIME" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Start Date -->
                            <div class="col-md-6">
                                <div class="form-group" [class.has-error]="beginEventDateV.invalid && f.submitted">
                                    <label for="beginEventDateV" class="form-label">
                                        <i class="fa fa-play-circle"></i>
                                        {{ "EVENTCREATION.BEGINEVENTDT" | translate }}
                                        <span class="required">*</span>
                                    </label>
                                    <input type="datetime-local" id="beginEventDate" #beginEventDateV="ngModel" 
                                        [(ngModel)]="beginEventDateString" name="beginEventDate" 
                                        placeholder="{{ 'EVENTCREATION.BEGINEVENTDTPLHD' | translate }}"
                                        class="form-control" required>
                                    <div class="error-message" [hidden]="!beginEventDateV.invalid || !f.submitted">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        {{ "EVENTCREATION.BEGINEVENTDTERR" | translate }}
                                    </div>
                                </div>
                            </div>

                            <!-- End Date -->
                            <div class="col-md-6">
                                <div class="form-group" [class.has-error]="endEventDateV.invalid && f.submitted">
                                    <label for="endEventDateV" class="form-label">
                                        <i class="fa fa-stop-circle"></i>
                                        {{ "EVENTCREATION.ENDEVENTDT" | translate }}
                                        <span class="required">*</span>
                                    </label>
                                    <input type="datetime-local" id="endEventDate" #endEventDateV="ngModel" 
                                        [(ngModel)]="endEventDateString" name="endEventDate" 
                                        placeholder="{{ 'EVENTCREATION.ENDEVENTDTPLHD' | translate }}"
                                        class="form-control" required>
                                    <div class="error-message" [hidden]="!endEventDateV.invalid || !f.submitted">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        {{ "EVENTCREATION.ENDEVENTDTERR" | translate }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- Begin Hour
            <div class="form-group row" [class.has-danger]="startHour.invalid && f.submitted">
                <label class="col-md-4 col-form-label" for="startHour">{{ "EVENTCREATION.STARTHOUR" | translate
                    }}</label>
                <div class="col-md-6">
                    <input id="startHour" #startHour="ngModel" [(ngModel)]="evenement.startHour" name="startHour"
                        placeholder="{{ 'EVENTCREATION.STARTHOURHLP' | translate }}" class="form-control input-md"
                        required>
                    <small class="text-danger" [hidden]="!startHour.invalid || !f.submitted" type="danger"> {{
                        "EVENTCREATION.STARTHOURERR" | translate }} </small>
                </div>
            </div>-->
            <!-- Estimated duration

            <div class="form-group row" [class.has-danger]="duraest.invalid && f.submitted">
                <label class="col-md-4 col-form-label" for="duraest">{{ "EVENTCREATION.DURAEST" | translate }}</label>
                <div class="col-md-6">
                    <input id="duraest" #duraest="ngModel" [(ngModel)]="evenement.durationEstimation" name="duraest"
                        placeholder="{{ 'EVENTCREATION.DURAESTHLP' | translate }}" class="form-control input-md"
                        required>
                    <small class="text-danger" [hidden]="!duraest.invalid || !f.submitted" type="danger"> {{
                        "EVENTCREATION.DURAESTERR" | translate }} </small>
                </div>

            </div>
-->
                <!-- Location & Links Card -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-map-marker"></i>
                        <h3>{{ "EVENTHOME.LOCATION_AND_LINKS" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        <!-- Location -->
                        <div class="form-group" [class.has-error]="startLocation.invalid && f.submitted">
                            <label for="startLocation" class="form-label">
                                <i class="fa fa-map-pin"></i>
                                {{ "EVENTCREATION.STARTLOCATION" | translate }}
                                <span class="required">*</span>
                            </label>
                            <input id="startLocation" #startLocation="ngModel" [(ngModel)]="evenement.startLocation"
                                name="startLocation" placeholder="{{ 'EVENTCREATION.STARTLOCATIONHLP' | translate }}"
                                class="form-control" required>
                            <div class="error-message" [hidden]="!startLocation.invalid || !f.submitted">
                                <i class="fa fa-exclamation-triangle"></i>
                                {{ "EVENTCREATION.STARTLOCATIONERR" | translate }}
                            </div>
                        </div>


                    </div>
                </div>

                <!-- URL Events Section -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-link"></i>
                        <h3>{{ "EVENTHOME.URL_EVENTS" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        
                        <!-- Add New URL Event Form -->
                        <div class="url-event-form mb-4" *ngIf="!isAddingUrlEvent">
                            <button type="button" class="btn btn-outline-primary" (click)="isAddingUrlEvent = true">
                                <i class="fa fa-plus"></i> {{ "EVENTHOME.ADD_URL_EVENT" | translate }}
                            </button>
                        </div>
                        
                        <!-- Add New URL Event Form - Expanded -->
                        <div class="url-event-form mb-4" *ngIf="isAddingUrlEvent">
                            <h5>{{ "EVENTHOME.ADD_URL_EVENT" | translate }}</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fa fa-tag"></i>
                                        {{ "EVENTHOME.TYPE_URL" | translate }}
                                    </label>
                                    <select [(ngModel)]="newUrlEvent.typeUrl" name="typeUrl" class="form-control">
                                        <option value="">{{ "EVENTHOME.TYPE_URL" | translate }}</option>
                                        <option *ngFor="let type of getSortedUrlEventTypes()" [value]="type.id">{{ type.label | translate }}</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fa fa-link"></i>
                                        {{ "EVENTHOME.URL_LINK" | translate }}
                                    </label>
                                    <div class="input-group">
                                        <input [(ngModel)]="newUrlEvent.link" name="link" type="text" 
                                               placeholder="https://example.com" class="form-control form-control-sm"
                                               (input)="onNewLinkInputChange($any($event.target).value)"
                                               (blur)="onNewLinkBlur()">
                                        <button *ngIf="newUrlEvent.typeUrl === 'PHOTOFROMFS'" 
                                                type="button" 
                                                class="btn btn-outline-primary btn-sm" 
                                                (click)="selectDirectory()"
                                                title="Choisir un dossier">
                                            <i class="fa fa-folder-open"></i>
                                        </button>
                                    </div>
                                    <input #directoryInput type="file" webkitdirectory style="display: none;" (change)="onDirectorySelected($event)">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fa fa-user"></i>
                                        {{ "EVENTHOME.URL_OWNER" | translate }}
                                    </label>
                                    <input [(ngModel)]="newUrlEvent.owner" name="owner" type="text" 
                                           class="form-control" readonly>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <label class="form-label">
                                        <i class="fa fa-comment"></i>
                                        {{ "EVENTHOME.URL_DESCRIPTION" | translate }}
                                    </label>
                                    <textarea [(ngModel)]="newUrlEvent.urlDescription" name="urlDescription" 
                                              class="form-control" rows="2" 
                                              placeholder="{{ 'EVENTHOME.LINK_DESCRIPTION_PLACEHOLDER' | translate }}"></textarea>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12 d-flex justify-content-end">
                                    <button type="button" class="btn btn-success btn-sm me-2" (click)="addUrlEvent()">
                                        <i class="fa fa-check"></i> {{ "EVENTHOME.SAVE_URL_EVENT" | translate }}
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" (click)="cancelAddUrlEvent()">
                                        <i class="fa fa-times"></i> {{ "EVENTHOME.CANCEL_URL_EVENT" | translate }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Display Existing URL Events -->
                        <div class="url-events-list" *ngIf="evenement.urlEvents && evenement.urlEvents.length > 0">
                            <h5>{{ "EVENTHOME.URL_EVENTS" | translate }} ({{ evenement.urlEvents.length }})</h5>
                            
                            <!-- Grouped URL Events by Type -->
                            <div *ngFor="let typeUrl of getGroupedUrlEventKeys()" class="url-event-group">
                                <h6 class="url-event-group-title">
                                    <i class="fa fa-tag"></i> {{ getUrlTypeLabel(typeUrl) | translate }}
                                </h6>
                                
                                <div class="url-event-items">
                                    <div class="url-event-item" *ngFor="let urlEvent of getGroupedUrlEvents()[typeUrl]; let i = index">
                                        <div class="url-event-card">
                                            <div class="url-event-content">
                                                <div class="url-event-link">
                                                    <a [href]="urlEvent.link" target="_blank" class="url-link">
                                                        <i class="fa {{ getUrlEventIcon(urlEvent) }}"></i> {{ urlEvent.link }}
                                                    </a>
                                                </div>
                                                <div class="url-event-description" *ngIf="urlEvent.urlDescription">
                                                    {{ urlEvent.urlDescription }}
                                                </div>
                                                <div class="url-event-meta">
                                                    <small class="text-muted">
                                                        <i class="fa fa-user"></i> {{ urlEvent.owner }} | 
                                                        <i class="fa fa-calendar"></i> {{ urlEvent.dateCreation | date:'short' }}
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="url-event-actions">
                                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                                        (click)="removeUrlEvent(evenement.urlEvents.indexOf(urlEvent))"
                                                        title="Supprimer ce lien"
                                                        [disabled]="!canDeleteUrlEvent(urlEvent)">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div *ngIf="!evenement.urlEvents || evenement.urlEvents.length === 0" class="text-center text-muted">
                            <i class="fa fa-link fa-2x mb-2"></i>
                            <p>{{ "EVENTHOME.NO_LINKS_ADDED" | translate }}</p>
                        </div>
                    </div>
                </div>

                <!-- Commentaries Section -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-comments"></i>
                        <h3>{{ "EVENTHOME.COMMENTARIES" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        
                        <!-- Commentary Editor Component -->
                        <app-commentary-editor
                            [commentaries]="evenement.commentaries || []"
                            [currentUser]="user"
                            [eventId]="evenement.id || ''"
                            [eventColor]="getCalculatedColor()"
                            [collapsedByDefault]="true"
                            (commentaryAdded)="onCommentaryAdded($event)"
                            (commentaryUpdated)="onCommentaryUpdated($event)"
                            (commentaryDeleted)="onCommentaryDeleted($event)">
                        </app-commentary-editor>
                        
                        <div *ngIf="!evenement.commentaries || evenement.commentaries.length === 0" class="text-center text-muted">
                            <i class="fa fa-comments fa-2x mb-2"></i>
                            <p>{{ "EVENTHOME.NO_COMMENTARIES_ADDED" | translate }}</p>
                        </div>
                    </div>
                </div>

            <!-- Text input 
            <div class="form-group row" [class.has-danger]="openInscriptionDateV.invalid && f.submitted">
                <label class="col-md-4 col-form-label" for="OpenInscriptionDate">{{ "EVENTCREATION.OPENEVENTINSCRIPTDT" | translate }}</label>
                <div class="col-md-6">
                    <div class="input-group">
                        <input id="OpenInscriptionDate" style="float:none" #openInscriptionDateV="ngModel" [(ngModel)]="openInscriptionDate" name="openInscriptionDate" placeholder="{{ 'EVENTCREATION.OPENEVENTINSCRIPTDTPLHD' | translate }}" class="form-control input-md" required
                            ngx-mydatepicker [options]="myOptions" #dp4="ngx-mydatepicker" (dateChanged)="onDateChanged($event)">
                        <span class="input-group-btn">
                        <button type="button" class="btn btn-primary" (click)="dp4.toggleCalendar()" [ngClass]="{'butgrppat' : openInscriptionDateV.invalid && f.submitted}">
                            <i class="fa fa-calendar" aria-hidden="true"></i>
                        </button>   
                        </span>
                    </div>
                    <small class="text-danger" [hidden]="!openInscriptionDateV.invalid || !f.submitted" type="danger"> {{ "EVENTCREATION.OPENEVENTINSCRIPTDTERR" | translate }}</small>
                </div>
            </div>  -->

            <!-- Text input 
            <div class="form-group row" [class.has-danger]="closeInscriptionDateV.invalid && f.submitted">
                <label class="col-md-4 col-form-label" for="closeInscriptionDate">{{ "EVENTCREATION.CLOSEEVENTINSCRIPTDT" | translate }}</label>
                <div class="col-md-6">
                    <div class="input-group">
                        <input id="closeInscriptionDate" style="float:none" #closeInscriptionDateV="ngModel" [(ngModel)]="closeInscriptionDate" name="closeInscriptionDate" placeholder="{{ 'EVENTCREATION.CLOSEEVENTINSCRIPTDTPLHD' | translate }}" class="form-control input-md"
                            required ngx-mydatepicker [options]="myOptions" #dp3="ngx-mydatepicker" (dateChanged)="onDateChanged($event)">
                        <span class="input-group-btn">
                            <button [class.butgrppat]="closeInscriptionDateV.invalid && f.submitted" type="button" class="btn btn-primary" (click)="dp3.toggleCalendar()">
                               <i class="fa fa-calendar" aria-hidden="true"></i>
                            </button>
                        </span>
                    </div>
                    <small class="text-danger" [hidden]="!closeInscriptionDateV.invalid || !f.submitted" type="danger"> {{ "EVENTCREATION.CLOSEEVENTINSCRIPTDTERR" | translate }}</small>
                </div>
            </div> -->

                <!-- Action Buttons -->
                <div class="form-actions">
                    <div class="button-group">
                        <button id="submitevent" name="submitevent" class="btn btn-primary">
                            <i class="fa fa-save"></i>
                            {{ "EVENTCREATION.SUBMIT" | translate }}
                        </button>
                        <a [routerLink]="['/even']" id="cancelevent" name="cancelevent" class="btn btn-secondary">
                            <i class="fa fa-times"></i>
                            {{ "EVENTCREATION.CANCEL" | translate }}
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>