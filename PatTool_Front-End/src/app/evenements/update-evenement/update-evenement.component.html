<!-- Standard Title Section -->
<div class="pat-title">
    <h2>{{ "EVENTUPDT.TITLE" | translate }}</h2>
    <div class="pat-title-subtitle">Référence : {{evenement.id}}</div>
    <app-navigation-buttons></app-navigation-buttons>
</div>

<!-- Main Content -->
<div class="container mt-0">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <form #f="ngForm" novalidate autocomplete="false" (ngSubmit)=" f.valid && updateEvenement(f.value, f.valid) " class="modern-form">
                
                <!-- Basic Information Card -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-info-circle"></i>
                        <h3>{{ "EVENTHOME.BASIC_INFO" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        
                        <!-- Author (Read-only) -->
                        <div class="form-group">
                            <label for="authorLastName" class="form-label">
                                <i class="fa fa-user"></i>
                                {{ "EVENTCREATION.EVENTAUTHORNAME" | translate }}
                            </label>
                            <input id="authorLastName" readonly [(ngModel)]="author" name="author" type="text"
                                class="form-control" required>
                        </div>

                        <!-- Event Name -->
                        <div class="form-group" [class.has-error]="EvenementName.invalid && f.submitted">
                            <label for="EvenementName" class="form-label">
                                <i class="fa fa-tag"></i>
                                {{ "EVENTCREATION.EVENTNAME" | translate }}
                                <span class="required">*</span>
                            </label>
                            <input id="EvenementName" #EvenementName="ngModel" [(ngModel)]="evenement.evenementName"
                                name="EvenementName" type="text" placeholder="{{ 'EVENTCREATION.EVENTNAMEPLHD' | translate }}"
                                class="form-control" required [disabled]="!canEditEventFields()">
                            <div class="error-message" [hidden]="!EvenementName.invalid || !f.submitted">
                                <i class="fa fa-exclamation-triangle"></i>
                                {{ "EVENTCREATION.EVENTNAMEERR" | translate }}
                            </div>
                        </div>

                        <!-- Event Description -->
                        <div class="form-group" [class.has-error]="CommentsV.invalid && f.submitted">
                            <label for="comments" class="form-label">
                                <i class="fa fa-align-left"></i>
                                {{ "EVENTCREATION.EVENTDESC" | translate }}
                                <span class="required">*</span>
                            </label>
                            <textarea #CommentsV="ngModel" [(ngModel)]="evenement.comments" class="form-control" id="comments"
                                required name="comments" rows="3" placeholder="Décrivez votre événement..." [disabled]="!canEditEventFields()"></textarea>
                            <div class="error-message" [hidden]="!CommentsV.invalid || !f.submitted">
                                <i class="fa fa-exclamation-triangle"></i>
                                {{ "EVENTCREATION.EVENTDESCERR" | translate }}
                            </div>
                        </div>

                        <!-- Visibility -->
                        <div class="form-group" [class.has-error]="visibility.invalid && f.submitted">
                            <label for="visibility" class="form-label">
                                <i class="fa fa-eye"></i>
                                {{ "EVENTCREATION.VISIBILITY" | translate }}
                                <span class="required">*</span>
                            </label>
                            <select id="visibility" [style.color]="typeColor" #visibility="ngModel"
                                [(ngModel)]="evenement.visibility" name="visibility" class="form-control" required [disabled]="!canEditEventFields()">
                                <option value="" disabled selected>{{"EVENTCREATION.VISIBILITYPLHD" | translate }}</option>
                                <option value="public">{{"EVENTCREATION.PUBLIC" | translate }}</option>
                                <option value="private">{{"EVENTCREATION.PRIVATE" | translate }}</option>
                            </select>
                            <div class="error-message" [hidden]="!visibility.invalid || !f.submitted">
                                <i class="fa fa-exclamation-triangle"></i>
                                {{ "EVENTCREATION.VISIBILITYERR" | translate }}
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Text input
            <div class="form-group row" [class.has-danger]="EvenementName.invalid && f.submitted">
                <label class="col-md-4 col-form-label" for="EvenementStatus">{{ "EVENTCREATION.EVENTSTATUS" | translate }}</label>
                <div class="col-md-6">
                    <input id="EvenementStatus" readonly #EvenementStatus="ngModel" [(ngModel)]="evenement.status" name="EvenementStatus" type="text" placeholder="{{ 'EVENTCREATION.EVENTSTATUSLHD' | translate }}" class="form-control input-md" required>
                    <small class="text-danger" [hidden]="!EvenementStatus.invalid || !f.submitted" type="danger">{{ "EVENTCREATION.EVENTSTATUSERR" | translate }}</small>
                </div>
            </div> -->
                <!-- Event Details Card -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-cogs"></i>
                        <h3>{{ "EVENTHOME.EVENT_DETAILS" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Event Type -->
                            <div class="col-md-6">
                                <div class="form-group" [class.has-error]="typeV.invalid && f.submitted">
                                    <label for="typeV" class="form-label">
                                        <i class="fa fa-list-alt"></i>
                                        {{ "EVENTCREATION.EVENTTYPE" | translate }}
                                        <span class="required">*</span>
                                    </label>
                                    <select id="typeV" [style.color]="typeColor" #typeV="ngModel" [(ngModel)]="evenement.type"
                                        name="type" class="form-control" required [disabled]="!canEditEventFields()">
                                        <option value="" disabled selected>{{"EVENTCREATION.EVENTTYPEPLHD" | translate }}</option>
                                        <option value="11">{{"EVENTCREATION.TYPE.DOCUMENTS" | translate }}</option>
                                        <option value="3">{{"EVENTCREATION.TYPE.RUN" | translate }}</option>
                                        <option value="6">{{"EVENTCREATION.TYPE.PARTY" | translate }}</option>
                                        <option value="4">{{"EVENTCREATION.TYPE.WALK" | translate }}</option>
                                        <option value="10">{{"EVENTCREATION.TYPE.PHOTOS" | translate }}</option>
                                        <option value="9">{{"EVENTCREATION.TYPE.RANDO" | translate }}</option>
                                        <option value="2">{{"EVENTCREATION.TYPE.SKI" | translate }}</option>
                                        <option value="7">{{"EVENTCREATION.TYPE.VACATION" | translate }}</option>
                                        <option value="5">{{"EVENTCREATION.TYPE.BIKE" | translate }}</option>
                                        <option value="8">{{"EVENTCREATION.TYPE.TRAVEL" | translate }}</option>
                                        <option value="1">{{"EVENTCREATION.TYPE.VTT" | translate }}</option>
                                    </select>
                                    <div class="error-message" [hidden]="!typeV.invalid || !f.submitted">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        {{ "EVENTCREATION.EVENTTYPEERR" | translate }}
                                    </div>
                                </div>
                            </div>

                            <!-- Difficulty Level -->
                            <div class="col-md-6">
                                <div class="form-group" [class.has-error]="diffculty.invalid && f.submitted">
                                    <label for="diffculty" class="form-label">
                                        <i class="fa fa-signal"></i>
                                        {{ "EVENTCREATION.DIFF" | translate }}
                                        <span class="required">*</span>
                                    </label>
                                    <select id="diffculty" [style.color]="diffColor" #diffculty="ngModel"
                                        [(ngModel)]="evenement.diffculty" name="diffculty" class="form-control" required [disabled]="!canEditEventFields()">
                                        <option value="" disabled selected>{{"EVENTCREATION.EVENTDIFFPLHD" | translate }}</option>
                                        <option value="0">{{"EVENTCREATION.DIFF.NA" | translate }}</option>
                                        <option value="1">{{"EVENTCREATION.DIFF.0" | translate }}</option>
                                        <option value="2">{{"EVENTCREATION.DIFF.1" | translate }}</option>
                                        <option value="3">{{"EVENTCREATION.DIFF.2" | translate }}</option>
                                        <option value="4">{{"EVENTCREATION.DIFF.3" | translate }}</option>
                                        <option value="5">{{"EVENTCREATION.DIFF.4" | translate }}</option>
                                    </select>
                                    <div class="error-message" [hidden]="!diffculty.invalid || !f.submitted">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        {{ "EVENTCREATION.DIFFERR" | translate }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Date & Time Card -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-calendar"></i>
                        <h3>{{ "EVENTHOME.DATE_AND_TIME" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Start Date -->
                            <div class="col-md-6">
                                <div class="form-group" [class.has-error]="beginEventDateV.invalid && f.submitted">
                                    <label for="beginEventDateV" class="form-label">
                                        <i class="fa fa-play-circle"></i>
                                        {{ "EVENTCREATION.BEGINEVENTDT" | translate }}
                                        <span class="required">*</span>
                                    </label>
                                    <input type="datetime-local" id="beginEventDate" #beginEventDateV="ngModel" 
                                        [(ngModel)]="beginEventDateString" name="beginEventDate" 
                                        placeholder="{{ 'EVENTCREATION.BEGINEVENTDTPLHD' | translate }}"
                                        class="form-control" required [disabled]="!canEditEventFields()">
                                    <div class="error-message" [hidden]="!beginEventDateV.invalid || !f.submitted">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        {{ "EVENTCREATION.BEGINEVENTDTERR" | translate }}
                                    </div>
                                </div>
                            </div>

                            <!-- End Date -->
                            <div class="col-md-6">
                                <div class="form-group" [class.has-error]="endEventDateV.invalid && f.submitted">
                                    <label for="endEventDateV" class="form-label">
                                        <i class="fa fa-stop-circle"></i>
                                        {{ "EVENTCREATION.ENDEVENTDT" | translate }}
                                        <span class="required">*</span>
                                    </label>
                                    <input type="datetime-local" id="endEventDateV" #endEventDateV="ngModel" 
                                        [(ngModel)]="endEventDateString" name="endEventDate" 
                                        placeholder="{{ 'EVENTCREATION.ENDEVENTDTPLHD' | translate }}"
                                        class="form-control" required [disabled]="!canEditEventFields()">
                                    <div class="error-message" [hidden]="!endEventDateV.invalid || !f.submitted">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        {{ "EVENTCREATION.ENDEVENTDTERR" | translate }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Begin Hour-->
            <!--
            <div class="form-group row" [class.has-danger]="startHour.invalid && f.submitted">
                <label class="col-md-4 col-form-label" for="startHour">{{ "EVENTCREATION.STARTHOUR" | translate }}</label>
                <div class="col-md-6">
                    <input id="startHour" #startHour="ngModel" [(ngModel)]="evenement.startHour" name="startHour" placeholder="{{ 'EVENTCREATION.STARTHOURHLP' | translate }}" class="form-control input-md" required>
                    <small class="text-danger" [hidden]="!startHour.invalid || !f.submitted" type="danger"> {{ "EVENTCREATION.STARTHOURERR" | translate }}  </small>
                </div>
            </div>
            -->
            <!-- Estimated duration-->
            <!--
            <div class="form-group row" [class.has-danger]="duraest.invalid && f.submitted">
                <label class="col-md-4 col-form-label" for="duraest">{{ "EVENTCREATION.DURAEST" | translate }}</label>
                <div class="col-md-6">
                    <input id="duraest" #duraest="ngModel" [(ngModel)]="evenement.durationEstimation" name="duraest" placeholder="{{ 'EVENTCREATION.DURAESTHLP' | translate }}" class="form-control input-md" required>
                    <small class="text-danger" [hidden]="!duraest.invalid || !f.submitted" type="danger"> {{ "EVENTCREATION.DURAESTERR" | translate }}  </small>
                </div>
            </div>
            -->
                <!-- Location & Links Card -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-map-marker"></i>
                        <h3>{{ "EVENTHOME.LOCATION_AND_LINKS" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        <!-- Location -->
                        <div class="form-group" [class.has-error]="startLocation.invalid && f.submitted">
                            <label for="startLocation" class="form-label">
                                <i class="fa fa-map-pin"></i>
                                {{ "EVENTCREATION.STARTLOCATION" | translate }}
                                <span class="required">*</span>
                            </label>
                            <input id="startLocation" #startLocation="ngModel" [(ngModel)]="evenement.startLocation"
                                name="startLocation" placeholder="{{ 'EVENTCREATION.STARTLOCATIONHLP' | translate }}"
                                class="form-control" required [disabled]="!canEditEventFields()">
                            <div class="error-message" [hidden]="!startLocation.invalid || !f.submitted">
                                <i class="fa fa-exclamation-triangle"></i>
                                {{ "EVENTCREATION.STARTLOCATIONERR" | translate }}
                            </div>
                        </div>


                    </div>
                </div>

                <!-- URL Events Section -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-link"></i>
                        <h3>{{ "EVENTHOME.URL_EVENTS" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        
                        <!-- Add New URL Event Form -->
                        <div class="url-event-form mb-4" *ngIf="!isAddingUrlEvent">
                            <button type="button" class="btn btn-outline-primary" (click)="isAddingUrlEvent = true">
                                <i class="fa fa-plus"></i> {{ "EVENTHOME.ADD_URL_EVENT" | translate }}
                            </button>
                        </div>
                        
                        <!-- Add New URL Event Form - Expanded -->
                        <div class="url-event-form mb-4" *ngIf="isAddingUrlEvent">
                            <h5>{{ "EVENTHOME.ADD_URL_EVENT" | translate }}</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fa fa-tag"></i>
                                        {{ "EVENTHOME.TYPE_URL" | translate }}
                                    </label>
                                    <select [(ngModel)]="newUrlEvent.typeUrl" name="typeUrl" class="form-control form-control-sm">
                                        <option value="">{{ "EVENTHOME.TYPE_URL" | translate }}</option>
                                        <option *ngFor="let type of urlEventTypes" [value]="type.id">{{ type.label | translate }}</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">
                                        <i class="fa fa-link"></i>
                                        {{ "EVENTHOME.URL_LINK" | translate }}
                                    </label>
                                    <input [(ngModel)]="newUrlEvent.link" name="link" type="url" 
                                           placeholder="https://example.com" class="form-control form-control-sm">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fa fa-user"></i>
                                        {{ "EVENTHOME.URL_OWNER" | translate }}
                                    </label>
                                    <input [(ngModel)]="newUrlEvent.owner" name="owner" type="text" 
                                           class="form-control form-control-sm" readonly>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <label class="form-label">
                                        <i class="fa fa-comment"></i>
                                        {{ "EVENTHOME.URL_DESCRIPTION" | translate }}
                                    </label>
                                    <textarea [(ngModel)]="newUrlEvent.urlDescription" name="urlDescription" 
                                              class="form-control form-control-sm" rows="2" 
                                              placeholder="{{ 'EVENTHOME.LINK_DESCRIPTION_PLACEHOLDER' | translate }}"></textarea>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12 d-flex justify-content-end">
                                    <button type="button" class="btn btn-success btn-sm me-2" (click)="addUrlEvent()">
                                        <i class="fa fa-check"></i> {{ "EVENTHOME.SAVE_URL_EVENT" | translate }}
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" (click)="cancelAddUrlEvent()">
                                        <i class="fa fa-times"></i> {{ "EVENTHOME.CANCEL_URL_EVENT" | translate }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Display Existing URL Events -->
                        <div class="url-events-list" *ngIf="evenement.urlEvents && evenement.urlEvents.length > 0">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">{{ "EVENTHOME.URL_EVENTS" | translate }} ({{ evenement.urlEvents.length }})</h5>
                                <button type="button" 
                                        class="btn btn-danger btn-sm"
                                        (click)="confirmDeleteAllLinks()"
                                        [disabled]="!canEditEventFields()"
                                        title="{{ 'EVENTHOME.DELETE_ALL_LINKS' | translate }}">
                                    <i class="fa fa-trash me-1"></i>
                                    {{ "EVENTHOME.DELETE_ALL_LINKS" | translate }}
                                </button>
                            </div>
                            
                            <!-- Grouped URL Events by Type -->
                            <div *ngFor="let typeUrl of getGroupedUrlEventKeys()" class="url-event-group">
                                <h6 class="url-event-group-title">
                                    <i class="fa fa-tag"></i> {{ getUrlTypeLabel(typeUrl) | translate }}
                                </h6>
                                
                                <div class="url-event-items">
                                    <div class="url-event-item" *ngFor="let urlEvent of getGroupedUrlEvents()[typeUrl]; let i = index">
                                        <div class="url-event-card">
                                            <!-- Display Mode -->
                                            <div class="url-event-content" *ngIf="editingIndex !== getActualIndex(urlEvent)">
                                                <div class="url-event-link">
                                                    <a [href]="urlEvent.link" target="_blank" class="btn btn-outline-primary btn-sm url-link-button">
                                                        <i class="fa fa-external-link"></i> {{ urlEvent.link }}
                                                    </a>
                                                </div>
                                                <div class="url-event-description" *ngIf="urlEvent.urlDescription">
                                                    <div class="url-description-box">
                                                        <i class="fa fa-comment"></i> {{ urlEvent.urlDescription }}
                                                    </div>
                                                </div>
                                                <div class="url-event-meta">
                                                    <small class="text-muted">
                                                        <i class="fa fa-tag"></i> {{ getUrlTypeLabel(urlEvent.typeUrl) | translate }} | 
                                                        <i class="fa fa-user"></i> {{ urlEvent.owner }} | 
                                                        <i class="fa fa-calendar"></i> {{ urlEvent.dateCreation | date:'short' }}
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <!-- Edit Mode -->
                                            <div class="url-event-edit-form" *ngIf="editingIndex === getActualIndex(urlEvent)">
                                                <div class="row">
                                                    <div class="col-md-2">
                                                        <label class="form-label">
                                                            <i class="fa fa-tag"></i>
                                                            {{ "EVENTHOME.TYPE_URL" | translate }}
                                                        </label>
                                                        <select [(ngModel)]="editingUrlEvent.typeUrl" name="editTypeUrl" class="form-control form-control-sm">
                                                            <option value="">{{ "EVENTHOME.TYPE_URL" | translate }}</option>
                                                            <option *ngFor="let type of urlEventTypes" [value]="type.id">{{ type.label | translate }}</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label">
                                                            <i class="fa fa-link"></i>
                                                            {{ "EVENTHOME.URL_LINK" | translate }}
                                                        </label>
                                                        <input [(ngModel)]="editingUrlEvent.link" name="editLink" type="url" 
                                                               placeholder="https://example.com" class="form-control form-control-sm">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">
                                                            <i class="fa fa-user"></i>
                                                            {{ "EVENTHOME.URL_OWNER" | translate }}
                                                        </label>
                                                        <input [(ngModel)]="editingUrlEvent.owner" name="editOwner" type="text" 
                                                               class="form-control form-control-sm" readonly>
                                                    </div>
                                                    <div class="col-md-2 d-flex align-items-end justify-content-end">
                                                        <button type="button" class="btn btn-success btn-sm me-1" 
                                                                (click)="saveUrlEventEdit(getActualIndex(urlEvent))" title="Sauvegarder">
                                                            <i class="fa fa-check"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-sm" 
                                                                (click)="cancelUrlEventEdit()" title="Annuler">
                                                            <i class="fa fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-12">
                                                        <label class="form-label">
                                                            <i class="fa fa-comment"></i>
                                                            {{ "EVENTHOME.URL_DESCRIPTION" | translate }}
                                                        </label>
                                                        <textarea [(ngModel)]="editingUrlEvent.urlDescription" name="editDescription"
                                                                  class="form-control form-control-sm" rows="2" 
                                                                  placeholder="{{ 'EVENTHOME.LINK_DESCRIPTION_PLACEHOLDER' | translate }}"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="url-event-actions" *ngIf="editingIndex !== getActualIndex(urlEvent)">
                                                <button type="button" class="btn btn-outline-primary btn-sm me-1" 
                                                        (click)="startEditUrlEvent(getActualIndex(urlEvent))"
                                                        title="Modifier ce lien"
                                                        [disabled]="!canEditUrlEvent(urlEvent)">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                                        (click)="removeUrlEvent(getActualIndex(urlEvent))"
                                                        title="Supprimer ce lien"
                                                        [disabled]="!canDeleteUrlEvent(urlEvent)">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div *ngIf="!evenement.urlEvents || evenement.urlEvents.length === 0" class="text-center text-muted">
                            <i class="fa fa-link fa-2x mb-2"></i>
                            <p>{{ "EVENTHOME.NO_LINKS_ADDED" | translate }}</p>
                        </div>
                    </div>
                </div>

                <!-- Commentaries Section -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-comments"></i>
                        <h3>{{ "EVENTHOME.COMMENTARIES" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        
                        <!-- Add New Commentary Form -->
                        <div class="commentary-form mb-4" *ngIf="!isAddingCommentary">
                            <button type="button" class="btn btn-outline-primary" (click)="isAddingCommentary = true">
                                <i class="fa fa-plus"></i> {{ "EVENTHOME.ADD_COMMENTARY" | translate }}
                            </button>
                        </div>
                        
                        <div class="commentary-form mb-4" *ngIf="isAddingCommentary">
                            <div class="row">
                                <div class="col-12">
                                    <label class="form-label">
                                        <i class="fa fa-comment"></i>
                                        {{ "EVENTHOME.COMMENTARY_TEXT" | translate }}
                                    </label>
                                    <textarea [(ngModel)]="newCommentary.commentary" name="newCommentary" 
                                              class="form-control" rows="3" 
                                              placeholder="{{ 'EVENTHOME.COMMENTARY_PLACEHOLDER' | translate }}"></textarea>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12 d-flex justify-content-end">
                                    <button type="button" class="btn btn-success btn-sm me-2" (click)="addCommentary()">
                                        <i class="fa fa-check"></i> {{ "EVENTHOME.SAVE_COMMENTARY" | translate }}
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" (click)="cancelAddCommentary()">
                                        <i class="fa fa-times"></i> {{ "EVENTHOME.CANCEL_COMMENTARY" | translate }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Display Existing Commentaries -->
                        <div class="commentaries-list" *ngIf="evenement.commentaries && evenement.commentaries.length > 0">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">{{ "EVENTHOME.COMMENTARIES" | translate }} ({{ evenement.commentaries.length }})</h5>
                                <button type="button" 
                                        class="btn btn-danger btn-sm"
                                        (click)="confirmDeleteAllCommentaries()"
                                        [disabled]="!canEditEventFields()"
                                        title="{{ 'EVENTHOME.DELETE_ALL_COMMENTARIES' | translate }}">
                                    <i class="fa fa-trash me-1"></i>
                                    {{ "EVENTHOME.DELETE_ALL_COMMENTARIES" | translate }}
                                </button>
                            </div>
                            
                            <div class="commentary-item" *ngFor="let commentary of evenement.commentaries; let i = index">
                                <div class="commentary-card">
                                    <!-- Display Mode -->
                                    <div class="commentary-content" *ngIf="editingCommentaryIndex !== i">
                                        <div class="commentary-text">
                                            {{ commentary.commentary }}
                                        </div>
                                        <div class="commentary-meta">
                                            <small class="text-muted">
                                                <i class="fa fa-user"></i> {{ commentary.commentOwner }} | 
                                                <i class="fa fa-calendar"></i> {{ formatCommentaryDate(commentary.dateCreation) }}
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- Edit Mode -->
                                    <div class="commentary-edit-form" *ngIf="editingCommentaryIndex === i">
                                        <div class="row">
                                            <div class="col-12">
                                                <label class="form-label">
                                                    <i class="fa fa-comment"></i>
                                                    {{ "EVENTHOME.COMMENTARY_TEXT" | translate }}
                                                </label>
                                                <textarea [(ngModel)]="editingCommentary.commentary" name="editCommentary"
                                                          class="form-control form-control-sm" rows="3" 
                                                          placeholder="{{ 'EVENTHOME.COMMENTARY_PLACEHOLDER' | translate }}"></textarea>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12 d-flex justify-content-end">
                                                <button type="button" class="btn btn-success btn-sm me-1" 
                                                        (click)="saveCommentaryEdit(i)" title="Sauvegarder">
                                                    <i class="fa fa-check"></i>
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-sm" 
                                                        (click)="cancelCommentaryEdit()" title="Annuler">
                                                    <i class="fa fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="commentary-actions" *ngIf="editingCommentaryIndex !== i">
                                        <button type="button" class="btn btn-outline-primary btn-sm me-1" 
                                                (click)="startEditCommentary(i)"
                                                title="Modifier ce commentaire"
                                                [disabled]="!canEditCommentary(commentary)">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                (click)="deleteCommentary(i)"
                                                title="Supprimer ce commentaire"
                                                [disabled]="!canDeleteCommentary(commentary)">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div *ngIf="!evenement.commentaries || evenement.commentaries.length === 0" class="text-center text-muted">
                            <i class="fa fa-comments fa-2x mb-2"></i>
                            <p>{{ "EVENTHOME.NO_COMMENTARIES_ADDED" | translate }}</p>
                        </div>
                    </div>
                </div>

                <!-- Documents Management Card -->
                <div class="form-card">
                    <div class="card-header">
                        <i class="fa fa-file"></i>
                        <h3>{{ "EVENTELEM.FILES" | translate }}</h3>
                    </div>
                    <div class="card-body">
                        
                        <!-- File Upload Section -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fa fa-upload"></i>
                                {{ "EVENTELEM.UPLOAD" | translate }}
                            </label>
                            
                            <!-- Drag & Drop Zone -->
                            <div class="file-upload-zone" 
                                 [class.drag-over]="isDragOver"
                                 (dragover)="onDragOver($event)"
                                 (dragleave)="onDragLeave($event)"
                                 (drop)="onDrop($event)">
                                <div class="upload-content">
                                    <i class="fa fa-cloud-upload fa-3x text-primary mb-3"></i>
                                    <h5>{{ "EVENTELEM.DRAG_DROP_FILES" | translate }}</h5>
                                    <p class="text-muted">{{ "EVENTELEM.OR_CLICK_TO_SELECT" | translate }}</p>
                                    
                                    <!-- File Input -->
                                    <div class="file-input-wrapper">
                                        <input type="file" 
                                               id="fileInput"
                                               class="form-control" 
                                               multiple 
                                               accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar"
                                               (change)="onFileSelected($event)">
                                        <label for="fileInput" class="btn btn-primary">
                                            <i class="fa fa-upload me-2"></i>
                                            {{ "EVENTELEM.SELECT_FILES" | translate }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Selected Files Preview -->
                            <div class="selected-files-preview" *ngIf="selectedFiles.length > 0">
                                <h6 class="mt-3 mb-2">
                                    <i class="fa fa-files-o"></i>
                                    {{ "EVENTELEM.SELECTED_FILES" | translate }} ({{ selectedFiles.length }})
                                </h6>
                                <div class="selected-files-list">
                                    <div class="file-preview-item" *ngFor="let file of selectedFiles; let i = index">
                                        <div class="file-info">
                                            <i class="fa" 
                                               [class.fa-file-image-o]="isImageFile(file.name)"
                                               [class.fa-file-pdf-o]="isPdfFile(file.name)"
                                               [class.fa-file-o]="!isImageFile(file.name) && !isPdfFile(file.name)"></i>
                                            <span class="file-name">{{ file.name }}</span>
                                            <small class="file-size">({{ formatFileSize(file.size) }})</small>
                                        </div>
                                        <div class="file-actions">
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger"
                                                    (click)="removeSelectedFile(i)"
                                                    title="{{ 'EVENTELEM.REMOVE_FILE' | translate }}">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Upload Button -->
                                <div class="upload-actions mt-3">
                                    <button type="button" 
                                            class="btn btn-success"
                                            (click)="uploadSelectedFiles()"
                                            [disabled]="isUploading">
                                        <i class="fa fa-upload me-2" *ngIf="!isUploading"></i>
                                        <i class="fa fa-spinner fa-spin me-2" *ngIf="isUploading"></i>
                                        {{ isUploading ? ('EVENTELEM.UPLOADING' | translate) : ('EVENTELEM.UPLOAD_FILES' | translate) }}
                                    </button>
                                    <button type="button" 
                                            class="btn btn-secondary ms-2"
                                            (click)="clearSelectedFiles()"
                                            [disabled]="isUploading">
                                        <i class="fa fa-times me-2"></i>
                                        {{ "EVENTELEM.CLEAR_ALL" | translate }}
                                    </button>
                                </div>
                            </div>
                            
                            <small class="form-text text-muted">
                                <i class="fa fa-info-circle"></i>
                                {{ "EVENTELEM.ACCEPTED_FORMATS" | translate }}
                            </small>
                        </div>

                        <!-- Files List -->
                        <div class="files-list" *ngIf="evenement.fileUploadeds && evenement.fileUploadeds.length > 0">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">{{ "EVENTELEM.FILES" | translate }} ({{ evenement.fileUploadeds.length }})</h5>
                                <button type="button" 
                                        class="btn btn-danger btn-sm"
                                        (click)="confirmDeleteAllFiles()"
                                        [disabled]="!canEditEventFields()"
                                        title="{{ 'EVENTELEM.DELETE_ALL_FILES' | translate }}">
                                    <i class="fa fa-trash me-1"></i>
                                    {{ "EVENTELEM.DELETE_ALL_FILES" | translate }}
                                </button>
                            </div>
                            <div class="list-group">
                                <div class="list-group-item d-flex justify-content-between align-items-center" 
                                     *ngFor="let uploadedFile of evenement.fileUploadeds; let i = index">
                                    
                                    <!-- File Info -->
                                    <div class="file-info d-flex align-items-center">
                                        <span class="badge me-2" 
                                              [class.bg-secondary]="!isImageFile(uploadedFile.fileName) && !isPdfFile(uploadedFile.fileName)"
                                              [class.bg-info]="isImageFile(uploadedFile.fileName)"
                                              [class.bg-danger]="isPdfFile(uploadedFile.fileName)"
                                              [title]="uploadedFile.fileName"
                                              ngbTooltip="{{uploadedFile.fileName}}" placement="top">
                                            {{uploadedFile.fileName}}
                                        </span>
                                        <small class="text-muted clickable-user" 
                                               (click)="openUserModal(uploadedFile.uploaderMember)"
                                               title="Cliquer pour voir les détails de l'utilisateur">
                                            {{uploadedFile.uploaderMember.userName}}
                                        </small>
                                    </div>

                                    <!-- File Actions -->
                                    <div class="file-actions d-flex gap-2">
                                        <!-- View/Open Button -->
                                        <button type="button" 
                                                class="btn btn-outline-primary btn-sm"
                                                *ngIf="isImageFile(uploadedFile.fileName) || isPdfFile(uploadedFile.fileName)"
                                                (click)="isImageFile(uploadedFile.fileName) ? openFileImageModal(uploadedFile.fieldId, uploadedFile.fileName) : openPdfFile(uploadedFile.fieldId, uploadedFile.fileName)"
                                                [title]="isImageFile(uploadedFile.fileName) ? ('EVENTELEM.CLICK_TO_VIEW' | translate) : ('EVENTELEM.CLICK_TO_OPEN_PDF' | translate)">
                                            <i class="fa fa-eye"></i>
                                        </button>

                                        <!-- Download Button -->
                                        <button type="button" 
                                                class="btn btn-outline-success btn-sm"
                                                (click)="isImageFile(uploadedFile.fileName) ? openFileImageModal(uploadedFile.fieldId, uploadedFile.fileName) : openPdfFile(uploadedFile.fieldId, uploadedFile.fileName)"
                                                title="{{ 'EVENTELEM.FILESDOWNLOAD' | translate }}">
                                            <i class="fa fa-download"></i>
                                        </button>

                                        <!-- Delete Button -->
                                        <button type="button" 
                                                class="btn btn-outline-danger btn-sm"
                                                (click)="deleteFile(i)"
                                                [disabled]="!isFileOwner(uploadedFile)"
                                                title="{{ 'EVENTELEM.DELETE_FILE' | translate }}">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- No Files Message -->
                        <div class="text-muted text-center py-3" *ngIf="!evenement.fileUploadeds || evenement.fileUploadeds.length === 0">
                            <i class="fa fa-file-o fa-2x mb-2"></i>
                            <p>{{ "EVENTELEM.NO_FILES_CHOSEN" | translate }}</p>
                        </div>

                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <div class="button-group">
                        <button id="submitevent" name="submitevent" class="btn btn-primary btn-lg">
                            <i class="fa fa-save"></i>
                            {{ "EVENTUPDT.SUBMIT" | translate }}
                        </button>
                        <a [routerLink]="['/even']" id="cancelevent" name="cancelevent" class="btn btn-secondary btn-lg">
                            <i class="fa fa-times"></i>
                            {{ "EVENTCREATION.CANCEL" | translate }}
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Image Modal -->
    <ng-template #imageModal let-modal>
        <div class="modal-header">
            <h4 class="modal-title">{{ selectedImageAlt }}</h4>
            <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body text-center">
            <img [src]="selectedImageUrl" [alt]="selectedImageAlt" class="modal-image">
        </div>
    </ng-template>

    <!-- User Details Modal -->
    <ng-template #userModal let-modal>
        <div class="modal-header">
            <h5 class="modal-title">
                <i class="fa fa-user me-2"></i>
                Détails de l'utilisateur
            </h5>
            <button type="button" class="btn-close" (click)="modal.dismiss('Cross click')" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body" *ngIf="selectedUser">
            <div class="user-details">
                <div class="detail-row">
                    <strong>Prénom :</strong>
                    <span>{{ selectedUser.firstName }}</span>
                </div>
                <div class="detail-row">
                    <strong>Nom :</strong>
                    <span>{{ selectedUser.lastName }}</span>
                </div>
                <div class="detail-row">
                    <strong>Nom d'utilisateur :</strong>
                    <span>{{ selectedUser.userName }}</span>
                </div>
                <div class="detail-row">
                    <strong>Email :</strong>
                    <span>{{ selectedUser.addressEmail }}</span>
                </div>
                <div class="detail-row">
                    <strong>ID :</strong>
                    <span>{{ selectedUser.id }}</span>
                </div>
                <div class="detail-row">
                    <strong>Keycloak ID :</strong>
                    <span>{{ selectedUser.keycloakId }}</span>
                </div>
                <div class="detail-row">
                    <strong>Rôles :</strong>
                    <span>{{ selectedUser.roles.join(', ') }}</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Close click')">
                Fermer
            </button>
        </div>
    </ng-template>

    <!-- Confirmation Modal for Delete All Files -->
    <ng-template #confirmDeleteAllModal let-modal>
        <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
                <i class="fa fa-exclamation-triangle me-2"></i>
                {{ "EVENTELEM.DELETE_ALL_FILES_CONFIRM_TITLE" | translate }}
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('Cross click')" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <p class="text-danger">
                <i class="fa fa-warning me-2"></i>
                {{ "EVENTELEM.DELETE_ALL_FILES_CONFIRM_MESSAGE" | translate }}
            </p>
            <p class="text-muted">
                {{ evenement.fileUploadeds.length || 0 }} {{ "EVENTELEM.DELETE_ALL_FILES_COUNT" | translate }}
            </p>
            <p class="text-warning">
                <i class="fa fa-info-circle me-2"></i>
                {{ "EVENTELEM.DELETE_ALL_FILES_IRREVERSIBLE" | translate }}
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">
                <i class="fa fa-times me-1"></i>
                {{ "EVENTELEM.DELETE_ALL_FILES_CANCEL" | translate }}
            </button>
            <button type="button" class="btn btn-danger" (click)="deleteAllFiles(); modal.close('Delete confirmed')">
                <i class="fa fa-trash me-1"></i>
                {{ "EVENTELEM.DELETE_ALL_FILES_CONFIRM" | translate }}
            </button>
        </div>
    </ng-template>

    <!-- Confirmation Modal for Delete All Links -->
    <ng-template #confirmDeleteAllLinksModal let-modal>
        <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
                <i class="fa fa-exclamation-triangle me-2"></i>
                {{ "EVENTHOME.DELETE_ALL_LINKS_CONFIRM_TITLE" | translate }}
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('Cross click')" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <p class="text-danger">
                <i class="fa fa-warning me-2"></i>
                {{ "EVENTHOME.DELETE_ALL_LINKS_CONFIRM_MESSAGE" | translate }}
            </p>
            <p class="text-muted">
                {{ evenement.urlEvents.length || 0 }} {{ "EVENTHOME.DELETE_ALL_LINKS_COUNT" | translate }}
            </p>
            <p class="text-warning">
                <i class="fa fa-info-circle me-2"></i>
                {{ "EVENTHOME.DELETE_ALL_LINKS_IRREVERSIBLE" | translate }}
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">
                <i class="fa fa-times me-1"></i>
                {{ "EVENTHOME.DELETE_ALL_LINKS_CANCEL" | translate }}
            </button>
            <button type="button" class="btn btn-danger" (click)="deleteAllLinks(); modal.close('Delete confirmed')">
                <i class="fa fa-trash me-1"></i>
                {{ "EVENTHOME.DELETE_ALL_LINKS_CONFIRM" | translate }}
            </button>
        </div>
    </ng-template>

    <!-- Confirmation Modal for Delete All Commentaries -->
    <ng-template #confirmDeleteAllCommentariesModal let-modal>
        <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
                <i class="fa fa-exclamation-triangle me-2"></i>
                {{ "EVENTHOME.DELETE_ALL_COMMENTARIES_CONFIRM_TITLE" | translate }}
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('Cross click')" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <p class="text-danger">
                <i class="fa fa-warning me-2"></i>
                {{ "EVENTHOME.DELETE_ALL_COMMENTARIES_CONFIRM_MESSAGE" | translate }}
            </p>
            <p class="text-muted">
                 {{ evenement.commentaries.length || 0 }} {{ "EVENTHOME.DELETE_ALL_COMMENTARIES_COUNT" | translate }}
            </p>
            <p class="text-warning">
                <i class="fa fa-info-circle me-2"></i>
                {{ "EVENTHOME.DELETE_ALL_COMMENTARIES_IRREVERSIBLE" | translate }}
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">
                <i class="fa fa-times me-1"></i>
                {{ "EVENTHOME.DELETE_ALL_COMMENTARIES_CANCEL" | translate }}
            </button>
            <button type="button" class="btn btn-danger" (click)="deleteAllCommentaries(); modal.close('Delete confirmed')">
                <i class="fa fa-trash me-1"></i>
                {{ "EVENTHOME.DELETE_ALL_COMMENTARIES_CONFIRM" | translate }}
            </button>
        </div>
    </ng-template>