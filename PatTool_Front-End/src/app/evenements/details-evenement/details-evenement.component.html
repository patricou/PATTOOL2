<!-- Loading Spinner -->
<div *ngIf="loading" class="loading-container">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Chargement...</span>
  </div>
  <p class="mt-3 text-muted">{{ 'COMMUN.LOADING' | translate }}</p>
</div>

<!-- Error Message -->
<div *ngIf="error && !loading" class="error-container">
  <div class="alert alert-danger" role="alert">
    <i class="fa fa-exclamation-triangle me-2"></i>
    {{ error }}
  </div>
  <button class="btn btn-primary" (click)="goBack()">
    <i class="fa fa-arrow-left me-2"></i>
    {{ 'COMMUN.BACK' | translate }}
  </button>
</div>

<!-- Slideshow Modal Component (always available) -->
<app-slideshow-modal #slideshowModalComponent (closed)="onSlideshowClosed()"></app-slideshow-modal>

<!-- Artistic Event Details Page -->
<div *ngIf="evenement && !loading && !error" class="artistic-event-page">
  
  <!-- Navigation Buttons - Below menu on the left -->
  <app-navigation-buttons></app-navigation-buttons>
  
  <!-- Background Image Layer -->
  <div class="background-image-layer" [style.background-image]="getMainBackgroundImage()"></div>
  
  <!-- Blur Overlay Layer -->
  <div class="blur-overlay-layer"></div>
  
  <!-- Content Layer -->
  <div class="content-layer">
    
    <!-- Header Section -->
    <header class="artistic-header">
      <div class="header-content">
        <h1 class="event-title">{{ evenement.evenementName }}</h1>
        <div class="event-meta">
          <span class="meta-item">
            <i class="fa fa-calendar"></i>
            <span *ngIf="evenement.beginEventDate">
              {{ 'COMMUN.FROM' | translate }} {{ formatEventDateTime(evenement.beginEventDate, evenement.startHour) }}
            </span>
            <span *ngIf="evenement.endEventDate && evenement.endEventDate !== evenement.beginEventDate">
              {{ 'COMMUN.TO' | translate }} {{ formatEventDateTime(evenement.endEventDate, '') }}
            </span>
            <span *ngIf="evenement.endEventDate && evenement.endEventDate === evenement.beginEventDate && evenement.startHour">
              {{ formatEventDateTime(evenement.beginEventDate, evenement.startHour) }}
            </span>
          </span>
          <span class="meta-item">
            <i class="fa fa-user"></i>
            {{ evenement.author.firstName }} {{ evenement.author.lastName }}
          </span>
        </div>
      </div>
    </header>

    <!-- Main Content Container - Dynamic Grid -->
    <div class="dynamic-grid-container">

      <!-- Description Card - Small Horizontal -->
      <div class="dynamic-card card-small card-horizontal" *ngIf="evenement.comments">
        <div class="card-icon"><i class="fa fa-quote-left"></i></div>
        <div class="card-content">
          <h3 class="card-title-small">Description</h3>
          <p class="card-text-small">{{ evenement.comments }}</p>
        </div>
      </div>

      <!-- Visibility Card - Small Vertical -->
      <div class="dynamic-card card-small card-vertical">
        <div class="card-icon"><i class="fa fa-eye"></i></div>
        <div class="card-content">
          <h3 class="card-title-small">{{ 'EVENTCREATION.VISIBILITY' | translate }}</h3>
          <span class="visibility-badge-compact" [ngSwitch]="evenement.visibility">
            <span *ngSwitchCase="'public'" class="badge-compact badge-public-compact">
              <i class="fa fa-globe"></i> {{ 'EVENTCREATION.PUBLIC' | translate }}
            </span>
            <span *ngSwitchCase="'private'" class="badge-compact badge-private-compact">
              <i class="fa fa-lock"></i> {{ 'EVENTCREATION.PRIVATE' | translate }}
            </span>
            <span *ngSwitchCase="'friends'" class="badge-compact badge-friends-compact">
              <i class="fa fa-users"></i> {{ 'EVENTCREATION.FRIENDS' | translate }}
            </span>
            <span *ngSwitchDefault class="badge-compact badge-group-compact">
              <i class="fa fa-group"></i> {{ evenement.visibility }}
            </span>
          </span>
          <button class="btn-compact btn-whatsapp-compact" 
                  *ngIf="hasFriendGroupWhatsAppLink()" 
                  (click)="openFriendGroupWhatsAppLink()"
                  title="{{ 'FRIENDS.OPEN_WHATSAPP' | translate }}">
            <i class="fa fa-whatsapp"></i> {{ 'FRIENDS.OPEN_WHATSAPP' | translate }}
          </button>
          
          <!-- Friend Group Members (when visibility is a friend group and friend group is loaded) -->
          <ng-container *ngIf="evenement.friendGroupId && getCurrentFriendGroup() && getCurrentFriendGroup()!.members && getCurrentFriendGroup()!.members.length > 0">
            <div class="members-compact">
              <small class="members-count">
                {{ getCurrentFriendGroup()!.members.length }} {{ 'EVENTELEM.MEMBERS' | translate }} 
                <span *ngIf="getCurrentFriendGroup()!.name">({{ getCurrentFriendGroup()!.name }})</span>
              </small>
              <div class="members-tags-compact">
                <span class="member-tag-compact" *ngFor="let member of getFirstFriendGroupMembers()">
                  {{ member.firstName }} {{ member.lastName }}
                </span>
                <span class="member-tag-compact" *ngIf="getRemainingFriendGroupMembersCount() > 0">+{{ getRemainingFriendGroupMembersCount() }}</span>
              </div>
            </div>
          </ng-container>
          
          <!-- Event Members (always show if they exist and friend group members are not shown) -->
          <ng-container *ngIf="hasEventMembers() && (!evenement.friendGroupId || !getCurrentFriendGroup() || !getCurrentFriendGroup()?.members || getCurrentFriendGroup()!.members.length === 0)">
            <div class="members-compact">
              <small class="members-count">{{ evenement.members.length }} {{ 'EVENTELEM.MEMBERS' | translate }}</small>
              <div class="members-tags-compact">
                <span class="member-tag-compact" *ngFor="let member of getFirstMembers()">
                  {{ member.firstName }} {{ member.lastName }}
                </span>
                <span class="member-tag-compact" *ngIf="getRemainingMembersCount() > 0">+{{ getRemainingMembersCount() }}</span>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Event Info Card - Small Horizontal -->
      <div class="dynamic-card card-small card-horizontal">
        <div class="card-icon"><i class="fa fa-info-circle"></i></div>
        <div class="card-content">
          <h3 class="card-title-small">{{ 'EVENTELEM.TYPE' | translate }}</h3>
          <div class="info-list-compact">
            <div class="info-item-compact">
              <span class="info-label">{{ 'EVENTELEM.TYPE' | translate }}:</span>
              <span class="info-value">{{ getEventTypeLabel(evenement.type) | translate }}</span>
            </div>
            <div class="info-item-compact" *ngIf="evenement.status">
              <span class="info-label">{{ 'EVENTELEM.STATUS' | translate }}:</span>
              <span class="status-badge-compact" [ngSwitch]="evenement.status">
                <span *ngSwitchCase="'Open'" class="badge-compact badge-status-open">{{ 'COMMUN.STATUSOPEN' | translate }}</span>
                <span *ngSwitchCase="'Closed'" class="badge-compact badge-status-closed">{{ 'COMMUN.STATUSCLOSE' | translate }}</span>
                <span *ngSwitchCase="'Cancel'" class="badge-compact badge-status-cancel">{{ 'COMMUN.STATUSCANCEL' | translate }}</span>
              </span>
            </div>
            <div class="info-item-compact" *ngIf="evenement.diffculty">
              <span class="info-label">{{ 'EVENTELEM.DIFF' | translate }}:</span>
              <span class="info-value">{{ getDifficultyLabel(evenement.diffculty) | translate }}</span>
            </div>
            <div class="info-item-compact" *ngIf="evenement.startLocation">
              <span class="info-label">{{ 'EVENTELEM.STARTLOCATION' | translate }}:</span>
              <span class="info-value">{{ evenement.startLocation }}</span>
            </div>
            <div class="info-item-compact" *ngIf="evenement.durationEstimation">
              <span class="info-label">Duration:</span>
              <span class="info-value">{{ evenement.durationEstimation }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Rating Card - Small Vertical -->
      <div class="dynamic-card card-small card-vertical">
        <div class="card-icon"><i class="fa fa-star"></i></div>
        <div class="card-content">
          <h3 class="card-title-small">{{ 'COMMUN.RATINGS' | translate }}</h3>
          <div class="rating-compact">
            <button type="button" 
                    class="rating-badge-compact rating-plus btn-rating" 
                    (click)="addRatePlus()"
                    [ngbTooltip]="'COMMUN.ILIKE' | translate"
                    placement="top">
              <i class="fa fa-thumbs-up"></i> {{ evenement.ratingPlus || 0 }}
            </button>
            <button type="button" 
                    class="rating-badge-compact rating-minus btn-rating" 
                    (click)="addRateMinus()"
                    [ngbTooltip]="'COMMUN.IDONTLIKE' | translate"
                    placement="top">
              <i class="fa fa-thumbs-down"></i> {{ evenement.ratingMinus || 0 }}
            </button>
          </div>
        </div>
      </div>

      <!-- Discussion Card - Large Vertical -->
      <div class="dynamic-card card-large card-vertical discussion-card" *ngIf="hasDiscussion()">
        <div class="card-header-compact">
          <i class="fa fa-comments"></i>
          <span>Discussion</span>
          <button type="button" class="btn-compact btn-primary-compact ms-auto" (click)="openDiscussion(); $event.stopPropagation()" title="Open full discussion">
            <i class="fa fa-external-link"></i>
          </button>
        </div>
        
        <!-- Loading State -->
        <div *ngIf="isLoadingDiscussion" class="discussion-loading-compact">
          <i class="fa fa-spinner fa-spin"></i>
          <span>Loading messages...</span>
        </div>
        
        <!-- Error State -->
        <div *ngIf="discussionError && !isLoadingDiscussion" class="discussion-error-compact">
          <i class="fa fa-exclamation-triangle"></i>
          <span>{{ discussionError }}</span>
        </div>
        
        <!-- Messages List -->
        <div #discussionMessagesContainer *ngIf="!isLoadingDiscussion && !discussionError" class="discussion-messages-compact">
          <div *ngIf="discussionMessages.length === 0" class="discussion-empty-compact">
            <i class="fa fa-comments"></i>
            <p>No messages yet</p>
          </div>
          
          <div *ngIf="discussionMessages.length > 0" class="discussion-messages-list-compact">
            <div class="discussion-message-compact" *ngFor="let message of discussionMessages">
              <div class="message-header-compact">
                <div class="message-author-compact">
                  <i class="fa fa-user-circle"></i>
                  <strong>{{ message.author?.firstName }} {{ message.author?.lastName }}</strong>
                  <span class="message-username-compact">{{ '@' + message.author?.userName }}</span>
                </div>
                <div class="message-date-compact">{{ formatDiscussionDate(message.dateTime) }}</div>
              </div>
              
              <div class="message-content-compact">
                <p class="message-text-compact" *ngIf="message.message">{{ message.message }}</p>
                
                <!-- Message Image -->
                <div class="message-image-compact" *ngIf="message.imageUrl">
                  <img *ngIf="hasDiscussionFileUrl(message.imageFileName || '', 'images', message.imageUrl)"
                       [src]="getDiscussionFileUrl(message.imageFileName || '', 'images', message.imageUrl)" 
                       [alt]="message.imageFileName || 'Image'"
                       class="discussion-image-compact"
                       (error)="onImageError($event)"
                       (click)="openImageInModal(getDiscussionFileUrl(message.imageFileName || '', 'images', message.imageUrl))">
                  <div *ngIf="!hasDiscussionFileUrl(message.imageFileName || '', 'images', message.imageUrl)" class="discussion-message-loading">
                    <i class="fa fa-spinner fa-spin"></i> Chargement de l'image...
                  </div>
                </div>
                
                <!-- Message Video -->
                <div class="message-video-compact" *ngIf="message.videoUrl">
                  <video *ngIf="hasDiscussionFileUrl(message.videoFileName || '', 'videos', message.videoUrl)"
                         [src]="getDiscussionFileUrl(message.videoFileName || '', 'videos', message.videoUrl)" 
                         controls
                         class="discussion-video-compact">
                    Your browser does not support the video tag.
                  </video>
                  <div *ngIf="!hasDiscussionFileUrl(message.videoFileName || '', 'videos', message.videoUrl)" class="discussion-message-loading">
                    <i class="fa fa-spinner fa-spin"></i> Chargement de la vidéo...
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Photo Gallery - Large Horizontal -->
      <div class="dynamic-card card-large card-horizontal photos-card" *ngIf="photoItemsList.length > 0">
        <div class="card-header-compact">
          <i class="fa fa-camera"></i>
          <span>Photos ({{ photoItemsList.length }})</span>
          <button type="button" class="btn-compact btn-primary-compact ms-auto" (click)="openPhotosMaximized(); $event.stopPropagation()" title="Maximiser">
            <i class="fa fa-external-link"></i>
          </button>
        </div>
        <div class="photo-gallery">
          <div class="photo-viewer">
            <div class="photo-slider" [style.transform]="'translateX(-' + (currentPhotoIndex * 100) + '%)'">
              <div class="photo-frame" *ngFor="let photoItem of photoItemsList">
                <img [src]="photoItem.imageUrl" 
                     [alt]="photoItem.file.fileName" 
                     class="photo-img"
                     (click)="openSingleImageInSlideshow(photoItem.file.fieldId, photoItem.file.fileName)"
                     (load)="onImageLoad($event)"
                     (error)="onImageError($event)">
              </div>
            </div>
          </div>
          <button class="photo-nav prev" (click)="prevPhoto()" *ngIf="photoItemsList.length > 1">
            <i class="fa fa-chevron-left"></i>
          </button>
          <button class="photo-nav next" (click)="nextPhoto()" *ngIf="photoItemsList.length > 1">
            <i class="fa fa-chevron-right"></i>
          </button>
          <div class="photo-indicators" *ngIf="photoItemsList.length > 1">
            <span *ngFor="let photoItem of photoItemsList; let i = index" 
                  class="photo-indicator" 
                  [class.active]="i === currentPhotoIndex"
                  (click)="goToPhoto(i)">
            </span>
          </div>
        </div>
      </div>

      <!-- Comments - Medium Vertical -->
      <div class="dynamic-card card-medium card-vertical comments-card" *ngIf="getEventComments().length > 0">
        <div class="card-header-compact">
          <i class="fa fa-comments"></i>
          <span>{{ 'EVENTHOME.COMMENTARIES' | translate }} ({{ getEventComments().length }})</span>
        </div>
        <div class="comments-list-compact">
          <div class="comment-item-compact" *ngFor="let comment of getEventComments()">
            <div class="comment-author-compact">{{ comment.commentOwner }}</div>
            <div class="comment-date-compact">{{ formatCommentaryDate(comment.dateCreation) }}</div>
            <div class="comment-text-compact">{{ comment.commentary }}</div>
          </div>
        </div>
      </div>

      <!-- URLs - Medium Vertical -->
      <div class="dynamic-card card-medium card-vertical urls-card" *ngIf="evenement.urlEvents && evenement.urlEvents.length > 0">
        <div class="card-header-compact">
          <i class="fa fa-link"></i>
          <span>{{ 'EVENTELEM.URLS' | translate }} ({{ evenement.urlEvents.length }})</span>
        </div>
        <div class="urls-list-compact">
          <div *ngFor="let typeKey of getSortedTypeKeys()" class="url-type-compact">
            <div class="url-type-header-compact">
              <i class="fa {{ getUrlTypeIcon(typeKey) }}"></i>
              {{ getUrlTypeLabel(typeKey) | translate }} ({{ getGroupedUrlEvents()[typeKey].length }})
            </div>
            <div class="url-items-compact">
              <div class="url-item-compact" *ngFor="let urlEvent of getGroupedUrlEvents()[typeKey]">
                <div class="url-link-compact" *ngIf="urlEvent.link">
                  <a [href]="urlEvent.link" target="_blank" class="url-link-text">
                    <i class="fa {{ getUrlEventIcon(urlEvent) }}"></i>
                    {{ urlEvent.urlDescription || getWebsiteTitle(urlEvent.link) }}
                  </a>
                  <small class="url-meta-compact">{{ urlEvent.owner }} • {{ formatCommentaryDate(urlEvent.dateCreation) }}</small>
                </div>
                <button class="btn-compact btn-fs-compact" *ngIf="urlEvent.typeUrl && (urlEvent.typeUrl.toUpperCase().trim() === 'PHOTOFROMFS')" (click)="openFsPhotosDiaporama(urlEvent.link)">
                  <i class="fa fa-picture-o"></i> {{ 'EVENTELEM.SLIDESHOW' | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PDFs - Small Vertical -->
      <div class="dynamic-card card-small card-vertical pdfs-card" *ngIf="getPdfFiles().length > 0">
        <div class="card-header-compact">
          <i class="fa fa-file-pdf-o"></i>
          <span>{{ 'EVENTELEM.PDF_DOCUMENTS' | translate }} ({{ getPdfFiles().length }})</span>
        </div>
        <div class="pdfs-list-compact">
          <div class="pdf-item-compact" *ngFor="let pdfFile of getPdfFiles()">
            <div class="pdf-name-compact">{{ pdfFile.fileName }}</div>
            <div class="pdf-actions-compact">
              <button class="btn-compact btn-primary-compact" (click)="openPdfInPage(pdfFile)" title="{{ 'EVENTELEM.OPEN_PDF' | translate }}">
                <i class="fa fa-eye"></i>
              </button>
              <button class="btn-compact btn-secondary-compact" (click)="downloadPdf(pdfFile)" title="{{ 'EVENTELEM.DOWNLOAD_PDF' | translate }}">
                <i class="fa fa-download"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Video Cards - One card per video -->
      <div class="dynamic-card card-medium card-vertical video-card" *ngFor="let videoFile of getVideoFiles(); let i = index">
        <div class="card-header-compact">
          <i class="fa fa-video-camera"></i>
          <span>{{ videoFile.fileName }}</span>
        </div>
        <div class="video-container-compact">
          <video 
            [src]="getVideoUrl(videoFile)"
            controls
            autoplay
            loop
            class="video-player-compact"
            (error)="onVideoError($event, videoFile)">
            Votre navigateur ne supporte pas la lecture de vidéos.
          </video>
        </div>
      </div>

      <!-- File Upload - Small Vertical -->
      <div class="dynamic-card card-small card-vertical upload-card" *ngIf="user && evenement">
        <div class="card-header-compact">
          <i class="fa fa-upload"></i>
          <span>{{ 'EVENTELEM.UPLOAD' | translate }}</span>
        </div>
        <div class="upload-section-compact">
          <div class="file-upload-wrapper">
            <label [for]="'file-upload-input-' + evenement.id" 
                   class="btn-compact btn-success-compact">
              <i class="fa fa-upload"></i> {{ 'EVENTELEM.UPLOAD' | translate }}
            </label>
            <input type="file" 
                   [id]="'file-upload-input-' + evenement.id" 
                   #fileInput 
                   (change)="onFileSelected($event)" 
                   multiple 
                   accept="image/*,video/*,.mp4,.webm,.ogg,.ogv,.mov,.avi,.mkv,.flv,.wmv,.m4v,.3gp,.pdf,.doc,.docx,.xls,.xlsx,.ods,.odt,.txt,.zip,.rar" 
                   style="display: none;" />
          </div>
        </div>
      </div>

    </div>
    <!-- End Dynamic Grid -->
  </div>
  <!-- End Content Layer -->
</div>
<!-- End Artistic Event Page -->

<!-- Image Modal -->
<ng-template #imageModal let-c="close">
  <div class="modal-header">
    <h5 class="modal-title">{{ selectedImageAlt }}</h5>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-secondary" 
              (click)="toggleFullscreen()"
              [ngbTooltip]="isFullscreen ? ('EVENTELEM.EXIT_FULLSCREEN' | translate) : ('EVENTELEM.FULLSCREEN' | translate)"
              placement="bottom">
        <i [class.fa-arrows-alt]="!isFullscreen" [class.fa-compress]="isFullscreen" class="me-1"></i>
        <span *ngIf="!isFullscreen">{{ 'EVENTELEM.FULLSCREEN' | translate }}</span>
        <span *ngIf="isFullscreen">{{ 'EVENTELEM.EXIT_FULLSCREEN' | translate }}</span>
      </button>
    </div>
    <button type="button" class="btn-close" (click)="c()" aria-label="Close"><span aria-hidden="true">&times;</span></button>
  </div>
  <div class="modal-body text-center">
    <img [src]="selectedImageUrl" [alt]="selectedImageAlt" class="img-fluid modal-image" />
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="c()">{{ 'COMMUN.CLOSE' | translate }}</button>
  </div>
</ng-template>

<!-- Upload Logs Modal -->
<ng-template #uploadLogsModal let-modal>
  <div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
      <i class="fa fa-upload me-2"></i>
      {{ 'EVENTELEM.UPLOAD_PROGRESS' | translate }}
    </h5>
    <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss('Cross click')" [attr.aria-label]="'COMMUN.CLOSE' | translate"></button>
  </div>
  <div class="modal-body">
    <div class="upload-logs-content">
      <div class="log-content" #logContent>
        <div class="log-entry" 
             *ngFor="let log of uploadLogs"
             [class.log-success]="log.startsWith('SUCCESS:')"
             [class.log-error]="log.startsWith('ERROR:')">
          {{ log }}
        </div>
        <div *ngIf="uploadLogs.length === 0" class="text-center text-muted">
          {{ 'EVENTELEM.WAITING_FOR_UPLOAD' | translate }}
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')" [disabled]="isUploading">
      {{ 'COMMUN.CLOSE' | translate }}
    </button>
  </div>
</ng-template>

