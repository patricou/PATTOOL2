<!-- Standard Title Section -->
<div class="pat-title">
    <div class="title-header">
        <h2>{{ 'SYSTEM.TITLE' | translate }}</h2>
        <button (click)="refreshAllStats()" 
                class="btn btn-sm btn-outline-primary btn-refresh-all-stats" 
                [disabled]="isLoadingStats"
                [title]="'SYSTEM.REFRESH_ALL_STATS' | translate">
            <i class="fa" [class.fa-refresh]="!isLoadingStats" [class.fa-spinner]="isLoadingStats" [class.fa-spin]="isLoadingStats"></i>
            <span>{{ 'SYSTEM.REFRESH_ALL_STATS' | translate }}</span>
        </button>
    </div>
    <app-navigation-buttons></app-navigation-buttons>
</div>

<!-- Main Content -->
<div class="container mt-0">
    <div class="row justify-content-center">
        <div class="col-12" style="max-width: 75%; margin: 0 auto;">
            
            <!-- Backend Cache Statistics Section -->
            <div class="cache-stats-card">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fa fa-server"></i>
                    </div>
                    <div class="stats-title">
                        <h4>{{ 'SYSTEM.CACHE_STATS.BACKEND_TITLE' | translate }}</h4>
                    </div>
                    <button (click)="loadCacheStats()" 
                            class="btn-refresh-stats" 
                            [disabled]="isLoadingStats"
                            [title]="'SYSTEM.CACHE_STATS.REFRESH' | translate">
                        <i class="fa" [class.fa-refresh]="!isLoadingStats" [class.fa-spinner]="isLoadingStats" [class.fa-spin]="isLoadingStats"></i>
                    </button>
                </div>
                <div class="stats-content" *ngIf="!isLoadingStats && cacheStats && !statsError">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.ENABLED' | translate }}</div>
                            <div class="stat-value" [class.enabled]="cacheStats.enabled" [class.disabled]="!cacheStats.enabled">
                                {{ cacheStats.enabled ? ('SYSTEM.CACHE_STATS.YES' | translate) : ('SYSTEM.CACHE_STATS.NO' | translate) }}
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.ENTRY_COUNT' | translate }}</div>
                            <div class="stat-value">{{ cacheStats.entryCount || 0 }} / {{ cacheStats.maxEntries || 0 }}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.TOTAL_SIZE' | translate }}</div>
                            <div class="stat-value">{{ (cacheStats.totalSizeMB || 0).toFixed(2) }} MB</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.TOTAL_SIZE_BYTES' | translate }}</div>
                            <div class="stat-value">{{ (cacheStats.totalSizeBytes || 0) | number }} bytes</div>
                        </div>
                    </div>
                </div>
                <div class="stats-loading" *ngIf="isLoadingStats">
                    <i class="fa fa-spinner fa-spin"></i> {{ 'SYSTEM.CACHE_STATS.LOADING' | translate }}
                </div>
                <div class="stats-error" *ngIf="statsError && !isLoadingStats">
                    <i class="fa fa-exclamation-triangle"></i> {{ statsError }}
                </div>
            </div>

            <!-- Frontend Cache Statistics Section -->
            <div class="cache-stats-card" *ngIf="frontendCacheStats">
                <div class="stats-header">
                    <div class="stats-icon frontend-icon">
                        <i class="fa fa-desktop"></i>
                    </div>
                    <div class="stats-title">
                        <h4>{{ 'SYSTEM.CACHE_STATS.FRONTEND_TITLE' | translate }}</h4>
                    </div>
                    <button (click)="calculateFrontendCacheStats()" 
                            class="btn-refresh-stats" 
                            [title]="'SYSTEM.CACHE_STATS.REFRESH' | translate">
                        <i class="fa fa-refresh"></i>
                    </button>
                </div>
                <div class="stats-content" *ngIf="frontendCacheStats && !frontendCacheStats.error">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.LOCAL_STORAGE' | translate }}</div>
                            <div class="stat-value">
                                <span [class.enabled]="frontendCacheStats.localStorage?.enabled" [class.disabled]="!frontendCacheStats.localStorage?.enabled">
                                    {{ frontendCacheStats.localStorage?.enabled ? ('SYSTEM.CACHE_STATS.YES' | translate) : ('SYSTEM.CACHE_STATS.NO' | translate) }}
                                </span>
                                <span *ngIf="frontendCacheStats.localStorage?.enabled" class="stat-detail">
                                    - {{ frontendCacheStats.localStorage?.entryCount || 0 }} {{ 'SYSTEM.CACHE_STATS.ENTRIES' | translate }}
                                    <span *ngIf="(frontendCacheStats.localStorage?.totalSizeMB || 0) >= 1">
                                        ({{ (frontendCacheStats.localStorage?.totalSizeMB || 0).toFixed(2) }} MB)
                                    </span>
                                    <span *ngIf="(frontendCacheStats.localStorage?.totalSizeMB || 0) < 1 && (frontendCacheStats.localStorage?.totalSizeKB || 0) >= 1">
                                        ({{ (frontendCacheStats.localStorage?.totalSizeKB || 0).toFixed(2) }} KB)
                                    </span>
                                    <span *ngIf="(frontendCacheStats.localStorage?.totalSizeKB || 0) < 1">
                                        ({{ (frontendCacheStats.localStorage?.totalSizeBytes || 0) }} B)
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="stat-item" *ngIf="frontendCacheStats.sessionStorage">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.SESSION_STORAGE' | translate }}</div>
                            <div class="stat-value">
                                <span [class.enabled]="frontendCacheStats.sessionStorage?.enabled" [class.disabled]="!frontendCacheStats.sessionStorage?.enabled">
                                    {{ frontendCacheStats.sessionStorage?.enabled ? ('SYSTEM.CACHE_STATS.YES' | translate) : ('SYSTEM.CACHE_STATS.NO' | translate) }}
                                </span>
                                <span *ngIf="frontendCacheStats.sessionStorage?.enabled" class="stat-detail">
                                    - {{ frontendCacheStats.sessionStorage?.entryCount || 0 }} {{ 'SYSTEM.CACHE_STATS.ENTRIES' | translate }}
                                    <span *ngIf="(frontendCacheStats.sessionStorage?.totalSizeMB || 0) >= 1">
                                        ({{ (frontendCacheStats.sessionStorage?.totalSizeMB || 0).toFixed(2) }} MB)
                                    </span>
                                    <span *ngIf="(frontendCacheStats.sessionStorage?.totalSizeMB || 0) < 1 && (frontendCacheStats.sessionStorage?.totalSizeKB || 0) >= 1">
                                        ({{ (frontendCacheStats.sessionStorage?.totalSizeKB || 0).toFixed(2) }} KB)
                                    </span>
                                    <span *ngIf="(frontendCacheStats.sessionStorage?.totalSizeKB || 0) < 1">
                                        ({{ (frontendCacheStats.sessionStorage?.totalSizeBytes || 0) }} B)
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="stat-item" *ngIf="frontendCacheStats.memory?.available">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.MEMORY' | translate }}</div>
                            <div class="stat-value">
                                {{ ((frontendCacheStats.memory?.usedJSHeapSize || 0) / (1024 * 1024)).toFixed(0) }} / 
                                {{ ((frontendCacheStats.memory?.totalJSHeapSize || 0) / (1024 * 1024)).toFixed(0) }} MB
                                <span class="stat-detail">(limit: {{ ((frontendCacheStats.memory?.jsHeapSizeLimit || 0) / (1024 * 1024)).toFixed(0) }} MB)</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.FILE_THUMBNAILS' | translate }}</div>
                            <div class="stat-value">{{ fileThumbnailsCacheCount }}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.PENDING_THUMBNAIL_LOADS' | translate }}</div>
                            <div class="stat-value" [class.text-warning]="pendingThumbnailLoadsCount > 0">
                                {{ pendingThumbnailLoadsCount }}
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.COMPRESSION_CACHE_PHOTOS' | translate }}</div>
                            <div class="stat-value">{{ compressionCacheCount }}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.CACHE_STATS.COMPRESSION_CACHE_SIZE' | translate }}</div>
                            <div class="stat-value">{{ compressionCacheSizeMB.toFixed(2) }} MB</div>
                        </div>
                    </div>
                </div>
                <div class="stats-error" *ngIf="frontendCacheStats?.error">
                    <i class="fa fa-exclamation-triangle"></i> {{ frontendCacheStats.error }}
                </div>
            </div>

            <!-- Memory Statistics Section -->
            <div class="cache-stats-card">
                <div class="stats-header">
                    <div class="stats-icon performance-icon">
                        <i class="fa fa-microchip"></i>
                    </div>
                    <div class="stats-title">
                        <h4>{{ 'SYSTEM.MEMORY_STATS.TITLE' | translate }}</h4>
                    </div>
                    <button (click)="loadAdditionalDebugInfo()" 
                            class="btn-refresh-stats" 
                            [disabled]="isLoadingAdditionalStats"
                            [title]="'SYSTEM.CACHE_STATS.REFRESH' | translate">
                        <i class="fa" [class.fa-refresh]="!isLoadingAdditionalStats" [class.fa-spinner]="isLoadingAdditionalStats" [class.fa-spin]="isLoadingAdditionalStats"></i>
                    </button>
                </div>
                <div class="stats-content" *ngIf="!isLoadingAdditionalStats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.MEMORY_STATS.HOST_MEMORY' | translate }} (System RAM):</div>
                            <div class="stat-value" 
                                 [class.text-success]="hostMemoryUsagePercent < 50" 
                                 [class.text-warning]="hostMemoryUsagePercent >= 50 && hostMemoryUsagePercent < 80"
                                 [class.text-danger]="hostMemoryUsagePercent >= 80">
                                {{ hostMemoryUsage }}
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.MEMORY_STATS.JVM_MEMORY' | translate }} (Backend):</div>
                            <div class="stat-value" 
                                 [class.text-success]="jvmMemoryUsagePercent < 50" 
                                 [class.text-warning]="jvmMemoryUsagePercent >= 50 && jvmMemoryUsagePercent < 85"
                                 [class.text-danger]="jvmMemoryUsagePercent >= 85">
                                {{ jvmMemoryUsage }}
                            </div>
                            <span class="badge ms-2" 
                                  [class.bg-success]="jvmStatus === 'OK'"
                                  [class.bg-warning]="jvmStatus === 'WARNING'"
                                  [class.bg-danger]="jvmStatus === 'CRITICAL' || jvmStatus === 'ERROR'">
                                {{ jvmStatus }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="stats-loading" *ngIf="isLoadingAdditionalStats">
                    <i class="fa fa-spinner fa-spin"></i> {{ 'SYSTEM.CACHE_STATS.LOADING' | translate }}
                </div>
            </div>

            <!-- Performance Statistics Section -->
            <div class="cache-stats-card" *ngIf="performanceStats">
                <div class="stats-header">
                    <div class="stats-icon performance-icon">
                        <i class="fa fa-tachometer"></i>
                    </div>
                    <div class="stats-title">
                        <h4>{{ 'SYSTEM.PERFORMANCE_STATS.TITLE' | translate }}</h4>
                    </div>
                    <button (click)="collectPerformanceStats()" 
                            class="btn-refresh-stats" 
                            [title]="'SYSTEM.CACHE_STATS.REFRESH' | translate">
                        <i class="fa fa-refresh"></i>
                    </button>
                </div>
                <div class="stats-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.PERFORMANCE_STATS.PAGE_LOAD' | translate }}</div>
                            <div class="stat-value">{{ formatTime(performanceStats.pageLoadTime) }}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.PERFORMANCE_STATS.DOM_READY' | translate }}</div>
                            <div class="stat-value">{{ formatTime(performanceStats.domReadyTime) }}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.PERFORMANCE_STATS.CONNECTION_TYPE' | translate }}</div>
                            <div class="stat-value">{{ performanceStats.connectionType || 'N/A' }}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.PERFORMANCE_STATS.SCREEN_RESOLUTION' | translate }}</div>
                            <div class="stat-value">{{ performanceStats.screenResolution || 'N/A' }}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.PERFORMANCE_STATS.USER_AGENT' | translate }}</div>
                            <div class="stat-value stat-value-small">{{ performanceStats.userAgent || 'N/A' }}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">{{ 'SYSTEM.PERFORMANCE_STATS.LANGUAGE' | translate }}</div>
                            <div class="stat-value">{{ performanceStats.language || 'N/A' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compact Cache Controls -->
            <div class="cache-controls">
                
                <!-- Save Cache -->
                <div class="cache-action-card compact">
                    <div class="action-header-compact">
                        <div class="action-icon-small save-icon">
                            <i class="fa fa-save"></i>
                        </div>
                        <div class="action-info-compact">
                            <h5>{{ 'SYSTEM.SAVE_CACHE.TITLE' | translate }}</h5>
                            <p>{{ 'SYSTEM.SAVE_CACHE.DESC' | translate }}</p>
                        </div>
                        <button (click)="saveCache()" 
                                class="btn-small btn-save" 
                                [disabled]="!isSaveCacheAuthorized || isSaving || saveMessageVisible"
                                [title]="!isSaveCacheAuthorized ? ('SYSTEM.SAVE_CACHE.NOT_AUTHORIZED' | translate) : ''">
                            <i class="fa" [class.fa-save]="!isSaving" [class.fa-spinner]="isSaving" [class.fa-spin]="isSaving"></i>
                            <span>{{ isSaving ? ('SYSTEM.SAVE_CACHE.SAVING' | translate) : ('SYSTEM.SAVE_CACHE.BUTTON' | translate) }}</span>
                        </button>
                    </div>
                    <div *ngIf="saveMessageVisible" class="action-message save-message">
                        <i class="fa fa-info-circle"></i>
                        <span>{{ saveMessage }}</span>
                    </div>
                </div>

                <!-- Load Cache -->
                <div class="cache-action-card compact">
                    <div class="action-header-compact">
                        <div class="action-icon-small load-icon">
                            <i class="fa fa-upload"></i>
                        </div>
                        <div class="action-info-compact">
                            <h5>{{ 'SYSTEM.LOAD_CACHE.TITLE' | translate }}</h5>
                            <p>{{ 'SYSTEM.LOAD_CACHE.DESC' | translate }}</p>
                        </div>
                        <button (click)="loadCache()" 
                                class="btn-small btn-load" 
                                [disabled]="!isLoadCacheAuthorized || isLoading || loadMessageVisible"
                                [title]="!isLoadCacheAuthorized ? ('SYSTEM.LOAD_CACHE.NOT_AUTHORIZED' | translate) : ''">
                            <i class="fa" [class.fa-upload]="!isLoading" [class.fa-spinner]="isLoading" [class.fa-spin]="isLoading"></i>
                            <span>{{ isLoading ? ('SYSTEM.LOAD_CACHE.LOADING' | translate) : ('SYSTEM.LOAD_CACHE.BUTTON' | translate) }}</span>
                        </button>
                    </div>
                    <div *ngIf="loadMessageVisible" class="action-message load-message">
                        <i class="fa fa-info-circle"></i>
                        <span>{{ loadMessage }}</span>
                    </div>
                </div>

                <!-- Clear Cache -->
                <div class="cache-action-card compact">
                    <div class="action-header-compact">
                        <div class="action-icon-small clear-icon">
                            <i class="fa fa-trash"></i>
                        </div>
                        <div class="action-info-compact">
                            <h5>{{ 'SYSTEM.CLEAR_CACHE.TITLE' | translate }}</h5>
                            <p>{{ 'SYSTEM.CLEAR_CACHE.DESC' | translate }}</p>
                        </div>
                        <button (click)="clearCache()" 
                                class="btn-small btn-clear"
                                [disabled]="!isClearCacheAuthorized || isClearing || clearMessageVisible"
                                [title]="!isClearCacheAuthorized ? ('SYSTEM.CLEAR_CACHE.NOT_AUTHORIZED' | translate) : ''">
                            <i class="fa" [class.fa-trash]="!isClearing" [class.fa-spinner]="isClearing" [class.fa-spin]="isClearing"></i>
                            <span>{{ isClearing ? ('SYSTEM.CLEAR_CACHE.CLEARING' | translate) : ('SYSTEM.CLEAR_CACHE.BUTTON' | translate) }}</span>
                        </button>
                    </div>
                    <div *ngIf="clearMessageVisible" class="action-message clear-message">
                        <i class="fa fa-info-circle"></i>
                        <span>{{ clearMessage }}</span>
                    </div>
                </div>

                <!-- Shutdown Application -->
                <div class="cache-action-card compact shutdown-card">
                    <div class="action-header-compact">
                        <div class="action-icon-small shutdown-icon">
                            <i class="fa fa-power-off"></i>
                        </div>
                        <div class="action-info-compact">
                            <h5>{{ 'SYSTEM.SHUTDOWN.TITLE' | translate }}</h5>
                            <p>{{ 'SYSTEM.SHUTDOWN.DESC' | translate }}</p>
                        </div>
                        <button (click)="shutdownApplication()" 
                                class="btn-small btn-shutdown" 
                                [disabled]="!isShutdownAuthorized || isShuttingDown || shutdownMessageVisible"
                                [title]="!isShutdownAuthorized ? ('SYSTEM.SHUTDOWN.NOT_AUTHORIZED' | translate) : ''">
                            <i class="fa" [class.fa-power-off]="!isShuttingDown" [class.fa-spinner]="isShuttingDown" [class.fa-spin]="isShuttingDown"></i>
                            <span>{{ isShuttingDown ? ('SYSTEM.SHUTDOWN.SHUTTING_DOWN' | translate) : ('SYSTEM.SHUTDOWN.BUTTON' | translate) }}</span>
                        </button>
                    </div>
                    <div *ngIf="shutdownMessageVisible" class="action-message shutdown-message">
                        <i class="fa fa-info-circle"></i>
                        <span>{{ shutdownMessage }}</span>
                    </div>
                </div>

            </div>

            <!-- Exception Report Section -->
            <div class="cache-action-card exception-report-card">
                <div class="action-header">
                    <div class="action-icon report-icon">
                        <i class="fa fa-bug"></i>
                    </div>
                    <div class="action-info">
                        <h4>{{ 'SYSTEM.EXCEPTION_REPORT.TITLE' | translate }}</h4>
                        <p>{{ 'SYSTEM.EXCEPTION_REPORT.DESC' | translate }}</p>
                    </div>
                </div>
                <div class="report-actions">
                    <button 
                        type="button" 
                        class="btn-small btn-report-send"
                        (click)="sendExceptionReport()"
                        [disabled]="isSendingReport">
                        <i class="fa" [ngClass]="{'fa-envelope': !isSendingReport, 'fa-spinner': isSendingReport, 'fa-spin': isSendingReport}"></i>
                        <span>{{ isSendingReport ? ('SYSTEM.EXCEPTION_REPORT.SENDING' | translate) : ('SYSTEM.EXCEPTION_REPORT.SEND' | translate) }}</span>
                    </button>
                    <button
                        type="button"
                        class="btn-small btn-report-view"
                        (click)="viewExceptionReport()"
                        [disabled]="isLoadingPreview">
                        <i class="fa" [ngClass]="{'fa-eye': !isLoadingPreview, 'fa-spinner': isLoadingPreview, 'fa-spin': isLoadingPreview}"></i>
                        <span>{{ isLoadingPreview ? ('SYSTEM.EXCEPTION_REPORT.LOADING' | translate) : ('SYSTEM.EXCEPTION_REPORT.VIEW' | translate) }}</span>
                    </button>
                </div>
                <div class="report-feedback">
                    <div *ngIf="reportMessage" class="action-message report-success-message">
                        <i class="fa fa-check-circle"></i>
                        <span>{{ reportMessage }}</span>
                    </div>
                    <div *ngIf="reportError" class="action-message report-error-message">
                        <i class="fa fa-exclamation-circle"></i>
                        <span>{{ reportError }}</span>
                    </div>
                    <div *ngIf="previewError" class="action-message report-warning-message">
                        <i class="fa fa-exclamation-triangle"></i>
                        <span>{{ previewError }}</span>
                    </div>
                </div>
            </div>

            <!-- Connection Logs Section -->
            <div class="cache-action-card connection-logs-card">
                <div class="action-header">
                    <div class="action-icon connection-logs-icon">
                        <i class="fa fa-users"></i>
                    </div>
                    <div class="action-info">
                        <h4>{{ 'SYSTEM.CONNECTION_LOGS.TITLE' | translate }}</h4>
                        <p>{{ 'SYSTEM.CONNECTION_LOGS.DESC' | translate }}</p>
                    </div>
                </div>
                <div class="report-actions">
                    <button 
                        type="button" 
                        class="btn-small btn-connection-logs"
                        (click)="viewConnectionLogs()">
                        <i class="fa fa-list"></i>
                        <span>{{ 'SYSTEM.CONNECTION_LOGS.VIEW' | translate }}</span>
                    </button>
                    <button
                        type="button"
                        class="btn-small btn-connection-logs-delete"
                        (click)="deleteAllConnectionLogs()"
                        [disabled]="!isDeleteConnectionLogsAuthorized || isDeletingConnectionLogs">
                        <i class="fa" [ngClass]="{'fa-trash': !isDeletingConnectionLogs, 'fa-spinner': isDeletingConnectionLogs, 'fa-spin': isDeletingConnectionLogs}"></i>
                        <span>{{ 'SYSTEM.CONNECTION_LOGS.DELETE_ALL' | translate }}</span>
                    </button>
                </div>
            </div>

            <!-- Active Discussion Connections Section -->
            <div class="cache-stats-card">
                <div class="stats-header">
                    <div class="stats-icon">
                        <i class="fa fa-comments"></i>
                    </div>
                    <div class="stats-title">
                        <h4>{{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.TITLE' | translate }}</h4>
                    </div>
                    <button (click)="loadActiveDiscussionConnections()" 
                            class="btn-refresh-stats" 
                            [disabled]="isLoadingActiveConnections"
                            [title]="'SYSTEM.CACHE_STATS.REFRESH' | translate">
                        <i class="fa" [class.fa-refresh]="!isLoadingActiveConnections" [class.fa-spinner]="isLoadingActiveConnections" [class.fa-spin]="isLoadingActiveConnections"></i>
                    </button>
                </div>
                <div class="stats-content" *ngIf="!isLoadingActiveConnections && !activeConnectionsError">
                    <div class="stat-item" style="margin-bottom: 15px;">
                        <div class="stat-label">{{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.ACTIVE_CONNECTIONS' | translate }}:</div>
                        <div class="stat-value" style="font-size: 1.2em; font-weight: bold; color: #28a745;">
                            {{ activeConnectionsCount }}
                        </div>
                    </div>
                    <div *ngIf="activeDiscussionConnections.length > 0" class="active-connections-list">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>{{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.USER' | translate }}</th>
                                    <th>{{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.CONNECTED_AT' | translate }}</th>
                                    <th>{{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.DISCUSSION' | translate }}</th>
                                    <th>{{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.DISCUSSION_ID' | translate }}</th>
                                    <th>{{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.IP_ADDRESS' | translate }}</th>
                                    <th>{{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.DOMAIN' | translate }}</th>
                                    <th>{{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.LOCATION' | translate }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let conn of activeDiscussionConnections">
                                    <td>
                                        <strong>{{ conn.userName }}</strong>
                                        <br *ngIf="conn.member">
                                        <small *ngIf="conn.member" style="color: #6b7280;">
                                            {{ conn.member.firstName }} {{ conn.member.lastName }}
                                        </small>
                                    </td>
                                    <td>{{ formatConnectionDateTime(conn.connectedAt) }}</td>
                                    <td><strong>{{ conn.discussionTitle || ('SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.UNKNOWN' | translate) }}</strong></td>
                                    <td><code style="font-size: 0.85em;">{{ conn.discussionId }}</code></td>
                                    <td>{{ conn.ipAddress }}</td>
                                    <td>{{ conn.domain }}</td>
                                    <td>{{ conn.location }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div *ngIf="activeDiscussionConnections.length === 0" class="stats-empty">
                        <i class="fa fa-info-circle"></i> {{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.NO_CONNECTIONS' | translate }}
                    </div>
                </div>
                <div class="stats-loading" *ngIf="isLoadingActiveConnections">
                    <i class="fa fa-spinner fa-spin"></i> {{ 'SYSTEM.ACTIVE_DISCUSSION_CONNECTIONS.LOADING' | translate }}
                </div>
                <div class="stats-error" *ngIf="activeConnectionsError && !isLoadingActiveConnections">
                    <i class="fa fa-exclamation-triangle"></i> {{ activeConnectionsError }}
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Report Preview Overlay -->
<div class="report-overlay" *ngIf="isPreviewVisible">
    <div class="report-overlay-backdrop" (click)="closePreview()"></div>
    <div class="report-overlay-panel">
        <div class="report-overlay-header">
            <div class="report-overlay-title">
                <i class="fa fa-file-text-o"></i>
                {{ 'SYSTEM.EXCEPTION_REPORT.TITLE' | translate }}
            </div>
            <div class="report-overlay-actions">
                <button type="button"
                        class="btn btn-sm report-btn report-btn-primary report-overlay-send"
                        (click)="sendExceptionReport()"
                        [disabled]="isSendingReport">
                    <i class="fa" [ngClass]="{'fa-paper-plane': !isSendingReport, 'fa-spinner': isSendingReport, 'fa-spin': isSendingReport}"></i>
                    <span>{{ isSendingReport ? ('SYSTEM.EXCEPTION_REPORT.SENDING' | translate) : ('SYSTEM.EXCEPTION_REPORT.SEND' | translate) }}</span>
                </button>
                <button type="button"
                        class="btn btn-sm report-btn report-btn-warning report-overlay-refresh"
                        (click)="refreshReport()"
                        [disabled]="isLoadingPreview">
                    <i class="fa" [ngClass]="{'fa-rotate-right': !isLoadingPreview, 'fa-spinner': isLoadingPreview, 'fa-spin': isLoadingPreview}"></i>
                    <span>{{ isLoadingPreview ? ('SYSTEM.EXCEPTION_REPORT.LOADING' | translate) : ('SYSTEM.EXCEPTION_REPORT.REFRESH' | translate) }}</span>
                </button>
                <button type="button" class="btn btn-sm btn-light report-overlay-close" (click)="closePreview()">
                    <i class="fa fa-times"></i>
                    {{ 'SYSTEM.EXCEPTION_REPORT.CLOSE' | translate }}
                </button>
            </div>
        </div>
        <div class="report-overlay-body" [innerHTML]="reportHtml"></div>
    </div>
</div>

<!-- Connection Logs Modal - New Simple Structure -->
<div class="connection-logs-modal" *ngIf="isConnectionLogsVisible" (click)="closeConnectionLogs()">
    <div class="connection-logs-modal-content" (click)="$event.stopPropagation()">
        <!-- Header -->
        <div class="connection-logs-modal-header">
            <div class="connection-logs-modal-title">
                <i class="fa fa-users"></i>
                <span>{{ 'SYSTEM.CONNECTION_LOGS.TITLE' | translate }}</span>
                <span *ngIf="connectionLogsCount > 0" class="connection-logs-count">({{ connectionLogsCount }})</span>
            </div>
            <div class="connection-logs-modal-actions">
                <button type="button" 
                        class="btn btn-sm btn-danger" 
                        (click)="deleteAllConnectionLogs()"
                        [disabled]="!isDeleteConnectionLogsAuthorized || isDeletingConnectionLogs || isLoadingConnectionLogs">
                    <i class="fa" [ngClass]="{'fa-trash': !isDeletingConnectionLogs, 'fa-spinner': isDeletingConnectionLogs, 'fa-spin': isDeletingConnectionLogs}"></i>
                    {{ 'SYSTEM.CONNECTION_LOGS.DELETE_ALL' | translate }}
                </button>
                <button type="button" class="btn btn-sm btn-secondary" (click)="closeConnectionLogs()">
                    <i class="fa fa-times"></i>
                    {{ 'SYSTEM.CONNECTION_LOGS.CLOSE' | translate }}
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="connection-logs-modal-body">
            <!-- Filters -->
            <div class="connection-logs-filters">
                <div class="connection-logs-filter-row">
                    <div class="connection-logs-filter-group">
                        <label>{{ 'SYSTEM.CONNECTION_LOGS.FROM_DATE' | translate }}</label>
                        <input type="datetime-local" 
                               [value]="getDateTimeLocalString(connectionLogsStartDate)"
                               (change)="onStartDateChange($event)"
                               class="form-control form-control-sm">
                    </div>
                    <div class="connection-logs-filter-group">
                        <label>{{ 'SYSTEM.CONNECTION_LOGS.TO_DATE' | translate }}</label>
                        <input type="datetime-local" 
                               [value]="getDateTimeLocalString(connectionLogsEndDate)"
                               (change)="onEndDateChange($event)"
                               class="form-control form-control-sm">
                    </div>
                    <div class="connection-logs-filter-group">
                        <label>&nbsp;</label>
                        <button type="button" 
                                class="btn btn-primary btn-sm"
                                (click)="applyConnectionLogsFilter()"
                                [disabled]="isLoadingConnectionLogs">
                            <i class="fa" [ngClass]="{'fa-search': !isLoadingConnectionLogs, 'fa-spinner': isLoadingConnectionLogs, 'fa-spin': isLoadingConnectionLogs}"></i>
                            {{ 'SYSTEM.CONNECTION_LOGS.FILTER' | translate }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div *ngIf="deleteConnectionLogsMessageVisible" 
                 class="connection-logs-alert"
                 [class.alert-success]="deleteConnectionLogsMessage.includes('Success') || deleteConnectionLogsMessage.includes('success')"
                 [class.alert-danger]="!deleteConnectionLogsMessage.includes('Success') && !deleteConnectionLogsMessage.includes('success')">
                <i class="fa" [ngClass]="{'fa-check-circle': deleteConnectionLogsMessage.includes('Success') || deleteConnectionLogsMessage.includes('success'), 'fa-exclamation-circle': !deleteConnectionLogsMessage.includes('Success') && !deleteConnectionLogsMessage.includes('success')}"></i>
                {{ deleteConnectionLogsMessage }}
            </div>

            <!-- Loading -->
            <div *ngIf="isLoadingConnectionLogs" class="connection-logs-loading-state">
                <i class="fa fa-spinner fa-spin"></i>
                <span>{{ 'SYSTEM.CONNECTION_LOGS.LOADING' | translate }}</span>
            </div>

            <!-- Error -->
            <div *ngIf="connectionLogsError && !isLoadingConnectionLogs" class="connection-logs-alert alert-danger">
                <i class="fa fa-exclamation-triangle"></i>
                {{ connectionLogsError }}
            </div>

            <!-- Table Container -->
            <div *ngIf="!isLoadingConnectionLogs && !connectionLogsError" class="connection-logs-table-wrapper">
                <!-- Empty State -->
                <div *ngIf="connectionLogs.length === 0" class="connection-logs-empty-state">
                    <i class="fa fa-info-circle"></i>
                    <p>{{ 'SYSTEM.CONNECTION_LOGS.NO_LOGS' | translate }}</p>
                </div>

                <!-- HTML Table -->
                <div *ngIf="connectionLogs.length > 0" class="connection-logs-table-container">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped connection-logs-table">
                            <thead>
                                <tr>
                                    <th>{{ 'SYSTEM.CONNECTION_LOGS.DATE_TIME' | translate }}</th>
                                    <th>{{ 'SYSTEM.CONNECTION_LOGS.TYPE' | translate }}</th>
                                    <th>{{ 'SYSTEM.CONNECTION_LOGS.USER' | translate }}</th>
                                    <th>{{ 'SYSTEM.CONNECTION_LOGS.DISCUSSION_TITLE' | translate }}</th>
                                    <th>{{ 'SYSTEM.CONNECTION_LOGS.IP_ADDRESS' | translate }}</th>
                                    <th>{{ 'SYSTEM.CONNECTION_LOGS.DOMAIN_NAME' | translate }}</th>
                                    <th>{{ 'SYSTEM.CONNECTION_LOGS.LOCATION' | translate }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let log of connectionLogs">
                                    <td>{{ formatConnectionDate(log.connectionDate) }}</td>
                                    <td>
                                        <span [class]="log.type === 'discussion' ? 'badge bg-info' : 'badge bg-primary'">
                                            {{ log.type }}
                                        </span>
                                    </td>
                                    <td>{{ log.memberUserName || log.member?.userName || log.memberId || 'N/A' }}</td>
                                    <td>
                                        <strong *ngIf="log.type === 'discussion' && log.discussionTitle">{{ log.discussionTitle }}</strong>
                                        <em *ngIf="log.type === 'discussion' && !log.discussionTitle">No title</em>
                                        <span *ngIf="log.type !== 'discussion'">-</span>
                                    </td>
                                    <td>{{ log.ipAddress || 'N/A' }}</td>
                                    <td>{{ log.domainName || 'N/A' }}</td>
                                    <td>{{ log.location || 'N/A' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
