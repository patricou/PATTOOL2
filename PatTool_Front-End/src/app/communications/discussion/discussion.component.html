<!-- Discussion Component - Reusable -->
<div class="discussion-container">
    <!-- Header Section (optional) -->
    <div class="discussion-header" *ngIf="showTitle">
        <h3 *ngIf="title">{{ title }}</h3>
        <div class="discussion-stats" *ngIf="!title">
            <i class="fa fa-comments"></i>
            <span>{{ messages.length }} {{ 'DISCUSSION.MESSAGES' | translate }}</span>
        </div>
    </div>

    <!-- Chat Content Container -->
    <div class="discussion-content-container">
        <!-- Messages Container -->
        <div class="messages-container">
            <div class="messages-list" #messagesList>
                <div class="message-wrapper" 
                     *ngFor="let item of messages; trackBy: trackByMessageId"
                     [attr.data-cache-counter]="cacheUpdateCounter"
                     [class.own-message]="isOwnMessage(item)">
                    
                    <div class="message-bubble">
                        <!-- Avatar for received messages -->
                        <div class="message-avatar" *ngIf="!isOwnMessage(item)">
                            <div class="avatar-circle">
                                <span>{{item.author?.firstName?.charAt(0) || item.author?.userName?.charAt(0) || 'U'}}</span>
                            </div>
                        </div>

                        <!-- Message Content -->
                        <div class="message-content-wrapper">
                            <!-- Sender name for received messages -->
                            <div class="message-sender" *ngIf="!isOwnMessage(item)">
                                {{item.author?.firstName}} {{item.author?.lastName}} ({{item.author?.userName}})
                            </div>
                            
                            <!-- Image -->
                            <div *ngIf="item.imageUrl && hasFileUrl(item, true)" class="message-media">
                                <img [src]="getFileUrl(item, true)" 
                                     [alt]="item.imageFileName || 'Image'"
                                     class="message-image"
                                     (error)="hideImageOnError($event)">
                            </div>
                            <div *ngIf="item.imageUrl && !hasFileUrl(item, true)" class="message-media-loading">
                                <i class="fa fa-spinner fa-spin"></i> {{ 'DISCUSSION.LOADING_IMAGE' | translate }}
                                <!-- Hidden counter to trigger change detection when cache updates -->
                                <span style="display: none;">{{ cacheUpdateCounter }}</span>
                                <!-- Also track message ID to ensure re-evaluation -->
                                <span style="display: none;">{{ item.id }}</span>
                            </div>
                            
                            <!-- Video -->
                            <div *ngIf="item.videoUrl && hasFileUrl(item, false)" class="message-media">
                                <video [src]="getFileUrl(item, false)" 
                                       controls
                                       class="message-video"
                                       (error)="hideVideoOnError($event)">
                                    {{ 'DISCUSSION.VIDEO_NOT_SUPPORTED' | translate }}
                                </video>
                            </div>
                            <div *ngIf="item.videoUrl && !hasFileUrl(item, false)" class="message-media-loading">
                                <i class="fa fa-spinner fa-spin"></i> {{ 'DISCUSSION.LOADING_VIDEO' | translate }}
                            </div>
                            
                            <!-- Text Message -->
                            <div class="message-text-wrapper" *ngIf="item.message">
                                <p class="message-text">{{item.message}}</p>
                            </div>
                            
                            <!-- Message Footer with timestamp and action buttons -->
                            <div class="message-footer">
                                <span class="message-time">{{formatMessageTime(item.dateTime)}}</span>
                                <div class="message-actions" *ngIf="isOwnMessage(item)">
                                    <button class="btn-edit-message" 
                                            (click)="editMessage(item)"
                                            [attr.title]="'DISCUSSION.EDIT_MESSAGE' | translate">
                                        <i class="fa fa-edit"></i>
                                    </button>
                                    <button class="btn-delete-message" 
                                            (click)="deleteMessage(item)"
                                            [attr.title]="'DISCUSSION.DELETE_MESSAGE' | translate">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" *ngIf="messages.length === 0 && !isLoading">
                    <div class="empty-icon">
                        <i class="fa fa-comment-slash"></i>
                    </div>
                    <h3>{{ 'DISCUSSION.NO_MESSAGES' | translate }}</h3>
                    <p>{{ 'DISCUSSION.BE_FIRST_MESSAGE' | translate }}</p>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="input-container">
            <!-- Connection Status - Hidden when used in modal (shown in modal footer instead) -->
            <div *ngIf="(isConnecting || connectionStatus) && showTitle" class="connection-status-bar" 
                 [class.connecting]="isConnecting"
                 [class.connected]="connectionStatus === 'Connected'"
                 [class.error]="connectionStatus.includes('error') || connectionStatus.includes('timeout')">
                <i class="fa" 
                   [class.fa-spinner]="isConnecting"
                   [class.fa-spin]="isConnecting"
                   [class.fa-check-circle]="connectionStatus === 'Connected'"
                   [class.fa-exclamation-circle]="connectionStatus.includes('error') || connectionStatus.includes('timeout')"></i>
                <span>{{ connectionStatus }}</span>
            </div>

            <!-- File Preview -->
            <div *ngIf="imagePreview || videoPreview || isImageProcessing" class="file-preview-container">
                <div class="file-preview">
                    <!-- Spinner pendant le traitement de l'image -->
                    <div *ngIf="isImageProcessing && !imagePreview" class="image-processing-spinner">
                        <i class="fa fa-spinner fa-spin"></i>
                        <span>{{ 'DISCUSSION.PROCESSING_IMAGE' | translate }}</span>
                    </div>
                    <img *ngIf="imagePreview && !isImageProcessing" [src]="imagePreview" alt="Preview" class="preview-image">
                    <video *ngIf="videoPreview" [src]="videoPreview" controls class="preview-video"></video>
                    <button class="btn-remove-file" (click)="clearFileSelection()" [attr.title]="'DISCUSSION.REMOVE_FILE' | translate" [disabled]="isImageProcessing">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Input Box -->
            <div class="input-box">
                    <button class="btn-attach" 
                        type="button"
                        (click)="triggerFileInput(); showEmojiPicker = false"
                        [attr.title]="'DISCUSSION.ATTACH_FILE' | translate">
                    <i class="fa fa-paperclip"></i>
                </button>
                
                <div class="input-field-wrapper">
                    <textarea 
                        [(ngModel)]="msgVal" 
                        type="text" 
                        id="message" 
                        [placeholder]="editingMessageId ? ('DISCUSSION.EDIT_MESSAGE_PLACEHOLDER' | translate) : ('DISCUSSION.TYPE_MESSAGE_PLACEHOLDER' | translate)"
                        (keydown.enter)="Send()" 
                        (keydown.enter.shift)="$event.preventDefault()"
                        (click)="showEmojiPicker = false"
                        (focus)="showEmojiPicker = false"
                        class="message-input"
                        rows="1"
                        [disabled]="isLoading"
                        #messageInput>
                    </textarea>
                </div>

                <button class="btn-emoji" 
                        type="button"
                        (click)="toggleEmojiPicker(); $event.stopPropagation()"
                        [attr.title]="'DISCUSSION.ADD_EMOJI' | translate">
                    <span class="emoji-icon">ðŸ˜€</span>
                </button>

                <button class="btn-cancel-edit" 
                        *ngIf="editingMessageId"
                        type="button"
                        (click)="cancelEdit()"
                        [attr.title]="'DISCUSSION.CANCEL_EDIT' | translate">
                    <i class="fa fa-times"></i>
                </button>

                <button class="btn-send" 
                        type="button" 
                        (click)="Send(); showEmojiPicker = false"
                        [disabled]="(!msgVal.trim() && !selectedImage && !selectedVideo) || isLoading"
                        [attr.title]="'DISCUSSION.SEND_MESSAGE' | translate">
                    <i class="fa fa-paper-plane"></i>
                </button>

                <input type="file" 
                       #fileInput
                       (change)="onFileSelected($event)"
                       accept="image/*,video/*"
                       style="display: none;">
            </div>
            
            <!-- Emoji Picker -->
            <div class="emoji-picker-container" *ngIf="showEmojiPicker" (click)="$event.stopPropagation()">
                <div class="emoji-picker" (click)="$event.stopPropagation()">
                    <div class="emoji-picker-header">
                        <span>{{ 'DISCUSSION.SELECT_EMOJI' | translate }}</span>
                        <button class="btn-close-emoji" (click)="showEmojiPicker = false; $event.stopPropagation()" [attr.title]="'COMMUN.CLOSE' | translate">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="emoji-grid" (click)="$event.stopPropagation()">
                        <span *ngFor="let emoji of getCommonEmojis()" 
                              class="emoji-item"
                              (click)="insertEmoji(emoji); $event.stopPropagation()"
                              [title]="emoji">
                            {{ emoji }}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Help text below input box -->
            <div class="input-help-text">
                {{ 'DISCUSSION.INPUT_HELP' | translate }}
            </div>
        </div>
    </div>
</div>

