<!-- Chat Component - Displays all available discussions -->
<div class="chat-container">
    <!-- Header Section -->
    <div class="pat-title">
        <h2>{{ "RESULTS.TITLE" | translate }}</h2>
        <app-navigation-buttons></app-navigation-buttons>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Filter Section -->
    <div class="filter-container">
        <div class="chat-stats">
            <i class="fa fa-comments"></i>
            <span>{{ filteredDiscussions.length }} {{ "RESULTS.DISCUSSIONS" | translate }}</span>
            <button *ngIf="hasAdminRoleValue" 
                    class="btn btn-sm btn-outline-info ms-2" 
                    (click)="openStatisticsModal()"
                    [ngbTooltip]="'CHAT.VIEW_DISCUSSION_STATISTICS' | translate"
                    placement="bottom">
                <i class="fa fa-bar-chart"></i>
            </button>
        </div>
        <div class="filter-section-redesigned">
            <div class="filter-input-container-desktop">
                <i class="fa fa-search search-icon"></i>
                <input type="text" 
                       [ngModel]="dataFIlter" 
                       (ngModelChange)="onFilterChange($event)"
                       placeholder="{{ 'CHAT.FILTER_PLACEHOLDER' | translate }}" 
                       class="filter-input" />
                <button class="filter-clear-btn" 
                        (click)="clearFilter()" 
                        type="button"
                        [ngbTooltip]="('COMMUN.CLEAR_FILTER' | translate)" 
                        placement="bottom"
                        container="body"
                        [class.disabled]="!dataFIlter || dataFIlter.trim() === ''">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>
        <div class="sort-section-redesigned">
            <div class="sort-input-container-desktop">
                <i class="fa fa-sort search-icon"></i>
                <select class="sort-select" 
                        [ngModel]="sortBy"
                        (ngModelChange)="onSortChange($event)"
                        [title]="'CHAT.SORT_BY' | translate">
                    <option value="creationDate">{{ 'CHAT.SORT_CREATION_DATE' | translate }}</option>
                    <option value="lastMessageDate">{{ 'CHAT.SORT_LAST_MESSAGE_DATE' | translate }}</option>
                    <option value="title">{{ 'CHAT.SORT_TITLE' | translate }}</option>
                    <option value="type">{{ 'CHAT.SORT_TYPE' | translate }}</option>
                </select>
                <button class="sort-direction-btn" 
                        (click)="onSortChange(sortBy)"
                        type="button"
                        [ngbTooltip]="(sortDirection === 'asc' ? 'CHAT.SORT_DESC' : 'CHAT.SORT_ASC') | translate" 
                        placement="bottom"
                        container="body">
                    <i class="fa" [class.fa-sort-amount-asc]="sortDirection === 'asc'" [class.fa-sort-amount-desc]="sortDirection === 'desc'"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="discussions-loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>{{ connectionStatus || ("CHAT.LOADING_DISCUSSIONS" | translate) }}</p>
    </div>

    <!-- Discussions List -->
    <div *ngIf="!isLoading" class="discussions-list">
        <!-- Empty State -->
        <div *ngIf="availableDiscussions.length === 0" class="empty-state">
            <i class="fa fa-comments empty-icon"></i>
            <h3>{{ "CHAT.NO_DISCUSSIONS" | translate }}</h3>
            <p>{{ "CHAT.NO_DISCUSSIONS_DESC" | translate }}</p>
        </div>

        <!-- No Results from Filter -->
        <div *ngIf="availableDiscussions.length > 0 && filteredDiscussions.length === 0" class="empty-state">
            <i class="fa fa-search empty-icon"></i>
            <h3>{{ "CHAT.NO_FILTER_RESULTS" | translate }}</h3>
            <p>{{ "CHAT.NO_FILTER_RESULTS_DESC" | translate }}</p>
        </div>

        <!-- Discussion Cards -->
        <div *ngIf="availableDiscussions.length > 0" class="discussions-grid">
            <div *ngFor="let discussion of filteredDiscussions; trackBy: trackByDiscussionId" 
                 class="discussion-card"
                 [attr.data-type]="discussion.type"
                 [class.no-click]="true">
                <div class="discussion-card-header">
                    <div class="discussion-icon">
                        <i *ngIf="discussion.type === 'general'" class="fa fa-globe"></i>
                        <i *ngIf="discussion.type === 'event'" class="fa fa-calendar"></i>
                        <i *ngIf="discussion.type === 'friendGroup'" class="fa fa-users"></i>
                    </div>
                    <div class="discussion-title-wrapper">
                        <h4 class="discussion-title">{{ discussion.title }}</h4>
                        <div class="discussion-type-badge" [ngClass]="'type-' + discussion.type">
                            <span *ngIf="discussion.type === 'general'">{{ "CHAT.TYPE_GENERAL" | translate }}</span>
                            <span *ngIf="discussion.type === 'event'">{{ "CHAT.TYPE_EVENT" | translate }}</span>
                            <span *ngIf="discussion.type === 'friendGroup'">{{ "CHAT.TYPE_GROUP" | translate }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="discussion-card-body">
                    <div class="discussion-info">
                        <!-- Discussion Owner (shown for all types) -->
                        <p class="discussion-info-item" *ngIf="getDiscussionOwnerName(discussion)">
                            <i class="fa fa-user-circle"></i>
                            <span><strong>{{ "CHAT.OWNER" | translate }}:</strong> {{ getDiscussionOwnerName(discussion) }}</span>
                        </p>

                        <!-- Event Info -->
                        <p class="discussion-info-item" *ngIf="discussion.type === 'event' && discussion.event && discussion.event.beginEventDate">
                            <i class="fa fa-calendar"></i>
                            <span><strong>{{ "CHAT.EVENT_DATE" | translate }}:</strong> {{ discussion.event.beginEventDate | date:'short' }}</span>
                        </p>
                        <p class="discussion-info-item" *ngIf="discussion.type === 'event' && discussion.event && discussion.event.startLocation">
                            <i class="fa fa-map-marker"></i>
                            <span><strong>{{ "CHAT.EVENT_LOCATION" | translate }}:</strong> {{ discussion.event.startLocation }}</span>
                        </p>
                        <p class="discussion-info-item" *ngIf="discussion.type === 'event' && discussion.event && discussion.event.visibility">
                            <i class="fa fa-eye"></i>
                            <span><strong>{{ "CHAT.EVENT_VISIBILITY" | translate }}:</strong> 
                                <ng-container *ngIf="isStandardVisibility(discussion.event.visibility)">
                                    {{ getVisibilityLabel(discussion.event.visibility) | translate }}
                                </ng-container>
                                <ng-container *ngIf="!isStandardVisibility(discussion.event.visibility)">
                                    {{ discussion.event.visibility }}
                                </ng-container>
                            </span>
                        </p>
                        <p class="discussion-info-item" *ngIf="discussion.type === 'event' && discussion.event && discussion.event.status">
                            <i class="fa fa-info-circle"></i>
                            <span><strong>{{ "CHAT.EVENT_STATUS" | translate }}:</strong> {{ getStatusLabel(discussion.event.status) | translate }}</span>
                        </p>

                        <!-- Friend Group Info -->
                        <p class="discussion-info-item" *ngIf="discussion.type === 'friendGroup' && discussion.friendGroup">
                            <i class="fa fa-users"></i>
                            <span><strong>{{ "CHAT.MEMBERS_COUNT" | translate }}:</strong> {{ getGroupMembersCountCached(discussion.id) }} {{ "CHAT.MEMBERS" | translate }}</span>
                        </p>
                        <p class="discussion-info-item" *ngIf="discussion.type === 'friendGroup' && discussion.friendGroup && getGroupMembersListCached(discussion.id).length > 0">
                            <i class="fa fa-user"></i>
                            <span><strong>{{ "CHAT.MEMBERS_LIST" | translate }}:</strong> <span class="members-list">{{ getGroupMembersListCached(discussion.id).join(', ') }}</span></span>
                        </p>

                        <!-- General Discussion Info -->
                        <p class="discussion-info-item" *ngIf="discussion.type === 'general'">
                            <i class="fa fa-info-circle"></i>
                            <span>{{ "CHAT.GENERAL_DISCUSSION_DESC" | translate }}</span>
                        </p>

                        <!-- Last Message Date (shown for all types) -->
                        <p class="discussion-info-item" *ngIf="discussion.lastMessageDate">
                            <i class="fa fa-clock-o"></i>
                            <span><strong>{{ "CHAT.LAST_MESSAGE_DATE" | translate }}:</strong> {{ discussion.lastMessageDate | date:'short' }}</span>
                        </p>
                    </div>
                    
                    <!-- Stats above footer -->
                    <div class="discussion-stats-above-footer">
                        <span *ngIf="discussion.messageCount !== undefined" class="message-count">
                            <i class="fa fa-comment"></i>
                            {{ discussion.messageCount }} {{ (discussion.messageCount !== 1 ? "CHAT.MESSAGES" : "CHAT.MESSAGE") | translate }}
                        </span>
                        <span *ngIf="discussion.lastMessageDate" class="last-message-date">
                            <i class="fa fa-clock-o"></i>
                            {{ discussion.lastMessageDate | date:'short' }}
                        </span>
                        <span class="discussion-id" *ngIf="hasAdminRole()">
                            <i class="fa fa-hashtag"></i>
                            <strong>{{ "CHAT.ID" | translate }}:</strong> {{ discussion.id }}
                        </span>
                        <span class="discussion-id" *ngIf="hasAdminRole() && discussion.type === 'event' && discussion.event && discussion.event.id">
                            <i class="fa fa-calendar"></i>
                            <strong>{{ "CHAT.EVENT_ID" | translate }}:</strong> {{ discussion.event.id }}
                        </span>
                        <span class="discussion-id" *ngIf="hasAdminRole() && discussion.type === 'friendGroup' && discussion.friendGroup && discussion.friendGroup.id">
                            <i class="fa fa-users"></i>
                            <strong>{{ "CHAT.GROUP_ID" | translate }}:</strong> {{ discussion.friendGroup.id }}
                        </span>
                    </div>
                </div>

                <div class="discussion-card-footer">
                    <div class="discussion-actions-footer">
                        <!-- Open Discussion button for all types -->
                        <button class="btn btn-sm btn-primary discussion-action-btn" 
                                (click)="openDiscussionModal(discussion); $event.stopPropagation()"
                                [attr.aria-label]="'CHAT.OPEN_DISCUSSION' | translate"
                                [ngbTooltip]="'CHAT.OPEN_DISCUSSION' | translate"
                                placement="top">
                            <i class="fa fa-comments"></i>
                        </button>
                        <!-- Event Details button for event discussions -->
                        <button *ngIf="discussion.type === 'event' && discussion.event && discussion.event.id" 
                                class="btn btn-sm btn-info discussion-action-btn" 
                                (click)="navigateToEventDetails(discussion, $event)"
                                [attr.aria-label]="'CHAT.VIEW_EVENT_DETAILS' | translate"
                                [ngbTooltip]="'CHAT.VIEW_EVENT_DETAILS' | translate"
                                placement="top">
                            <i class="fa fa-calendar-check-o"></i>
                        </button>
                        <!-- WhatsApp button for friend groups -->
                        <button *ngIf="discussion.type === 'friendGroup' && hasWhatsAppLink(discussion.friendGroup)" 
                                class="btn btn-sm btn-success discussion-action-btn" 
                                (click)="openWhatsAppLink(discussion.friendGroup); $event.stopPropagation()"
                                [attr.aria-label]="'CHAT.OPEN_WHATSAPP_GROUP' | translate"
                                [ngbTooltip]="'CHAT.OPEN_WHATSAPP_GROUP' | translate"
                                placement="top">
                            <i class="fa fa-whatsapp"></i>
                        </button>
                        <!-- Delete button for owner -->
                        <button *ngIf="isDiscussionOwner(discussion)"
                                class="btn btn-sm btn-danger delete-discussion-btn" 
                                (click)="deleteDiscussion(discussion, $event)"
                                [attr.aria-label]="'CHAT.DELETE_DISCUSSION' | translate"
                                [ngbTooltip]="'CHAT.DELETE_DISCUSSION' | translate"
                                placement="top">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
