<div class="modal-header">
  <h4 class="modal-title">
    <i class="fa fa-bar-chart"></i>
    {{ 'STATISTICS.TITLE' | translate }}
  </h4>
  <button type="button" class="btn-close" [attr.aria-label]="'STATISTICS.CLOSE' | translate" (click)="close()"></button>
</div>

<div class="modal-body">
  <div *ngIf="isLoading" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">{{ 'STATISTICS.LOADING' | translate }}</p>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    <i class="fa fa-exclamation-triangle"></i>
    {{ error || ('STATISTICS.ERROR' | translate) }}
  </div>

  <div *ngIf="!isLoading && !error" class="statistics-container">
    <div class="statistics-summary mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <p class="text-muted mb-0">
          <i class="fa fa-users"></i>
          {{ 'STATISTICS.TOTAL_USERS' | translate }}: {{ statistics.length }}
        </p>
        <div class="user-filter">
          <label for="userFilter" class="form-label me-2 mb-0">
            <i class="fa fa-filter"></i> {{ 'STATISTICS.FILTER_BY_USER' | translate }}:
          </label>
          <select id="userFilter" 
                  class="form-select form-select-sm d-inline-block" 
                  style="width: auto; min-width: 200px;"
                  [(ngModel)]="selectedUserId"
                  (change)="onUserFilterChange()">
            <option [value]="null">{{ 'STATISTICS.ALL_USERS' | translate }}</option>
            <option *ngFor="let user of allUsers" [value]="user.id">
              {{ user.userName }} 
              <span *ngIf="user.firstName || user.lastName">
                ({{ user.firstName }} {{ user.lastName }})
              </span>
            </option>
          </select>
          <button *ngIf="selectedUserId" 
                  class="btn btn-sm btn-outline-secondary ms-2" 
                  (click)="clearFilter()"
                  type="button">
            <i class="fa fa-times"></i> {{ 'STATISTICS.CLEAR' | translate }}
          </button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>{{ 'STATISTICS.USER' | translate }}</th>
            <th>{{ 'STATISTICS.TOTAL_DISCUSSIONS' | translate }}</th>
            <th>{{ 'STATISTICS.DETAILS' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let stat of statistics">
            <td>
              <strong>{{ stat.userName || ('STATISTICS.UNKNOWN' | translate) }}</strong>
              <br>
              <span *ngIf="stat.firstName || stat.lastName" class="text-muted">
                {{ stat.firstName || '' }} {{ stat.lastName || '' }}
              </span>
              <br>
              <small class="text-muted">{{ 'STATISTICS.ID' | translate }}: {{ stat.userId }}</small>
            </td>
            <td>
              <span class="badge bg-primary">{{ stat.totalDiscussions }}</span>
            </td>
            <td>
              <div class="discussion-details">
                <div *ngFor="let discussion of stat.discussions" class="discussion-item mb-2">
                  <div class="discussion-title">
                    <i class="fa fa-comments"></i>
                    <strong>{{ discussion.discussionTitle }}</strong>
                    <span class="badge bg-secondary ms-2">{{ discussion.type }}</span>
                  </div>
                  <div *ngIf="discussion.eventName" class="text-muted small">
                    <i class="fa fa-calendar"></i> {{ 'STATISTICS.EVENT' | translate }}: {{ discussion.eventName }}
                  </div>
                  <div *ngIf="discussion.friendGroupName" class="text-muted small">
                    <i class="fa fa-users"></i> {{ 'STATISTICS.GROUP' | translate }}: {{ discussion.friendGroupName }}
                  </div>
                  <div class="access-reasons mt-1">
                    <span *ngFor="let reason of discussion.accessReasons" 
                          class="badge bg-info me-1 mb-1">
                      {{ getAccessReasonLabel(reason) }}
                    </span>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-secondary" (click)="close()">{{ 'STATISTICS.CLOSE' | translate }}</button>
  <button type="button" class="btn btn-primary" (click)="loadStatistics(selectedUserId || undefined)" [disabled]="isLoading">
    <i class="fa fa-refresh"></i> {{ 'STATISTICS.REFRESH' | translate }}
  </button>
</div>

