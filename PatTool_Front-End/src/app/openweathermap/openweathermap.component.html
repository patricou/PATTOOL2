<!-- Standard Title Section -->
<div class="pat-title">
    <h2>{{ 'API.TITLE' | translate }}</h2>
    <app-navigation-buttons></app-navigation-buttons>
</div>

<!-- Main Content -->
<div class="container mt-0">
    <div class="row justify-content-center">
        <div class="col-12">
            
            <!-- Messages -->
            <div class="alert alert-danger" *ngIf="errorMessage" role="alert">
                <i class="fa fa-exclamation-circle"></i> {{ errorMessage }}
            </div>
            <div class="alert alert-success" *ngIf="successMessage" role="alert">
                <i class="fa fa-check-circle"></i> {{ successMessage }}
            </div>

            <!-- Current Position Section -->
            <div class="api-container">
                <h3 class="api-title">
                    <i class="fa fa-map-marker"></i> {{ 'API.CURRENT_POSITION' | translate }}
                </h3>
                
                <div class="button-group" style="margin-bottom: 20px;">
                    <button (click)="getUserPosition()" 
                            class="btn btn-secondary btn-weather"
                            [disabled]="isLoadingUserPosition"
                            title="{{ 'API.REPOSITION_TO_USER' | translate }}">
                        <i class="fa" [class.fa-crosshairs]="!isLoadingUserPosition" [class.fa-spinner]="isLoadingUserPosition" [class.fa-spin]="isLoadingUserPosition"></i>
                        <span class="btn-text">{{ 'API.REPOSITION_TO_USER' | translate }}</span>
                    </button>
                    <button (click)="getCurrentWeatherByCoordinates()" 
                            class="btn btn-info btn-weather" 
                            [disabled]="isLoadingCurrentWeather">
                        <i class="fa" [class.fa-map-marker]="!isLoadingCurrentWeather" [class.fa-spinner]="isLoadingCurrentWeather" [class.fa-spin]="isLoadingCurrentWeather"></i>
                        <span class="btn-text">{{ 'API.GET_WEATHER_BY_COORDINATES' | translate }}</span>
                    </button>
                    <button (click)="openTraceViewerForSelection()" 
                            class="btn btn-warning"
                            title="{{ 'API.SELECT_ON_MAP' | translate }}">
                        <i class="fa fa-map"></i>
                        <span class="btn-text">{{ 'API.SELECT_ON_MAP' | translate }}</span>
                    </button>
                    <button (click)="sharePosition()" 
                            class="btn btn-success"
                            title="{{ 'API.SHARE_POSITION' | translate }}">
                        <i class="fa fa-share-alt"></i>
                        <span class="btn-text">{{ 'API.SHARE_POSITION' | translate }}</span>
                    </button>
                </div>
                
                <div class="weather-controls">
                    <div class="form-group">
                        <label for="city">{{ 'API.CITY' | translate }}:</label>
                        <div class="input-group">
                            <input type="text" 
                                   id="city" 
                                   class="form-control" 
                                   [(ngModel)]="city" 
                                   [placeholder]="'API.CITY_PLACEHOLDER' | translate"
                                   (keyup.enter)="searchCityAndGetCoordinates()"
                                   (focus)="closeCitySearchResults()">
                            <button (click)="searchCityAndGetCoordinates()" 
                                    class="btn btn-primary"
                                    [disabled]="isLoadingCitySearch"
                                    title="{{ 'API.SEARCH_CITY' | translate }}">
                                <i class="fa" [class.fa-search]="!isLoadingCitySearch" [class.fa-spinner]="isLoadingCitySearch" [class.fa-spin]="isLoadingCitySearch"></i>
                                <span class="btn-text">{{ 'API.SEARCH_CITY' | translate }}</span>
                            </button>
                        </div>
                        <!-- City search results dropdown -->
                        <div class="city-search-results" *ngIf="showCitySearchResults && citySearchResults.length > 0">
                            <div class="city-search-results-header">
                                <span>{{ 'API.SELECT_CITY' | translate }} ({{ citySearchResults.length }})</span>
                                <button type="button" class="btn-close" (click)="closeCitySearchResults()" title="{{ 'API.CLOSE' | translate }}">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                            <div class="city-search-results-list">
                                <div class="city-search-result-item" 
                                     *ngFor="let result of citySearchResults" 
                                     (click)="selectCityFromResults(result)">
                                    <div class="city-search-result-header">
                                        <div class="city-search-result-name">
                                            <i class="fa fa-map-marker"></i> {{ result.cityName || result.displayName }}
                                        </div>
                                        <div class="city-search-result-country" *ngIf="result.countryCode">
                                            <span class="country-badge">
                                                <span class="country-flag">{{ getCountryFlag(result.countryCode) }}</span>
                                                {{ result.countryCode }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="city-search-result-details">
                                        <div class="city-search-result-address" *ngIf="result.detailedAddress">
                                            <i class="fa fa-home"></i> {{ result.detailedAddress }}
                                        </div>
                                        <div class="city-search-result-info">
                                            <span *ngIf="result.state">
                                                <i class="fa fa-map"></i> {{ result.state }}
                                            </span>
                                            <span *ngIf="result.country">
                                                <i class="fa fa-globe"></i> {{ result.country }}
                                            </span>
                                            <span *ngIf="result.postcode">
                                                <i class="fa fa-envelope"></i> {{ result.postcode }}
                                            </span>
                                        </div>
                                        <div class="city-search-result-coords">
                                            <i class="fa fa-crosshairs"></i>
                                            <small>{{ 'API.LATITUDE' | translate }}: {{ result.lat.toFixed(6) }}, {{ 'API.LONGITUDE' | translate }}: {{ result.lon.toFixed(6) }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="countryCode">{{ 'API.COUNTRY_CODE' | translate }}:</label>
                        <select id="countryCode" 
                                class="form-control country-select" 
                                [(ngModel)]="countryCode"
                                (focus)="closeCitySearchResults()">
                            <option *ngFor="let country of countryCodes" [value]="country.code">
                                {{ country.code ? (getCountryFlag(country.code) + ' ' + country.code + ' - ' + country.name) : country.name }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="weather-controls mt-3">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body" style="padding: 0.75rem;">
                                    <h6 class="card-title" style="font-size: 0.875rem; margin-bottom: 0.5rem;">{{ 'API.LATITUDE' | translate }}</h6>
                                    <input type="text" 
                                           id="lat" 
                                           class="form-control form-control-sm" 
                                           [value]="formatCoordinate(lat)"
                                           (blur)="lat = parseCoordinate($any($event.target).value) || lat"
                                           style="font-size: 0.875rem;">
                                    <div class="mt-2">
                                        <button type="button" 
                                                class="btn btn-xs btn-outline-primary"
                                                (click)="pasteCoordinates()"
                                                (mouseenter)="readClipboardCoordinates()"
                                                [ngbTooltip]="pasteCoordinatesTooltipTemplate"
                                                placement="top"
                                                style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                            <i class="fa fa-paste"></i>
                                        </button>
                                        <ng-template #pasteCoordinatesTooltipTemplate>
                                            <div>
                                                <div>{{ 'API.PASTE_COORDINATES' | translate }}</div>
                                                <div *ngIf="clipboardLat !== null && clipboardLon !== null" style="font-size: 0.85rem; margin-top: 4px; color: #ccc;">
                                                    {{ 'API.LATITUDE' | translate }}: {{ formatCoordinate(clipboardLat) }}, {{ 'API.LONGITUDE' | translate }}: {{ formatCoordinate(clipboardLon) }}
                                                </div>
                                                <div *ngIf="clipboardLat === null || clipboardLon === null" style="font-size: 0.85rem; margin-top: 4px; color: #999; font-style: italic;">
                                                    (Presse-papier vide ou format invalide)
                                                </div>
                                            </div>
                                        </ng-template>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body" style="padding: 0.75rem;">
                                    <h6 class="card-title" style="font-size: 0.875rem; margin-bottom: 0.5rem;">{{ 'API.LONGITUDE' | translate }}</h6>
                                    <input type="text" 
                                           id="lon" 
                                           class="form-control form-control-sm" 
                                           [value]="formatCoordinate(lon)"
                                           (blur)="lon = parseCoordinate($any($event.target).value) || lon"
                                           style="font-size: 0.875rem;">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4" *ngIf="allAltitudes && allAltitudes.length > 0">
                            <div class="card">
                                <div class="card-body" style="padding: 0.75rem;">
                                    <h6 class="card-title" style="font-size: 0.875rem; margin-bottom: 0.5rem;">{{ 'API.ALTITUDE' | translate }}</h6>
                                    <input type="text" 
                                           class="form-control form-control-sm" 
                                           [value]="allAltitudes[0].altitude.toFixed(1)" 
                                           readonly
                                           [title]="getAltitudeSourceDescription(allAltitudes[0].source)"
                                           style="font-size: 0.875rem;">
                                    <small class="text-muted" style="font-size: 0.7rem; margin-top: 3px; display: block;">
                                        <i class="fa fa-info-circle"></i> {{ getAltitudeSourceDescription(allAltitudes[0].source) }}
                                        <span *ngIf="allAltitudes[0].priority === 1" class="badge badge-primary ml-1" style="font-size: 0.65em;">{{ 'API.PRIORITY' | translate }}</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3" *ngIf="allAltitudes && allAltitudes.length > 1">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body" style="padding: 0.75rem;">
                                    <h6 class="card-title" style="font-size: 0.875rem; margin-bottom: 0.5rem;">{{ 'API.ALTITUDE' | translate }} - {{ 'API.AVERAGE' | translate }}</h6>
                                    <input type="text" 
                                           class="form-control form-control-sm" 
                                           [value]="getAverageAltitude() !== null ? getAverageAltitude()!.toFixed(1) : ''" 
                                           readonly
                                           style="font-size: 0.875rem;">
                                    <small class="text-muted" style="font-size: 0.7rem; margin-top: 3px; display: block;">
                                        {{ allAltitudes.length }} {{ 'API.SOURCE' | translate }}(s)
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body" style="padding: 0.75rem;">
                                    <h6 class="card-title" style="font-size: 0.875rem; margin-bottom: 0.5rem;">{{ 'API.ALTITUDE' | translate }} - {{ 'API.SOURCE' | translate }}</h6>
                                    <div class="row">
                                        <div *ngFor="let altInfo of allAltitudes; let i = index" class="col-12" style="margin-bottom: 8px;">
                                            <div class="d-flex align-items-center">
                                                <strong style="min-width: 70px; margin-right: 10px; font-size: 0.875rem;">{{ altInfo.altitude.toFixed(1) }} m</strong>
                                                <span class="text-muted" style="font-size: 0.75rem;">
                                                    <i class="fa fa-info-circle"></i> {{ getAltitudeSourceDescription(altInfo.source) }}
                                                    <span *ngIf="i === 0" class="badge badge-primary ml-1" style="font-size: 0.65em;">{{ 'API.PRIORITY' | translate }}</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Address Display (when available, even without weather data) -->
                <div class="address-display" *ngIf="fullAddress">
                    <div class="address-card">
                        <h4>
                            <i class="fa fa-map-marker"></i>
                            {{ 'API.ADDRESS' | translate }}
                        </h4>
                        <div class="full-address">
                            <i class="fa fa-home"></i>
                            <span>{{ fullAddress }}</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Weather Data Section (separate from position) -->
            <div class="api-container" *ngIf="currentWeather || isLoadingCurrentWeather">
                <h3 class="api-title">
                    <i class="fa fa-cloud"></i> {{ currentWeatherTitle || ('API.CURRENT_WEATHER' | translate) }}
                </h3>
                
                <div class="weather-controls">
                    <!-- Share Current Weather Button -->
                    <button (click)="shareCurrentWeather()" 
                            class="btn btn-info" 
                            *ngIf="currentWeather && !currentWeather.error && !isLoadingCurrentWeather">
                        <i class="fa fa-share-alt"></i>
                        <span class="btn-text">{{ 'API.SHARE_CURRENT_WEATHER' | translate }}</span>
                    </button>
                </div>
                
                <!-- Current Weather Results -->
                <div class="weather-results" *ngIf="isLoadingCurrentWeather">
                    <div class="weather-card">
                        <div class="weather-loading">
                            <i class="fa fa-spinner fa-spin"></i>
                            <span>{{ 'API.LOADING' | translate }}...</span>
                        </div>
                    </div>
                </div>
                <div class="weather-results" *ngIf="currentWeather && !currentWeather.error && !isLoadingCurrentWeather">
                    <div class="weather-card">
                        <h4>
                            <img [src]="getWeatherIconUrl(currentWeather.weather?.[0]?.icon)" 
                                 [alt]="currentWeather.weather?.[0]?.description"
                                 *ngIf="currentWeather.weather?.[0]?.icon">
                            {{ city }}, {{ countryCode }}
                        </h4>
                        
                        <!-- Weather Condition Highlight -->
                        <div class="weather-condition-highlight" *ngIf="currentWeather.weather?.[0]?.description">
                            <div class="weather-condition-main">
                                <img [src]="getWeatherIconUrl(currentWeather.weather?.[0]?.icon)" 
                                     [alt]="currentWeather.weather?.[0]?.description"
                                     class="weather-condition-icon-large"
                                     *ngIf="currentWeather.weather?.[0]?.icon">
                                <div class="weather-condition-text">
                                    <div class="weather-condition-temp">{{ formatTemperature(currentWeather.main?.temp) }}</div>
                                    <div class="weather-condition-desc">{{ currentWeather.weather?.[0]?.description | titlecase }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="weather-details">
                            <div class="detail-item">
                                <i class="fa fa-thermometer-half weather-detail-icon"></i>
                                <strong>{{ 'API.TEMPERATURE' | translate }}:</strong> {{ formatTemperature(currentWeather.main?.temp) }}
                            </div>
                            <div class="detail-item">
                                <i class="fa fa-thermometer weather-detail-icon"></i>
                                <strong>{{ 'API.FEELS_LIKE' | translate }}:</strong> {{ formatTemperature(currentWeather.main?.feels_like) }}
                            </div>
                            <div class="detail-item">
                                <img [src]="getWeatherIconUrl(currentWeather.weather?.[0]?.icon)" 
                                     [alt]="currentWeather.weather?.[0]?.description"
                                     class="weather-detail-icon-small"
                                     *ngIf="currentWeather.weather?.[0]?.icon">
                                <strong>{{ 'API.DESCRIPTION' | translate }}:</strong> {{ currentWeather.weather?.[0]?.description }}
                            </div>
                            <div class="detail-item">
                                <i class="fa fa-tint weather-detail-icon"></i>
                                <strong>{{ 'API.HUMIDITY' | translate }}:</strong> {{ currentWeather.main?.humidity }}%
                            </div>
                            <div class="detail-item">
                                <i class="fa fa-compress weather-detail-icon"></i>
                                <strong>{{ 'API.PRESSURE' | translate }}:</strong> {{ currentWeather.main?.pressure }} hPa
                            </div>
                            <div class="detail-item">
                                <i class="fa fa-wind weather-detail-icon"></i>
                                <strong>{{ 'API.WIND_SPEED' | translate }}:</strong> {{ currentWeather.wind?.speed }} m/s
                            </div>
                            <div class="detail-item">
                                <i class="fa fa-eye weather-detail-icon"></i>
                                <strong>{{ 'API.VISIBILITY' | translate }}:</strong> {{ currentWeather.visibility ? (currentWeather.visibility / 1000).toFixed(1) + ' km' : ('API.N_A' | translate) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forecast Section -->
            <div class="api-container" style="margin-top: 10px;">
                <h3 class="api-title">
                    <i class="fa fa-calendar"></i> {{ forecastTitle || ('API.FORECAST' | translate) }}
                </h3>
                
                <div class="weather-controls">
                    <button (click)="getForecast()" 
                            class="btn btn-success" 
                            [disabled]="isLoadingForecast">
                        <i class="fa" [class.fa-calendar]="!isLoadingForecast" [class.fa-spinner]="isLoadingForecast" [class.fa-spin]="isLoadingForecast"></i>
                        <span class="btn-text">{{ 'API.GET_FORECAST' | translate }}</span>
                    </button>
                    
                    <!-- Share Forecast Button -->
                    <button (click)="shareForecast()" 
                            class="btn btn-info btn-sm" 
                            *ngIf="forecast && !forecast.error && displayForecastList && displayForecastList.length > 0"
                            style="margin-left: 10px;">
                        <i class="fa fa-share-alt"></i>
                        <span class="btn-text">{{ 'API.SHARE_FORECAST' | translate }}</span>
                    </button>
                    
                    <!-- Forecast Display Mode Selection -->
                    <div class="forecast-mode-selection" *ngIf="forecast && forecast.list && forecast.list.length > 0">
                        <label class="mode-selection-label">{{ 'API.FORECAST_MODE' | translate }}:</label>
                        <div class="mode-buttons">
                            <button type="button" 
                                    class="btn btn-sm mode-btn"
                                    [class.btn-primary]="forecastDisplayMode === 'hourly'"
                                    [class.btn-outline-primary]="forecastDisplayMode !== 'hourly'"
                                    (click)="setForecastDisplayMode('hourly')"
                                    title="{{ 'API.FORECAST_3H' | translate }}">
                                {{ 'API.FORECAST_3H' | translate }}
                            </button>
                            <button type="button" 
                                    class="btn btn-sm mode-btn"
                                    [class.btn-primary]="forecastDisplayMode === 'daily'"
                                    [class.btn-outline-primary]="forecastDisplayMode !== 'daily'"
                                    (click)="setForecastDisplayMode('daily')"
                                    title="{{ 'API.FORECAST_DAILY' | translate }}">
                                {{ 'API.FORECAST_DAILY' | translate }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Forecast Results -->
                <div class="forecast-results" *ngIf="forecast && !forecast.error">
                    <div class="forecast-header">
                        <small class="text-muted" *ngIf="forecast && forecast.city">
                            {{ 'API.FORECAST_FOR' | translate }} {{ forecast.city?.name }}, {{ forecast.city?.country }}
                        </small>
                        <small class="text-muted forecast-mode-info" *ngIf="displayForecastList.length > 0">
                            <span *ngIf="forecastDisplayMode === 'hourly'">({{ 'API.FORECAST_3H_INFO' | translate }})</span>
                            <span *ngIf="forecastDisplayMode === 'daily'">({{ 'API.FORECAST_DAILY_INFO' | translate }})</span>
                        </small>
                    </div>
                    
                    <div class="forecast-grid">
                        <div class="forecast-card" *ngFor="let item of displayForecastList">
                            <div class="forecast-card-header">
                                <div class="forecast-time">{{ formatDate(item.dt) }}</div>
                                <img [src]="getWeatherIconUrl(item.weather?.[0]?.icon)" 
                                     [alt]="item.weather?.[0]?.description"
                                     class="forecast-icon-small"
                                     *ngIf="item.weather?.[0]?.icon">
                            </div>
                            <div class="forecast-card-body">
                                <div class="forecast-temp-main" *ngIf="forecastDisplayMode === 'hourly'">
                                    {{ formatTemperature(item.main?.temp) }}
                                </div>
                                <div class="forecast-temp-daily" *ngIf="forecastDisplayMode === 'daily'">
                                    <div class="forecast-temp-max">{{ formatTemperature(item.main?.temp_max) }}</div>
                                    <div class="forecast-temp-min">{{ formatTemperature(item.main?.temp_min) }}</div>
                                </div>
                                <div class="forecast-desc-small">{{ item.weather?.[0]?.description }}</div>
                                <div class="forecast-meta">
                                    <span class="forecast-meta-item"><i class="fa fa-tint"></i> {{ Math.round(item.main?.humidity) }}%</span>
                                    <span class="forecast-meta-item"><i class="fa fa-wind"></i> {{ item.wind?.speed?.toFixed(1) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Temperature Chart -->
                    <div class="temperature-chart-container" *ngIf="displayForecastList && displayForecastList.length > 0">
                        <canvas baseChart
                                [data]="temperatureChartData"
                                [options]="temperatureChartOptions"
                                type="line">
                        </canvas>
                    </div>
                </div>
            </div>

            <!-- API Status Section (at the end) -->
            <div class="api-container" *ngIf="apiStatus || nominatimStatus || openElevationStatus" style="margin-top: 20px;">
                <h3 class="api-title">
                    <i class="fa fa-info-circle"></i> {{ 'API.STATUS_APIS' | translate }}
                </h3>
                
                <!-- OpenWeatherMap Status -->
                <div class="status-card" *ngIf="apiStatus">
                    <p><strong>{{ 'API.SERVICE' | translate }}:</strong> {{ apiStatus.service }}</p>
                    <p><strong>{{ 'API.STATUS_LABEL' | translate }}:</strong> 
                        <span class="badge" [class.badge-success]="apiStatus.status === 'available'" 
                              [class.badge-danger]="apiStatus.status !== 'available'">
                            {{ apiStatus.status }}
                        </span>
                    </p>
                </div>
                
                <!-- Nominatim Status -->
                <div class="status-card" *ngIf="nominatimStatus" style="margin-top: 10px;">
                    <p><strong>{{ 'API.SERVICE' | translate }}:</strong> {{ nominatimStatus.service }}</p>
                    <p><strong>{{ 'API.STATUS_LABEL' | translate }}:</strong> 
                        <span class="badge" [class.badge-success]="nominatimStatus.status === 'available'" 
                              [class.badge-danger]="nominatimStatus.status !== 'available'">
                            {{ nominatimStatus.status }}
                        </span>
                    </p>
                </div>
                
                <!-- OpenElevation Status -->
                <div class="status-card" *ngIf="openElevationStatus" style="margin-top: 10px;">
                    <p><strong>{{ 'API.SERVICE' | translate }}:</strong> {{ openElevationStatus.service }}</p>
                    <p><strong>{{ 'API.STATUS_LABEL' | translate }}:</strong> 
                        <span class="badge" [class.badge-success]="openElevationStatus.status === 'available'" 
                              [class.badge-danger]="openElevationStatus.status !== 'available'">
                            {{ openElevationStatus.status }}
                        </span>
                    </p>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Trace Viewer Modal -->
<app-trace-viewer-modal 
    #traceViewerModalComponent
    (locationSelected)="onLocationSelected($event)">
</app-trace-viewer-modal>
