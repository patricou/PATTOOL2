<div class="friends-container">
  <!-- Header Section -->
  <div class="pat-title">
    <h2>{{ 'FRIENDS.TITLE' | translate }}</h2>
    <app-navigation-buttons></app-navigation-buttons>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
    <i class="fa fa-exclamation-triangle"></i>
    {{ errorMessage }}
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="text-center">
    <i class="fa fa-spinner fa-spin fa-3x"></i>
    <p>{{ 'FRIENDS.LOADING' | translate }}</p>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'users'"
        (click)="setActiveTab('users')"
        type="button">
        <i class="fa fa-user-plus"></i>
        {{ 'FRIENDS.ALL_USERS' | translate }}
        <span *ngIf="allUsers.length > 0" class="badge bg-primary">{{ allUsers.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'requests'"
        (click)="setActiveTab('requests')"
        type="button">
        <i class="fa fa-envelope"></i>
        {{ 'FRIENDS.REQUESTS' | translate }}
        <span class="badge bg-danger">{{ pendingRequests.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'friends'"
        (click)="setActiveTab('friends')"
        type="button">
        <i class="fa fa-heart"></i>
        {{ 'FRIENDS.MY_FRIENDS' | translate }}
        <span *ngIf="friends.length > 0" class="badge bg-success">{{ friends.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'groups'"
        (click)="setActiveTab('groups')"
        type="button">
        <i class="fa fa-users"></i>
        {{ 'FRIENDS.FRIEND_GROUPS' | translate }}
        <span *ngIf="friendGroups.length > 0" class="badge bg-info">{{ friendGroups.length }}</span>
      </button>
    </li>
  </ul>

  <!-- Tab Content: All Users -->
  <div *ngIf="activeTab === 'users'" class="tab-content">
    <!-- Invite by Email Section -->
    <div class="invite-section mb-2 p-3 bg-light rounded">
      <h5><i class="fa fa-envelope"></i> {{ 'FRIENDS.INVITE_BY_EMAIL' | translate }}</h5>
      <div class="d-flex gap-2 mb-2 flex-wrap">
        <div class="input-group flex-grow-1" style="min-width: 250px;">
          <span class="input-group-text">
            <i class="fa fa-at"></i>
          </span>
          <input 
            type="email" 
            class="form-control" 
            [(ngModel)]="inviteEmail"
            (blur)="checkEmailExists()"
            (keyup.enter)="checkEmailExists()"
            [placeholder]="'FRIENDS.ENTER_EMAIL' | translate"
            [disabled]="checkingEmail || sendingInvite">
          <button 
            class="btn btn-outline-secondary" 
            type="button"
            (click)="checkEmailExists()"
            [disabled]="!inviteEmail || checkingEmail || sendingInvite">
            <i class="fa fa-search" *ngIf="!checkingEmail"></i>
            <i class="fa fa-spinner fa-spin" *ngIf="checkingEmail"></i>
            {{ 'FRIENDS.CHECK_EMAIL' | translate }}
          </button>
        </div>
        <div class="input-group flex-grow-1" style="min-width: 250px;">
          <span class="input-group-text">
            <i class="fa fa-search"></i>
          </span>
          <input 
            type="text" 
            class="form-control" 
            [(ngModel)]="searchFilter"
            [placeholder]="'FRIENDS.SEARCH_PLACEHOLDER' | translate">
        </div>
      </div>
      
      <!-- Email Check Result -->
      <div *ngIf="emailCheckResult !== null" class="mt-2">
        <div *ngIf="emailExists" class="alert alert-info">
          <i class="fa fa-info-circle"></i>
          {{ 'FRIENDS.EMAIL_EXISTS' | translate }}
          <span *ngIf="emailCheckResult.userName"> ({{ emailCheckResult.userName }})</span>
        </div>
        <div *ngIf="!emailExists" class="alert alert-success">
          <i class="fa fa-check-circle"></i>
          {{ 'FRIENDS.EMAIL_NOT_REGISTERED' | translate }}
          <button 
            *ngIf="!showCustomMessagePrompt && !showCustomMessageInput"
            class="btn btn-success btn-sm ms-2"
            (click)="sendInvitation()"
            [disabled]="sendingInvite">
            <i class="fa fa-paper-plane" *ngIf="!sendingInvite"></i>
            <i class="fa fa-spinner fa-spin" *ngIf="sendingInvite"></i>
            {{ 'FRIENDS.INVITE_TO_PATTOOL' | translate }}
          </button>
        </div>
        
        <!-- Custom Message Prompt -->
        <div *ngIf="showCustomMessagePrompt && !emailExists" class="alert alert-info mt-2">
          <i class="fa fa-question-circle"></i>
          <strong>{{ 'FRIENDS.ADD_CUSTOM_MESSAGE' | translate }}</strong>
          <div class="mt-2 d-flex gap-2">
            <button 
              class="btn btn-primary btn-sm"
              (click)="confirmAddCustomMessage()">
              <i class="fa fa-check"></i>
              {{ 'FRIENDS.YES' | translate }}
            </button>
            <button 
              class="btn btn-secondary btn-sm"
              (click)="skipCustomMessage()"
              [disabled]="sendingInvite">
              <i class="fa fa-times"></i>
              {{ 'FRIENDS.NO' | translate }}
            </button>
          </div>
        </div>
        
        <!-- Custom Message Input -->
        <div *ngIf="showCustomMessageInput && !emailExists" class="alert alert-info mt-2">
          <div class="mb-2">
            <label for="customMessage" class="form-label">
              <i class="fa fa-envelope"></i>
              <strong>{{ 'FRIENDS.CUSTOM_MESSAGE' | translate }}</strong>
            </label>
            <textarea 
              id="customMessage"
              class="form-control" 
              rows="4"
              [(ngModel)]="customMessage"
              [placeholder]="'FRIENDS.CUSTOM_MESSAGE_PLACEHOLDER' | translate"
              [disabled]="sendingInvite"></textarea>
          </div>
          <div class="d-flex gap-2">
            <button 
              class="btn btn-success btn-sm"
              (click)="sendInvitation()"
              [disabled]="sendingInvite || !customMessage.trim()">
              <i class="fa fa-paper-plane" *ngIf="!sendingInvite"></i>
              <i class="fa fa-spinner fa-spin" *ngIf="sendingInvite"></i>
              {{ 'FRIENDS.SEND_INVITATION' | translate }}
            </button>
            <button 
              class="btn btn-secondary btn-sm"
              (click)="cancelCustomMessage()"
              [disabled]="sendingInvite">
              <i class="fa fa-times"></i>
              {{ 'FRIENDS.CANCEL' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="users-list">
      <div *ngFor="let user of getFilteredUsers()" class="user-card compact-user-card">
        <!-- Card Header with User Name -->
        <div class="user-header">
          <h6 class="mb-0" style="display: flex; justify-content: space-between; align-items: center;">
            <span>
              <i class="fa fa-user-circle me-2"></i>
              {{ user.firstName }} {{ user.lastName }}
            </span>
            <span class="status-indicator" 
                  [style.background-color]="getUserOnlineStatus(user.id).online ? '#28a745' : '#ffffff'"
                  [style.border]="getUserOnlineStatus(user.id).online ? '2px solid #28a745' : '2px solid #6c757d'"
                  style="width: 12px; height: 12px; border-radius: 50%; display: inline-block; flex-shrink: 0;"></span>
          </h6>
        </div>
        <div class="user-info">
          <div class="user-details">
            <p class="text-muted compact-text mb-1">
              <i class="fa fa-at"></i> {{ user.userName }}
            </p>
            <p class="text-muted compact-text mb-1">
              <i class="fa fa-envelope"></i> {{ user.addressEmail }}
            </p>
            <p class="text-muted compact-text mb-1" *ngIf="user.registrationDate">
              <i class="fa fa-calendar-plus-o"></i> 
              {{ user.registrationDate | date:'short' }}
            </p>
            <p class="text-muted compact-text mb-1" *ngIf="user.lastConnectionDate">
              <i class="fa fa-clock-o"></i> 
              {{ user.lastConnectionDate | date:'short' }}
            </p>
            <div class="text-muted compact-text mb-1" *ngIf="getUserRoles(user) && getUserRoles(user).length > 0">
              <i class="fa fa-shield"></i> 
              {{ 'FRIENDS.ROLE' | translate }}: 
              <span *ngFor="let role of getUserRoles(user); let last = last">
                <span class="badge me-1" [ngClass]="getRoleBadgeClass(role)">{{ role }}</span>
              </span>
            </div>
            <p class="text-muted compact-text mb-1" *ngIf="getUserStatus(user) === 'sent' && getSentRequestDate(user)">
              <i class="fa fa-paper-plane"></i>
              {{ 'FRIENDS.REQUEST_SENT' | translate }}: {{ getSentRequestDate(user) | date:'short' }}
            </p>
            <p class="text-muted compact-text mb-1" *ngIf="getUserStatus(user) === 'friend' && getFriendshipDate(user)">
              <i class="fa fa-heart"></i>
              {{ 'FRIENDS.FRIENDS_SINCE' | translate }}: {{ getFriendshipDate(user) | date:'short' }}
            </p>
            <div class="compact-text mb-1" *ngIf="hasAdminRole()" style="color: #007bff;">
              <i class="fa fa-id-card"></i> 
              ID: {{ user.id }}
            </div>
            <div class="compact-text mb-1" *ngIf="hasAdminRole() && user.keycloakId" style="color: #007bff;">
              <i class="fa fa-key"></i> 
              Keycloak ID: {{ user.keycloakId }}
            </div>
          </div>
        </div>
        <div class="user-actions">
          <button 
            *ngIf="getUserStatus(user) === 'none'"
            class="btn btn-primary btn-xs compact-btn"
            (click)="sendFriendRequest(user.id)">
            <i class="fa fa-user-plus"></i>
            <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.SEND_REQUEST' | translate }}</span>
          </button>
          <button 
            *ngIf="getUserStatus(user) === 'pending'"
            class="btn btn-warning btn-xs compact-btn"
            disabled>
            <i class="fa fa-clock"></i>
            <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.PENDING_REQUEST' | translate }}</span>
          </button>
          <button 
            *ngIf="getUserStatus(user) === 'sent'"
            class="btn btn-info btn-xs compact-btn"
            (click)="resendFriendRequest(user.id)"
            title="{{ 'FRIENDS.RESEND_REQUEST' | translate }}">
            <i class="fa fa-paper-plane"></i>
            <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.RESEND_REQUEST' | translate }}</span>
          </button>
          <span 
            *ngIf="getUserStatus(user) === 'friend'"
            class="badge bg-success compact-badge">
            <i class="fa fa-check"></i>
            {{ 'FRIENDS.FRIEND' | translate }}
          </span>
        </div>
        
        <!-- Custom Message Prompt for Friend Request -->
        <div *ngIf="friendRequestMessagePrompts.get(user.id) && (getUserStatus(user) === 'none' || getUserStatus(user) === 'sent')" class="alert alert-info mt-2">
          <i class="fa fa-question-circle"></i>
          <strong>{{ 'FRIENDS.ADD_CUSTOM_MESSAGE' | translate }}</strong>
          <div class="mt-2 d-flex gap-2">
            <button 
              class="btn btn-primary btn-sm"
              (click)="confirmAddFriendRequestMessage(user.id)">
              <i class="fa fa-check"></i>
              {{ 'FRIENDS.YES' | translate }}
            </button>
            <button 
              class="btn btn-secondary btn-sm"
              (click)="skipFriendRequestMessage(user.id)"
              [disabled]="loading">
              <i class="fa fa-times"></i>
              {{ 'FRIENDS.NO' | translate }}
            </button>
          </div>
        </div>
        
        <!-- Custom Message Input for Friend Request -->
        <div *ngIf="friendRequestMessageInputs.get(user.id) && (getUserStatus(user) === 'none' || getUserStatus(user) === 'sent')" class="alert alert-info mt-2">
          <div class="mb-2">
            <label [for]="'friendRequestMessage-' + user.id" class="form-label">
              <i class="fa fa-envelope"></i>
              <strong>{{ 'FRIENDS.CUSTOM_MESSAGE' | translate }}</strong>
            </label>
            <textarea 
              [id]="'friendRequestMessage-' + user.id"
              class="form-control" 
              rows="4"
              [value]="getFriendRequestMessage(user.id)"
              (input)="setFriendRequestMessage(user.id, $any($event.target).value)"
              [placeholder]="'FRIENDS.CUSTOM_MESSAGE_PLACEHOLDER' | translate"
              [disabled]="loading"></textarea>
          </div>
          <div class="d-flex gap-2">
            <button 
              class="btn btn-success btn-sm"
              (click)="sendFriendRequest(user.id)"
              [disabled]="loading || !getFriendRequestMessage(user.id)?.trim()">
              <i class="fa fa-paper-plane" *ngIf="!loading"></i>
              <i class="fa fa-spinner fa-spin" *ngIf="loading"></i>
              <span *ngIf="getUserStatus(user) === 'none'">{{ 'FRIENDS.SEND_REQUEST' | translate }}</span>
              <span *ngIf="getUserStatus(user) === 'sent'">{{ 'FRIENDS.RESEND_REQUEST' | translate }}</span>
            </button>
            <button 
              class="btn btn-secondary btn-sm"
              (click)="cancelFriendRequestMessage(user.id)"
              [disabled]="loading">
              <i class="fa fa-times"></i>
              {{ 'FRIENDS.CANCEL' | translate }}
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="getFilteredUsers().length === 0" class="no-results">
        <i class="fa fa-search fa-3x"></i>
        <p>{{ 'FRIENDS.NO_USERS_FOUND' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Tab Content: Friend Requests -->
  <div *ngIf="activeTab === 'requests'" class="tab-content">
    <div *ngIf="pendingRequests.length === 0" class="no-results">
      <i class="fa fa-inbox fa-3x"></i>
      <p>{{ 'FRIENDS.NO_PENDING_REQUESTS' | translate }}</p>
    </div>

    <div *ngIf="pendingRequests.length > 0" class="requests-list">
      <div *ngFor="let request of getSortedPendingRequests()" class="request-card compact-user-card">
        <!-- Card Header with User Name -->
        <div class="request-header">
          <h6 class="mb-0">
            <i class="fa fa-user-circle me-2"></i>
            {{ request.requester.firstName }} {{ request.requester.lastName }}
          </h6>
        </div>
        <div class="request-info">
          <div class="request-details">
            <p class="text-muted compact-text mb-1">
              <i class="fa fa-at"></i> {{ request.requester.userName }}
            </p>
            <p class="text-muted compact-text mb-1" *ngIf="request.requester.registrationDate">
              <i class="fa fa-calendar-plus-o"></i> 
              {{ request.requester.registrationDate | date:'short' }}
            </p>
            <p class="text-muted compact-text mb-1">
              <i class="fa fa-clock"></i>
              {{ request.requestDate | date:'short' }}
            </p>
            <div *ngIf="request.message" class="alert alert-info compact-text mb-0 mt-2">
              <i class="fa fa-envelope me-1"></i>
              <strong>{{ 'FRIENDS.CUSTOM_MESSAGE' | translate }}:</strong>
              <p class="mb-0 mt-1" style="white-space: pre-wrap;">{{ request.message }}</p>
            </div>
          </div>
        </div>
        <div class="request-actions">
          <button 
            class="btn btn-success btn-xs compact-btn"
            (click)="approveRequest(request.id)">
            <i class="fa fa-check"></i>
            <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.APPROVE' | translate }}</span>
          </button>
          <button 
            class="btn btn-danger btn-xs compact-btn"
            (click)="rejectRequest(request.id)">
            <i class="fa fa-times"></i>
            <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.REJECT' | translate }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content: My Friends -->
  <div *ngIf="activeTab === 'friends'" class="tab-content">
    <div *ngIf="friends.length === 0" class="no-results">
      <i class="fa fa-user-friends fa-3x"></i>
      <p>{{ 'FRIENDS.NO_FRIENDS' | translate }}</p>
    </div>

    <div *ngIf="friends.length > 0" class="friends-list">
      <div *ngFor="let friend of getSortedFriends()" class="friend-card compact-user-card">
        <!-- Card Header with User Name -->
        <div class="friend-header">
          <h6 class="mb-0" style="display: flex; justify-content: space-between; align-items: center;">
            <span>
              <i class="fa fa-user-circle me-2"></i>
              {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }}
            </span>
            <span class="status-indicator" 
                  [style.background-color]="getUserOnlineStatus(getOtherUser(friend).id).online ? '#28a745' : '#ffffff'"
                  [style.border]="getUserOnlineStatus(getOtherUser(friend).id).online ? '2px solid #28a745' : '2px solid #6c757d'"
                  style="width: 12px; height: 12px; border-radius: 50%; display: inline-block; flex-shrink: 0;"></span>
          </h6>
        </div>
        <div class="friend-info">
          <div class="friend-details">
            <p class="text-muted compact-text mb-1">
              <i class="fa fa-at"></i> {{ getOtherUser(friend).userName }}
            </p>
            <p class="text-muted compact-text mb-1" *ngIf="getOtherUser(friend).registrationDate">
              <i class="fa fa-calendar-plus-o"></i> 
              {{ getOtherUser(friend).registrationDate | date:'short' }}
            </p>
            <p class="text-muted compact-text mb-1" *ngIf="getOtherUser(friend).lastConnectionDate">
              <i class="fa fa-clock-o"></i> 
              {{ getOtherUser(friend).lastConnectionDate | date:'short' }}
            </p>
            <p class="text-muted compact-text mb-0">
              <i class="fa fa-heart"></i>
              {{ 'FRIENDS.FRIENDS_SINCE' | translate }}: {{ friend.friendshipDate | date:'short' }}
            </p>
          </div>
        </div>
        <div class="friend-actions">
          <button 
            class="btn btn-danger btn-xs compact-btn"
            (click)="removeFriend(friend.id)">
            <i class="fa fa-user-times"></i>
            <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.REMOVE_FRIEND' | translate }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content: Friend Groups -->
  <div *ngIf="activeTab === 'groups'" class="tab-content">
    <div class="mb-3">
      <button 
        *ngIf="!isCreatingGroup && !editingGroupId"
        class="btn btn-primary"
        (click)="startCreatingGroup()">
        <i class="fa fa-plus"></i>
        {{ 'FRIENDS.CREATE_GROUP' | translate }}
      </button>
    </div>

    <!-- Create Group Form -->
    <div *ngIf="isCreatingGroup" class="card mb-3">
      <div class="card-header">
        <h5>{{ 'FRIENDS.CREATE_NEW_GROUP' | translate }}</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="newGroupName" class="form-label">{{ 'FRIENDS.GROUP_NAME' | translate }}</label>
          <input 
            type="text" 
            class="form-control" 
            id="newGroupName"
            [(ngModel)]="newGroupName"
            [placeholder]="'FRIENDS.ENTER_GROUP_NAME' | translate">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ 'FRIENDS.SELECT_MEMBERS' | translate }}</label>
          <div *ngIf="friends.length === 0" class="alert alert-info">
            {{ 'FRIENDS.NO_FRIENDS_TO_ADD' | translate }}
          </div>
          <div *ngIf="friends.length > 0" class="friends-selection">
            <div *ngFor="let friend of friends" class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                [id]="'friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                [checked]="isMemberSelected(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                (change)="toggleGroupMember(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
              <label 
                class="form-check-label" 
                [for]="'friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }} ({{ getOtherUser(friend).userName }})
              </label>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-success" (click)="createFriendGroup()" [disabled]="loading">
            <i class="fa fa-check"></i>
            {{ 'FRIENDS.CREATE' | translate }}
          </button>
          <button class="btn btn-secondary" (click)="cancelCreatingGroup()" [disabled]="loading">
            <i class="fa fa-times"></i>
            {{ 'FRIENDS.CANCEL' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Search Filter for Groups -->
    <div *ngIf="!isCreatingGroup && !editingGroupId" class="search-container mb-3">
      <div class="input-group">
        <span class="input-group-text">
          <i class="fa fa-search"></i>
        </span>
        <input 
          type="text" 
          class="form-control" 
          [(ngModel)]="searchFilter"
          [placeholder]="'FRIENDS.SEARCH_GROUPS_PLACEHOLDER' | translate">
      </div>
    </div>

    <!-- Groups List -->
    <div *ngIf="getFilteredGroups().length === 0 && !isCreatingGroup && friendGroups.length === 0" class="no-results">
      <i class="fa fa-users fa-3x"></i>
      <p>{{ 'FRIENDS.NO_GROUPS' | translate }}</p>
    </div>

    <!-- No Results from Filter -->
    <div *ngIf="friendGroups.length > 0 && getFilteredGroups().length === 0 && !isCreatingGroup" class="no-results">
      <i class="fa fa-search fa-3x"></i>
      <p>{{ 'FRIENDS.NO_GROUPS_FOUND' | translate }}</p>
    </div>

    <div *ngIf="getFilteredGroups().length > 0" class="groups-list">
      <div *ngFor="let group of getFilteredGroups()" class="group-card card mb-2">
        <!-- Card Header with Group Name -->
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fa fa-users me-2"></i>
            {{ group.name }}
          </h5>
        </div>
        <div class="card-body compact-card-body">
          <!-- Badge at the top of the card -->
          <div class="d-flex justify-content-center mb-2">
            <div *ngIf="isGroupOwner(group)" class="badge bg-success compact-badge">
              <i class="fa fa-crown"></i>
              {{ 'FRIENDS.OWNER' | translate }}
            </div>
            <div *ngIf="isGroupAuthorized(group)" class="badge bg-info compact-badge">
              <i class="fa fa-user-check"></i>
              {{ 'FRIENDS.AUTHORIZED_TO_USE' | translate }}
            </div>
            <div *ngIf="isGroupMember(group)" class="badge bg-secondary compact-badge">
              <i class="fa fa-user"></i>
              {{ 'FRIENDS.MEMBER' | translate }}
            </div>
          </div>
          <div *ngIf="editingGroupId !== group.id">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <!-- Action buttons for owner - Top of card -->
                <div *ngIf="isGroupOwner(group)" class="d-flex gap-1 mb-2 justify-content-center">
                  <button 
                    class="btn btn-outline-primary btn-xs compact-btn"
                    (click)="startEditingGroup(group)"
                    title="{{ 'FRIENDS.EDIT' | translate }}">
                    <i class="fa fa-edit"></i>
                    <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.EDIT' | translate }}</span>
                  </button>
                  <button 
                    class="btn btn-outline-danger btn-xs compact-btn"
                    (click)="deleteFriendGroup(group.id)"
                    title="{{ 'FRIENDS.DELETE' | translate }}">
                    <i class="fa fa-trash"></i>
                    <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.DELETE' | translate }}</span>
                  </button>
                </div>
                <!-- Discussion and WhatsApp Buttons - Below action buttons -->
                <div class="d-flex justify-content-center gap-1 mb-2 flex-wrap">
                  <!-- Discussion Button -->
                  <button 
                    class="btn btn-primary btn-xs compact-btn"
                    (click)="openDiscussionModal(group); $event.stopPropagation()"
                    title="Open Discussion">
                    <i class="fa fa-comments me-1"></i>
                    Discussion
                  </button>
                  <!-- WhatsApp Button (if link exists) -->
                  <button 
                    *ngIf="hasWhatsAppLink(group)"
                    class="btn btn-success btn-xs compact-btn"
                    (click)="openWhatsAppLink(group); $event.stopPropagation()"
                    title="Open WhatsApp Group">
                    <i class="fa fa-whatsapp me-1"></i>
                    WhatsApp
                  </button>
                </div>
                <!-- Discussion Link Display (if exists) -->
                <div *ngIf="group.discussionId" class="mb-2">
                  <p class="text-muted compact-text mb-0">
                    <i class="fa fa-comments me-1"></i>
                    <strong>Discussion:</strong> 
                    <a 
                      href="#" 
                      (click)="openDiscussionModal(group); $event.preventDefault()" 
                      class="text-decoration-none text-primary"
                      title="Click to open discussion">
                      {{ group.discussionId }}
                    </a>
                  </p>
                </div>
                <p class="text-muted compact-text mb-1">
                  <i class="fa fa-crown"></i>
                  <strong>{{ 'FRIENDS.GROUP_OWNER' | translate }}:</strong> {{ group.owner.firstName }} {{ group.owner.lastName }} (<i class="fa fa-at"></i> {{ group.owner.userName }})
                </p>
                <p class="text-muted compact-text mb-2">
                  <i class="fa fa-calendar"></i>
                  {{ group.creationDate | date:'short' }}
                </p>
                <div class="members-section mt-2">
                  <h6 class="compact-subtitle mb-1">
                    <i class="fa fa-users"></i>
                    {{ group.members.length }} {{ 'FRIENDS.MEMBERS' | translate }}
                  </h6>
                  <div *ngIf="group.members.length === 0" class="text-muted compact-text">
                    {{ 'FRIENDS.NO_MEMBERS' | translate }}
                  </div>
                  <div *ngIf="group.members.length > 0" class="members-list mt-1">
                    <div *ngFor="let member of group.members" class="member-item compact-member p-1 mb-1 border rounded">
                      <div class="d-flex align-items-center">
                        <div class="user-avatar me-2">
                          <i class="fa fa-user-circle compact-avatar text-muted"></i>
                        </div>
                        <div class="member-details flex-grow-1">
                          <div class="compact-text fw-bold">{{ member.firstName }} {{ member.lastName }}</div>
                          <div class="text-muted compact-text">
                            <i class="fa fa-at"></i> {{ member.userName }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Authorized Users Section (only for owner) -->
                <div *ngIf="isGroupOwner(group)" class="authorized-users-section mt-2">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6 class="compact-subtitle mb-0">
                      <i class="fa fa-user-check"></i>
                      {{ 'FRIENDS.AUTHORIZED_USERS' | translate }}
                      <span *ngIf="group.authorizedUsers && group.authorizedUsers.length > 0" class="badge bg-info compact-badge">
                        {{ group.authorizedUsers.length }}
                      </span>
                    </h6>
                    <button 
                      *ngIf="managingAuthorizedUsersGroupId !== group.id"
                      class="btn btn-xs btn-outline-primary compact-btn"
                      (click)="startManagingAuthorizedUsers(group)">
                      <i class="fa fa-edit"></i>
                      <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.MANAGE' | translate }}</span>
                    </button>
                  </div>
                  <div *ngIf="managingAuthorizedUsersGroupId !== group.id">
                    <div *ngIf="!group.authorizedUsers || group.authorizedUsers.length === 0" class="text-muted compact-text">
                      {{ 'FRIENDS.NO_AUTHORIZED_USERS' | translate }}
                    </div>
                    <div *ngIf="group.authorizedUsers && group.authorizedUsers.length > 0" class="authorized-users-list mt-1">
                      <div *ngFor="let authorizedUser of group.authorizedUsers" class="authorized-user-item compact-member p-1 mb-1 border rounded bg-light">
                        <div class="d-flex align-items-center justify-content-between">
                          <div class="d-flex align-items-center">
                            <div class="user-avatar me-2">
                              <i class="fa fa-user-check compact-avatar text-success"></i>
                            </div>
                            <div>
                              <div class="compact-text fw-bold">{{ authorizedUser.firstName }} {{ authorizedUser.lastName }}</div>
                              <div class="text-muted compact-text">
                                <i class="fa fa-at"></i> {{ authorizedUser.userName }}
                              </div>
                            </div>
                          </div>
                          <button 
                            class="btn btn-xs btn-danger compact-btn"
                            (click)="unauthorizeUser(group.id, authorizedUser.id)">
                            <i class="fa fa-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Manage Authorized Users Form -->
                  <div *ngIf="managingAuthorizedUsersGroupId === group.id" class="manage-authorized-users-form mt-2 p-2 border rounded bg-light">
                    <h6 class="compact-subtitle mb-2">{{ 'FRIENDS.SELECT_AUTHORIZED_USERS' | translate }}</h6>
                    <p class="text-muted compact-text mb-2">
                      {{ 'FRIENDS.AUTHORIZED_USERS_HELP' | translate }}
                    </p>
                    <div *ngIf="friends.length === 0" class="alert alert-info compact-alert">
                      {{ 'FRIENDS.NO_FRIENDS_TO_AUTHORIZE' | translate }}
                    </div>
                    <div *ngIf="friends.length > 0" class="friends-selection">
                      <div *ngFor="let friend of friends" class="form-check mb-1">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          [id]="'authorize-' + group.id + '-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                          [checked]="isAuthorizedUserSelected(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                          (change)="toggleAuthorizedUser(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                        <label 
                          class="form-check-label compact-text" 
                          [for]="'authorize-' + group.id + '-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                          {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }} ({{ getOtherUser(friend).userName }})
                          <span *ngIf="isUserAuthorized(group, friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)" class="badge bg-success ms-1 compact-badge">
                            {{ 'FRIENDS.AUTHORIZED' | translate }}
                          </span>
                        </label>
                      </div>
                    </div>
                    <div class="d-flex gap-1 mt-2">
                      <button class="btn btn-success btn-xs compact-btn" (click)="saveAuthorizedUsers()" [disabled]="loading">
                        <i class="fa fa-check"></i>
                        {{ 'FRIENDS.SAVE' | translate }}
                      </button>
                      <button class="btn btn-secondary btn-xs compact-btn" (click)="cancelManagingAuthorizedUsers()" [disabled]="loading">
                        <i class="fa fa-times"></i>
                        {{ 'FRIENDS.CANCEL' | translate }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Group Form -->
          <div *ngIf="editingGroupId === group.id">
            <div class="mb-2">
              <label for="editingGroupName" class="form-label compact-text">{{ 'FRIENDS.GROUP_NAME' | translate }}</label>
              <input 
                type="text" 
                class="form-control form-control-sm"
                id="editingGroupName"
                [(ngModel)]="editingGroupName">
            </div>
            <div class="mb-2">
              <label for="editingGroupWhatsappLink" class="form-label compact-text">
                <i class="fa fa-whatsapp me-1"></i>
                WhatsApp Group Link
              </label>
              <input 
                type="url" 
                class="form-control form-control-sm"
                id="editingGroupWhatsappLink"
                [(ngModel)]="editingGroupWhatsappLink"
                placeholder="https://chat.whatsapp.com/...">
              <small class="form-text text-muted compact-text">
                Enter the WhatsApp group invite link (optional)
              </small>
            </div>
            <div class="mb-2">
              <label class="form-label compact-text">{{ 'FRIENDS.SELECT_MEMBERS' | translate }}</label>
              <div *ngIf="friends.length > 0" class="friends-selection">
                <div *ngFor="let friend of friends" class="form-check mb-1">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [id]="'edit-friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                    [checked]="isEditingMemberSelected(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                    (change)="toggleEditingGroupMember(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                  <label 
                    class="form-check-label compact-text" 
                    [for]="'edit-friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                    {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }} ({{ getOtherUser(friend).userName }})
                  </label>
                </div>
              </div>
            </div>
            <div class="d-flex gap-1">
              <button class="btn btn-success btn-xs compact-btn" (click)="updateFriendGroup()" [disabled]="loading">
                <i class="fa fa-check"></i>
                {{ 'FRIENDS.SAVE' | translate }}
              </button>
              <button class="btn btn-secondary btn-xs compact-btn" (click)="cancelEditingGroup()" [disabled]="loading">
                <i class="fa fa-times"></i>
                {{ 'FRIENDS.CANCEL' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>

