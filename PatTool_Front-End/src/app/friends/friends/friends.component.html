<div class="friends-container">
  <!-- Header Section -->
  <div class="pat-title">
    <h2>{{ 'FRIENDS.TITLE' | translate }}</h2>
    <app-navigation-buttons></app-navigation-buttons>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
    <i class="fa fa-exclamation-triangle"></i>
    {{ errorMessage }}
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="text-center">
    <i class="fa fa-spinner fa-spin fa-3x"></i>
    <p>{{ 'FRIENDS.LOADING' | translate }}</p>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'myuser'"
        (click)="setActiveTab('myuser')"
        type="button">
        <i class="fa fa-user"></i>
        {{ 'FRIENDS.MY_USER' | translate }}
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'users'"
        (click)="setActiveTab('users')"
        type="button">
        <i class="fa fa-user-plus"></i>
        {{ 'FRIENDS.ALL_USERS' | translate }}
        <span *ngIf="allUsers.length > 0" class="badge bg-primary">{{ allUsers.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'requests'"
        (click)="setActiveTab('requests')"
        type="button">
        <i class="fa fa-envelope"></i>
        {{ 'FRIENDS.REQUESTS' | translate }}
        <span class="badge bg-danger">{{ pendingRequests.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'friends'"
        (click)="setActiveTab('friends')"
        type="button">
        <i class="fa fa-heart"></i>
        {{ 'FRIENDS.MY_FRIENDS' | translate }}
        <span *ngIf="friends.length > 0" class="badge bg-success">{{ friends.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'groups'"
        (click)="setActiveTab('groups')"
        type="button">
        <i class="fa fa-users"></i>
        {{ 'FRIENDS.FRIEND_GROUPS' | translate }}
        <span *ngIf="friendGroups.length > 0" class="badge bg-info">{{ friendGroups.length }}</span>
      </button>
    </li>
  </ul>

  <!-- Tab Content: All Users -->
  <div *ngIf="activeTab === 'users'" class="tab-content">
    <!-- Invite by Email Section -->
    <div class="invite-section mb-2 p-3 bg-light rounded">
      <h5><i class="fa fa-envelope profile-icon"></i> {{ 'FRIENDS.INVITE_BY_EMAIL' | translate }}</h5>
      <div class="d-flex gap-2 mb-2 flex-wrap">
        <div class="input-group flex-grow-1" style="min-width: 250px;">
          <span class="input-group-text">
            <i class="fa fa-at"></i>
          </span>
          <input 
            type="email" 
            class="form-control" 
            [(ngModel)]="inviteEmail"
            (blur)="checkEmailExists()"
            (keyup.enter)="checkEmailExists()"
            [placeholder]="'FRIENDS.ENTER_EMAIL' | translate"
            [disabled]="checkingEmail || sendingInvite">
          <button 
            class="btn btn-outline-secondary" 
            type="button"
            (click)="checkEmailExists()"
            [disabled]="!inviteEmail || checkingEmail || sendingInvite">
            <i class="fa fa-search" *ngIf="!checkingEmail"></i>
            <i class="fa fa-spinner fa-spin" *ngIf="checkingEmail"></i>
            {{ 'FRIENDS.CHECK_EMAIL' | translate }}
          </button>
        </div>
        <div class="input-group flex-grow-1" style="min-width: 250px;">
          <span class="input-group-text">
            <i class="fa fa-search"></i>
          </span>
          <input 
            type="text" 
            class="form-control" 
            [(ngModel)]="searchFilter"
            [placeholder]="'FRIENDS.SEARCH_PLACEHOLDER' | translate">
        </div>
      </div>
      
      <!-- Email Check Result -->
      <div *ngIf="emailCheckResult !== null" class="mt-2">
        <div *ngIf="emailExists" class="alert alert-info">
          <i class="fa fa-info-circle"></i>
          {{ 'FRIENDS.EMAIL_EXISTS' | translate }}
          <span *ngIf="emailCheckResult.userName"> ({{ emailCheckResult.userName }})</span>
        </div>
        <div *ngIf="!emailExists" class="alert alert-success">
          <i class="fa fa-check-circle"></i>
          {{ 'FRIENDS.EMAIL_NOT_REGISTERED' | translate }}
          <button 
            *ngIf="!showCustomMessagePrompt && !showCustomMessageInput"
            class="btn btn-success btn-sm ms-2"
            (click)="sendInvitation()"
            [disabled]="sendingInvite">
            <i class="fa fa-paper-plane" *ngIf="!sendingInvite"></i>
            <i class="fa fa-spinner fa-spin" *ngIf="sendingInvite"></i>
            {{ 'FRIENDS.INVITE_TO_PATTOOL' | translate }}
          </button>
        </div>
        
        <!-- Custom Message Prompt -->
        <div *ngIf="showCustomMessagePrompt && !emailExists" class="alert alert-info mt-2">
          <i class="fa fa-question-circle"></i>
          <strong>{{ 'FRIENDS.ADD_CUSTOM_MESSAGE' | translate }}</strong>
          <div class="mt-2 d-flex gap-2">
            <button 
              class="btn btn-primary btn-sm"
              (click)="confirmAddCustomMessage()">
              <i class="fa fa-check"></i>
              {{ 'FRIENDS.YES' | translate }}
            </button>
            <button 
              class="btn btn-secondary btn-sm"
              (click)="skipCustomMessage()"
              [disabled]="sendingInvite">
              <i class="fa fa-times"></i>
              {{ 'FRIENDS.NO' | translate }}
            </button>
          </div>
        </div>
        
        <!-- Custom Message Input -->
        <div *ngIf="showCustomMessageInput && !emailExists" class="alert alert-info mt-2">
          <div class="mb-2">
            <label for="customMessage" class="form-label">
              <i class="fa fa-envelope"></i>
              <strong>{{ 'FRIENDS.CUSTOM_MESSAGE' | translate }}</strong>
            </label>
            <textarea 
              id="customMessage"
              class="form-control" 
              rows="4"
              [(ngModel)]="customMessage"
              [placeholder]="'FRIENDS.CUSTOM_MESSAGE_PLACEHOLDER' | translate"
              [disabled]="sendingInvite"></textarea>
          </div>
          <div class="d-flex gap-2">
            <button 
              class="btn btn-success btn-sm"
              (click)="sendInvitation()"
              [disabled]="sendingInvite || !customMessage.trim()">
              <i class="fa fa-paper-plane" *ngIf="!sendingInvite"></i>
              <i class="fa fa-spinner fa-spin" *ngIf="sendingInvite"></i>
              {{ 'FRIENDS.SEND_INVITATION' | translate }}
            </button>
            <button 
              class="btn btn-secondary btn-sm"
              (click)="cancelCustomMessage()"
              [disabled]="sendingInvite">
              <i class="fa fa-times"></i>
              {{ 'FRIENDS.CANCEL' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="users-list">
      <div *ngFor="let user of getFilteredUsers()" class="user-card compact-user-card">
        <!-- Card Header with User Name -->
        <div class="user-header">
          <h6 class="mb-0 card-header-content">
            <span class="user-name">
              <i class="fa fa-user-circle me-2"></i>
              {{ user.firstName }} {{ user.lastName }}
            </span>
            <span class="header-indicators">
              <span class="status-indicator connection-indicator" 
                    [style.background-color]="getUserOnlineStatus(user.id).online ? '#28a745' : '#dc3545'"
                    [style.border]="getUserOnlineStatus(user.id).online ? '2px solid #28a745' : '2px solid #dc3545'"
                    [ngbTooltip]="getUserOnlineStatus(user.id).online ? ('FRIENDS.ONLINE' | translate) : ('FRIENDS.OFFLINE' | translate)"
                    placement="top"></span>
              <span class="status-indicator visibility-indicator" 
                    [style.background-color]="(user.visible !== undefined && user.visible !== null) ? (user.visible ? '#28a745' : '#dc3545') : '#28a745'"
                    [style.border]="(user.visible !== undefined && user.visible !== null) ? (user.visible ? '2px solid #28a745' : '2px solid #dc3545') : '2px solid #28a745'"
                    [ngbTooltip]="(user.visible !== undefined && user.visible !== null) ? (user.visible ? ('FRIENDS.VISIBLE' | translate) : ('FRIENDS.HIDDEN' | translate)) : ('FRIENDS.VISIBLE' | translate)"
                    placement="top"></span>
            </span>
          </h6>
        </div>
        <div class="user-info">
          <div class="user-details">
            <p class="text-muted compact-text mb-2">
              <i class="fa fa-at profile-icon"></i> 
              <span class="profile-value">{{ user.userName }}</span>
            </p>
            <p class="text-muted compact-text mb-2">
              <i class="fa fa-envelope profile-icon"></i> 
              <span class="profile-value">{{ user.addressEmail }}</span>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="user.registrationDate">
              <i class="fa fa-calendar-plus-o profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.REGISTERED_ON' | translate }}:</strong> 
              <span class="profile-value">{{ user.registrationDate | date:'short' }}</span>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="user.lastConnectionDate">
              <i class="fa fa-clock-o profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.LAST_CONNECTION' | translate }}:</strong> 
              <span class="profile-value">{{ user.lastConnectionDate | date:'short' }}</span>
            </p>
            <div class="text-muted compact-text mb-2" *ngIf="getUserRoles(user) && getUserRoles(user).length > 0">
              <i class="fa fa-shield profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.ROLE' | translate }}:</strong> 
              <span class="profile-value">
                <span *ngFor="let role of getUserRoles(user); let last = last">
                  <span class="role-tag me-1" [ngClass]="getRoleTagClass(role)">{{ role }}</span>
                </span>
              </span>
            </div>
            <p class="text-muted compact-text mb-2" *ngIf="getUserStatus(user) === 'sent' && getSentRequestDate(user)">
              <i class="fa fa-paper-plane profile-icon"></i>
              <strong class="profile-label">{{ 'FRIENDS.REQUEST_SENT' | translate }}:</strong> 
              <span class="profile-value">{{ getSentRequestDate(user) | date:'short' }}</span>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="getUserStatus(user) === 'friend' && getFriendshipDate(user)">
              <i class="fa fa-heart profile-icon"></i>
              <strong class="profile-label">{{ 'FRIENDS.FRIENDS_SINCE' | translate }}:</strong> 
              <span class="profile-value">{{ getFriendshipDate(user) | date:'short' }}</span>
            </p>
            <div class="compact-text mb-2" *ngIf="hasAdminRole()" style="color: #007bff;">
              <i class="fa fa-id-card profile-icon"></i> 
              <strong class="profile-label">ID:</strong> 
              <span class="profile-value">{{ user.id }}</span>
            </div>
            <div class="compact-text mb-2" *ngIf="hasAdminRole() && user.keycloakId" style="color: #007bff;">
              <i class="fa fa-key profile-icon"></i> 
              <strong class="profile-label">Keycloak ID:</strong> 
              <span class="profile-value">{{ user.keycloakId }}</span>
            </div>
          </div>
        </div>
        <div class="user-actions">
          <div class="d-flex gap-2 flex-wrap align-items-center">
            <!-- WhatsApp Link button -->
            <button 
              *ngIf="user.whatsappLink"
              class="btn btn-xs btn-success compact-btn"
              (click)="openWhatsAppLink(user.whatsappLink!)"
              [ngbTooltip]="'FRIENDS.OPEN_WHATSAPP' | translate"
              placement="top">
              <i class="fa fa-whatsapp"></i>
            </button>
            <button 
              *ngIf="getUserStatus(user) === 'none'"
              class="btn btn-primary btn-xs compact-btn"
              (click)="sendFriendRequest(user.id)">
              <i class="fa fa-user-plus"></i>
              <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.SEND_REQUEST' | translate }}</span>
            </button>
            <button 
              *ngIf="getUserStatus(user) === 'pending'"
              class="btn btn-warning btn-xs compact-btn"
              disabled>
              <i class="fa fa-clock"></i>
              <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.PENDING_REQUEST' | translate }}</span>
            </button>
            <button 
              *ngIf="getUserStatus(user) === 'sent'"
              class="btn btn-info btn-xs compact-btn"
              (click)="resendFriendRequest(user.id)"
              title="{{ 'FRIENDS.RESEND_REQUEST' | translate }}">
              <i class="fa fa-paper-plane"></i>
              <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.RESEND_REQUEST' | translate }}</span>
            </button>
            <span 
              *ngIf="getUserStatus(user) === 'friend'"
              class="friend-status-tag">
              <i class="fa fa-heart text-success"></i>
              <span class="ms-1">{{ 'FRIENDS.FRIEND' | translate }}</span>
            </span>
          </div>
        </div>
        
        <!-- Custom Message Prompt for Friend Request -->
        <div *ngIf="friendRequestMessagePrompts.get(user.id) && (getUserStatus(user) === 'none' || getUserStatus(user) === 'sent')" class="alert alert-info compact-alert mt-2">
          <i class="fa fa-question-circle"></i>
          <span class="compact-text">{{ 'FRIENDS.ADD_CUSTOM_MESSAGE' | translate }}</span>
          <div class="mt-2 d-flex gap-2">
            <button 
              class="btn btn-primary btn-xs compact-btn"
              (click)="confirmAddFriendRequestMessage(user.id)">
              <i class="fa fa-check"></i>
              {{ 'FRIENDS.YES' | translate }}
            </button>
            <button 
              class="btn btn-secondary btn-xs compact-btn"
              (click)="skipFriendRequestMessage(user.id)"
              [disabled]="loading">
              <i class="fa fa-times"></i>
              {{ 'FRIENDS.NO' | translate }}
            </button>
          </div>
        </div>
        
        <!-- Custom Message Input for Friend Request -->
        <div *ngIf="friendRequestMessageInputs.get(user.id) && (getUserStatus(user) === 'none' || getUserStatus(user) === 'sent')" class="alert alert-info compact-alert mt-2">
          <div class="mb-2">
            <label [for]="'friendRequestMessage-' + user.id" class="compact-text">
              <i class="fa fa-envelope"></i>
              <strong>{{ 'FRIENDS.CUSTOM_MESSAGE' | translate }}</strong>
            </label>
            <textarea 
              [id]="'friendRequestMessage-' + user.id"
              class="form-control form-control-sm" 
              rows="4"
              [value]="getFriendRequestMessage(user.id)"
              (input)="setFriendRequestMessage(user.id, $any($event.target).value)"
              [placeholder]="'FRIENDS.CUSTOM_MESSAGE_PLACEHOLDER' | translate"
              [disabled]="loading"></textarea>
          </div>
          <div class="d-flex gap-2">
            <button 
              class="btn btn-success btn-xs compact-btn"
              (click)="sendFriendRequest(user.id)"
               [disabled]="loading || !getFriendRequestMessage(user.id).trim()">
              <i class="fa fa-paper-plane" *ngIf="!loading"></i>
              <i class="fa fa-spinner fa-spin" *ngIf="loading"></i>
              <span *ngIf="getUserStatus(user) === 'none'">{{ 'FRIENDS.SEND_REQUEST' | translate }}</span>
              <span *ngIf="getUserStatus(user) === 'sent'">{{ 'FRIENDS.RESEND_REQUEST' | translate }}</span>
            </button>
            <button 
              class="btn btn-secondary btn-xs compact-btn"
              (click)="cancelFriendRequestMessage(user.id)"
              [disabled]="loading">
              <i class="fa fa-times"></i>
              {{ 'FRIENDS.CANCEL' | translate }}
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="getFilteredUsers().length === 0" class="no-results">
        <i class="fa fa-search fa-3x"></i>
        <p>{{ 'FRIENDS.NO_USERS_FOUND' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Tab Content: Friend Requests -->
  <div *ngIf="activeTab === 'requests'" class="tab-content">
    <div *ngIf="pendingRequests.length === 0" class="no-results no-results-centered">
      <i class="fa fa-inbox fa-3x"></i>
      <p>{{ 'FRIENDS.NO_PENDING_REQUESTS' | translate }}</p>
    </div>

    <div *ngIf="pendingRequests.length > 0" class="requests-list">
      <div *ngFor="let request of getSortedPendingRequests()" class="request-card compact-user-card">
        <!-- Card Header with User Name -->
        <div class="request-header">
          <h6 class="mb-0 card-header-content">
            <span class="user-name">
              <i class="fa fa-user-circle me-2"></i>
              {{ request.requester.firstName }} {{ request.requester.lastName }}
            </span>
            <span class="header-indicators">
              <span class="status-indicator connection-indicator" 
                    [style.background-color]="getUserOnlineStatus(request.requester.id).online ? '#28a745' : '#dc3545'"
                    [style.border]="getUserOnlineStatus(request.requester.id).online ? '2px solid #28a745' : '2px solid #dc3545'"
                    [ngbTooltip]="getUserOnlineStatus(request.requester.id).online ? ('FRIENDS.ONLINE' | translate) : ('FRIENDS.OFFLINE' | translate)"
                    placement="top"></span>
              <span class="status-indicator visibility-indicator" 
                    [style.background-color]="(request.requester.visible !== undefined && request.requester.visible !== null) ? (request.requester.visible ? '#28a745' : '#dc3545') : '#28a745'"
                    [style.border]="(request.requester.visible !== undefined && request.requester.visible !== null) ? (request.requester.visible ? '2px solid #28a745' : '2px solid #dc3545') : '2px solid #28a745'"
                    [ngbTooltip]="(request.requester.visible !== undefined && request.requester.visible !== null) ? (request.requester.visible ? ('FRIENDS.VISIBLE' | translate) : ('FRIENDS.HIDDEN' | translate)) : ('FRIENDS.VISIBLE' | translate)"
                    placement="top"></span>
            </span>
          </h6>
        </div>
        <div class="request-info">
          <div class="request-details">
            <p class="text-muted compact-text mb-2">
              <i class="fa fa-at profile-icon"></i> 
              <span class="profile-value">{{ request.requester.userName }}</span>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="request.requester.registrationDate">
              <i class="fa fa-calendar-plus-o profile-icon"></i> 
              <span class="profile-value">{{ request.requester.registrationDate | date:'short' }}</span>
            </p>
            <p class="text-muted compact-text mb-2">
              <i class="fa fa-clock profile-icon"></i>
              <strong class="profile-label">{{ 'FRIENDS.REQUEST_DATE' | translate }}:</strong> 
              <span class="profile-value">{{ request.requestDate | date:'short' }}</span>
            </p>
            <div *ngIf="request.message" class="alert alert-info compact-text mb-0 mt-2">
              <i class="fa fa-envelope me-1"></i>
              <strong>{{ 'FRIENDS.CUSTOM_MESSAGE' | translate }}:</strong>
              <p class="mb-0 mt-1" style="white-space: pre-wrap;">{{ request.message }}</p>
            </div>
          </div>
        </div>
        <div class="request-actions">
          <button 
            class="btn btn-success btn-xs compact-btn"
            (click)="approveRequest(request.id)">
            <i class="fa fa-check"></i>
            <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.APPROVE' | translate }}</span>
          </button>
          <button 
            class="btn btn-danger btn-xs compact-btn"
            (click)="rejectRequest(request.id)">
            <i class="fa fa-times"></i>
            <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.REJECT' | translate }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content: My Friends -->
  <div *ngIf="activeTab === 'friends'" class="tab-content">
    <div *ngIf="friends.length === 0" class="no-results">
      <i class="fa fa-user-friends fa-3x"></i>
      <p>{{ 'FRIENDS.NO_FRIENDS' | translate }}</p>
    </div>

    <div *ngIf="friends.length > 0" class="friends-list">
      <div *ngFor="let friend of getSortedFriends()" class="friend-card compact-user-card">
        <!-- Card Header with User Name -->
        <div class="friend-header">
          <h6 class="mb-0 card-header-content">
            <span class="user-name">
              <i class="fa fa-user-circle me-2"></i>
              {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }}
            </span>
            <span class="header-indicators">
              <span class="status-indicator connection-indicator" 
                    [style.background-color]="getUserOnlineStatus(getOtherUser(friend).id).online ? '#28a745' : '#dc3545'"
                    [style.border]="getUserOnlineStatus(getOtherUser(friend).id).online ? '2px solid #28a745' : '2px solid #dc3545'"
                    [ngbTooltip]="getUserOnlineStatus(getOtherUser(friend).id).online ? ('FRIENDS.ONLINE' | translate) : ('FRIENDS.OFFLINE' | translate)"
                    placement="top"></span>
              <span class="status-indicator visibility-indicator" 
                    [style.background-color]="(getOtherUser(friend).visible !== undefined && getOtherUser(friend).visible !== null) ? (getOtherUser(friend).visible ? '#28a745' : '#dc3545') : '#28a745'"
                    [style.border]="(getOtherUser(friend).visible !== undefined && getOtherUser(friend).visible !== null) ? (getOtherUser(friend).visible ? '2px solid #28a745' : '2px solid #dc3545') : '2px solid #28a745'"
                    [ngbTooltip]="(getOtherUser(friend).visible !== undefined && getOtherUser(friend).visible !== null) ? (getOtherUser(friend).visible ? ('FRIENDS.VISIBLE' | translate) : ('FRIENDS.HIDDEN' | translate)) : ('FRIENDS.VISIBLE' | translate)"
                    placement="top"></span>
            </span>
          </h6>
        </div>
        <div class="friend-info">
          <div class="friend-details">
            <p class="text-muted compact-text mb-2">
              <i class="fa fa-at profile-icon"></i> 
              <span class="profile-value">{{ getOtherUser(friend).userName }}</span>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="getOtherUser(friend).registrationDate">
              <i class="fa fa-calendar-plus-o profile-icon"></i> 
              <span class="profile-value">{{ getOtherUser(friend).registrationDate | date:'short' }}</span>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="getOtherUser(friend).lastConnectionDate">
              <i class="fa fa-clock-o profile-icon"></i> 
              <span class="profile-value">{{ getOtherUser(friend).lastConnectionDate | date:'short' }}</span>
            </p>
            <p class="text-muted compact-text mb-2">
              <i class="fa fa-heart profile-icon"></i>
              <strong class="profile-label">{{ 'FRIENDS.FRIENDS_SINCE' | translate }}:</strong> 
              <span class="profile-value">{{ friend.friendshipDate | date:'short' }}</span>
            </p>
          </div>
        </div>
        <div class="friend-actions">
          <div class="d-flex gap-2 flex-wrap">
            <!-- WhatsApp Link for the friend (other user) only -->
            <button 
              *ngIf="getOtherUser(friend).whatsappLink"
              class="btn btn-xs btn-success compact-btn"
              (click)="openWhatsAppLink(getOtherUser(friend).whatsappLink!)"
              [ngbTooltip]="'FRIENDS.OPEN_WHATSAPP' | translate"
              placement="top">
              <i class="fa fa-whatsapp"></i>
            </button>
            <button 
              class="btn btn-danger btn-xs compact-btn"
              (click)="removeFriend(friend.id)">
              <i class="fa fa-user-times"></i>
              <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.REMOVE_FRIEND' | translate }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content: My User -->
  <div *ngIf="activeTab === 'myuser'" class="tab-content">
    <div class="myuser-grid-container">
      <!-- Left: User Profile -->
      <div class="myuser-grid-left">
        <div class="user-profile-section">
          <div class="user-card compact-user-card">
        <div class="friend-header">
          <h5 class="mb-3">
            <i class="fa fa-user-circle me-2"></i>
            {{ 'FRIENDS.MY_PROFILE' | translate }}
          </h5>
        </div>
        
        <!-- Admin: Select user to update -->
        <div *ngIf="hasAdminRole()" class="admin-user-select-container mb-4">
          <div class="admin-select-header">
            <div class="admin-badge">
              <i class="fa fa-shield-alt me-2"></i>
              <span>{{ 'FRIENDS.ADMIN_MODE' | translate }}</span>
            </div>
          </div>
          <div class="admin-select-body">
            <label class="admin-select-label">
              <i class="fa fa-user-cog me-2"></i>
              <strong>{{ 'FRIENDS.SELECT_USER_TO_UPDATE' | translate }}</strong>
            </label>
            <div class="admin-select-wrapper">
              <select 
                class="form-select admin-user-select" 
                [ngModel]="selectedUserForUpdate?.id || ''"
                (ngModelChange)="onUserSelectedForUpdate($event)">
                <option value="">{{ 'FRIENDS.SELECT_USER_PLACEHOLDER' | translate }}</option>
                <option *ngFor="let user of getSortedUsersForAdmin()" [value]="user.id">
                  {{ user.firstName }} {{ user.lastName }} ({{ user.userName }})
                  <span *ngIf="getFilteredRoles(user.roles).length > 0">
                    - {{ getFilteredRoles(user.roles)[0] }}
                  </span>
                </option>
              </select>
              <i class="fa fa-chevron-down admin-select-icon"></i>
            </div>
            <div *ngIf="selectedUserForUpdate && editingSelectedUser" class="admin-selected-user-info mt-3">
              <div class="selected-user-badge">
                <i class="fa fa-check-circle me-2"></i>
                <span>{{ 'FRIENDS.EDITING_USER' | translate }}: <strong>{{ selectedUserForUpdate.firstName }} {{ selectedUserForUpdate.lastName }}</strong></span>
              </div>
            </div>
          </div>
        </div>

        <div class="friend-info">
          <div class="friend-details">
            <!-- Display selected user for admin or current user -->
            <ng-container *ngIf="hasAdminRole() && selectedUserForUpdate && editingSelectedUser; else currentUserView">
              <div class="admin-editing-header mb-3 pb-3 border-bottom">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h6 class="mb-1 admin-editing-title">
                      <i class="fa fa-user-edit me-2 text-primary"></i>
                      {{ 'FRIENDS.EDITING_USER_PROFILE' | translate }}
                    </h6>
                    <p class="mb-0 text-muted compact-text">
                      <i class="fa fa-user-circle me-2"></i>
                      <strong>{{ selectedUserForUpdate.firstName }} {{ selectedUserForUpdate.lastName }}</strong>
                      <span class="ms-2 text-muted">(@{{ selectedUserForUpdate.userName }})</span>
                    </p>
                  </div>
                  <div class="admin-editing-actions">
                    <button 
                      class="btn btn-sm btn-outline-secondary"
                      (click)="cancelEditingSelectedUser()"
                      [disabled]="loading"
                      [ngbTooltip]="'FRIENDS.CANCEL' | translate"
                      placement="top">
                      <i class="fa fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
              <p class="text-muted compact-text mb-2" *ngIf="getFilteredRoles(selectedUserForUpdate.roles).length > 0">
                <i class="fa fa-shield profile-icon"></i> 
                <strong class="profile-label">{{ 'FRIENDS.ROLES' | translate }}:</strong> 
                <span class="profile-value ms-2">
                  <span *ngFor="let role of getFilteredRoles(selectedUserForUpdate.roles); let last = last" 
                        class="role-tag me-1 mb-1" 
                        [ngClass]="getRoleTagClass(role)">
                    {{ getTranslatedRole(role) }}
                  </span>
                </span>
              </p>
              <div class="admin-form-field mb-3">
                <label class="admin-form-label">
                  <i class="fa fa-envelope profile-icon"></i> 
                  <strong>{{ 'FRIENDS.EMAIL' | translate }}:</strong>
                </label>
                <input 
                  type="email" 
                  class="form-control form-control-sm admin-form-input" 
                  [(ngModel)]="selectedUserForUpdate.addressEmail">
              </div>
              <div class="admin-form-field mb-3">
                <label class="admin-form-label">
                  <i class="fa fa-user profile-icon"></i> 
                  <strong>{{ 'FRIENDS.NAME' | translate }}:</strong>
                </label>
                <div class="admin-name-fields">
                  <input 
                    type="text" 
                    class="form-control form-control-sm admin-form-input mb-2" 
                    [(ngModel)]="selectedUserForUpdate.firstName"
                    placeholder="Prénom">
                  <input 
                    type="text" 
                    class="form-control form-control-sm admin-form-input" 
                    [(ngModel)]="selectedUserForUpdate.lastName"
                    placeholder="Nom">
                </div>
              </div>
              <div class="admin-form-field mb-3">
                <label class="admin-form-label">
                  <i class="fa fa-at profile-icon"></i> 
                  <strong>{{ 'FRIENDS.USERNAME' | translate }}:</strong>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-sm admin-form-input" 
                  [(ngModel)]="selectedUserForUpdate.userName">
              </div>
              <div class="admin-form-field mb-3">
                <label class="admin-form-label">
                  <i class="fa fa-language profile-icon"></i> 
                  <strong>{{ 'FRIENDS.LANGUAGE' | translate }}:</strong>
                </label>
                <select 
                  class="form-select form-select-sm admin-form-input" 
                  [(ngModel)]="selectedUserForUpdate.locale">
                  <option value="">-- Sélectionner une langue --</option>
                  <option value="ar">Arabic (ar)</option>
                  <option value="cn">Chinese (cn)</option>
                  <option value="de">German (de)</option>
                  <option value="el">Greek (el)</option>
                  <option value="en">English (en)</option>
                  <option value="es">Spanish (es)</option>
                  <option value="fr">French (fr)</option>
                  <option value="he">Hebrew (he)</option>
                  <option value="it">Italian (it)</option>
                  <option value="jp">Japanese (jp)</option>
                  <option value="ru">Russian (ru)</option>
                </select>
              </div>
              <div class="admin-form-field mb-3">
                <label class="admin-form-label">
                  <i class="fa fa-whatsapp profile-icon"></i> 
                  <strong>{{ 'FRIENDS.WHATSAPP_PHONE' | translate }}:</strong>
                </label>
                <div class="input-group admin-form-input">
                  <div class="btn-group" ngbDropdown #adminCountryDropdown="ngbDropdown" role="group">
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary btn-sm dropdown-toggle"
                      style="min-width: 100px; text-align: left;"
                      ngbDropdownToggle
                      id="adminCountryCodeDropdown">
                      <ng-container *ngIf="getSelectedCountryForAdmin() as selectedCountry; else noAdminCountry">
                        <span class="fi fi-{{ selectedCountry.flag }}" style="margin-right: 5px;"></span>
                        <span>{{ selectedCountry.code }}</span>
                      </ng-container>
                      <ng-template #noAdminCountry>
                        <span>+33</span>
                      </ng-template>
                    </button>
                    <div class="dropdown-menu" ngbDropdownMenu aria-labelledby="adminCountryCodeDropdown" style="max-height: 300px; overflow-y: auto; font-size: 0.875rem;">
                      <button 
                        *ngFor="let country of countryCodes" 
                        class="dropdown-item"
                        type="button"
                        (click)="selectCountryCodeForAdmin(country.code, adminCountryDropdown)"
                        style="display: flex; align-items: center; font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                        <span class="fi fi-{{ country.flag }}" style="margin-right: 8px; font-size: 1em;"></span>
                        <span>{{ country.code }} - {{ country.name }}</span>
                      </button>
                    </div>
                  </div>
                  <input 
                    type="text" 
                    class="form-control form-control-sm"
                    [(ngModel)]="selectedUserWhatsappLink"
                    (keypress)="onPhoneNumberKeyPress($event)"
                    [placeholder]="'FRIENDS.WHATSAPP_PHONE_PLACEHOLDER' | translate"
                    pattern="[0-9]*"
                    inputmode="numeric">
                </div>
              </div>
              <!-- Visibility Toggle for Admin -->
              <div class="admin-form-field mb-3">
                <label class="admin-form-label">
                  <i class="fa fa-eye profile-icon"></i> 
                  <strong>{{ 'FRIENDS.VISIBILITY' | translate }}:</strong>
                </label>
                <div class="form-check form-switch visibility-switch">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    role="switch"
                    id="adminVisibilitySwitch"
                    [checked]="selectedUserForUpdate.visible !== undefined ? selectedUserForUpdate.visible : true"
                    (change)="updateSelectedUserVisibility($event.target.checked)"
                    [disabled]="loading">
                  <label class="form-check-label ms-2" for="adminVisibilitySwitch">
                    <span *ngIf="selectedUserForUpdate.visible !== undefined ? selectedUserForUpdate.visible : true" class="visibility-status">{{ 'FRIENDS.VISIBLE' | translate }}</span>
                    <span *ngIf="selectedUserForUpdate.visible !== undefined ? !selectedUserForUpdate.visible : false" class="visibility-status">{{ 'FRIENDS.HIDDEN' | translate }}</span>
                  </label>
                </div>
              </div>
              <div class="admin-form-actions mt-4 pt-3 border-top">
                <div class="d-flex gap-2 justify-content-end">
                  <button 
                    class="btn btn-success admin-save-btn"
                    (click)="saveUpdatedUser()"
                    [disabled]="loading">
                    <i class="fa fa-save me-2"></i>
                    <span>{{ 'FRIENDS.SAVE' | translate }}</span>
                    <i *ngIf="loading" class="fa fa-spinner fa-spin ms-2"></i>
                  </button>
                  <button 
                    class="btn btn-secondary admin-cancel-btn"
                    (click)="cancelEditingSelectedUser()"
                    [disabled]="loading">
                    <i class="fa fa-times me-2"></i>
                    <span>{{ 'FRIENDS.CANCEL' | translate }}</span>
                  </button>
                </div>
              </div>
            </ng-container>
            
            <ng-template #currentUserView>
            <p class="compact-text mb-1">
              <strong>{{ currentUser.firstName }} {{ currentUser.lastName }}</strong>
            </p>
            <p class="compact-text mb-1">
              <strong>{{ currentUser.userName }}</strong>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="currentUser.whatsappLink">
              <i class="fa fa-phone profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.PHONE_NUMBER' | translate }}:</strong> 
              <span class="profile-value">{{ getPhoneNumberFromLink(currentUser.whatsappLink) }}</span>
            </p>
            <p class="text-muted compact-text mb-2">
              <i class="fa fa-envelope profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.EMAIL' | translate }}:</strong> 
              <span class="profile-value">{{ currentUser.addressEmail }}</span>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="currentUser.registrationDate">
              <i class="fa fa-calendar-plus-o profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.REGISTERED_ON' | translate }}:</strong> 
              <span class="profile-value">{{ currentUser.registrationDate | date:'short' }}</span>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="currentUser.lastConnectionDate">
              <i class="fa fa-clock-o profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.LAST_CONNECTION' | translate }}:</strong> 
              <span class="profile-value">{{ currentUser.lastConnectionDate | date:'short' }}</span>
            </p>
            <p class="text-muted compact-text mb-2" *ngIf="currentUser.locale">
              <i class="fa fa-language profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.LANGUAGE' | translate }}:</strong> 
              <span class="profile-value">{{ currentUser.locale | uppercase }}</span>
            </p>
            <div class="text-muted compact-text mb-2" *ngIf="getUserRoles(currentUser) && getUserRoles(currentUser).length > 0">
              <i class="fa fa-shield profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.ROLE' | translate }}:</strong> 
              <span class="profile-value ms-2">
                <span *ngFor="let role of getUserRoles(currentUser); let last = last">
                  <span class="role-tag me-1" [ngClass]="getRoleTagClass(role)">{{ role }}</span>
                </span>
              </span>
            </div>
            <p class="text-muted compact-text mb-2">
              <i class="fa fa-heart profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.MY_FRIENDS' | translate }}:</strong> 
              <span class="profile-value">{{ friends.length }}</span>
            </p>
            <p class="text-muted compact-text mb-2">
              <i class="fa fa-users profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.FRIEND_GROUPS' | translate }}:</strong> 
              <span class="profile-value">{{ friendGroups.length }}</span>
            </p>
            <!-- Visibility Toggle -->
            <div class="text-muted compact-text mb-2 d-flex align-items-center visibility-toggle-container">
              <i class="fa fa-eye profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.VISIBILITY' | translate }}:</strong> 
              <div class="form-check form-switch visibility-switch">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  role="switch"
                  id="visibilitySwitch"
                  [checked]="getCurrentUserVisibility()"
                  (change)="updateVisibility($event.target.checked)"
                  [disabled]="loading">
                <label class="form-check-label ms-2" for="visibilitySwitch">
                  <span *ngIf="getCurrentUserVisibility()" class="visibility-status">{{ 'FRIENDS.VISIBLE' | translate }}</span>
                  <span *ngIf="!getCurrentUserVisibility()" class="visibility-status">{{ 'FRIENDS.HIDDEN' | translate }}</span>
                </label>
              </div>
            </div>
            <div class="compact-text mb-2" *ngIf="hasAdminRole()" style="color: #007bff;">
              <i class="fa fa-id-card profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.USER_ID' | translate }}:</strong> 
              <span class="profile-value">{{ currentUser.id }}</span>
            </div>
            <div class="compact-text mb-2" *ngIf="hasAdminRole() && currentUser.keycloakId" style="color: #007bff;">
              <i class="fa fa-key profile-icon"></i> 
              <strong class="profile-label">{{ 'FRIENDS.KEYCLOAK_ID' | translate }}:</strong> 
              <span class="profile-value">{{ currentUser.keycloakId }}</span>
            </div>
            
            <!-- WhatsApp Link Section -->
            <div class="whatsapp-link-section mt-3 pt-3 border-top">
              <h6 class="compact-subtitle mb-3">
                <i class="fa fa-whatsapp profile-icon"></i> 
                {{ 'FRIENDS.WHATSAPP_PHONE' | translate }}
              </h6>
              
              <!-- Display WhatsApp Link -->
              <div *ngIf="!editingMyWhatsappLink" class="whatsapp-display">
                <div class="d-flex gap-2 align-items-center mb-2">
                  <button 
                    *ngIf="currentUser.whatsappLink"
                    class="btn btn-xs btn-success compact-btn"
                    (click)="openWhatsAppLink(currentUser.whatsappLink!)"
                    [ngbTooltip]="'FRIENDS.OPEN_WHATSAPP' | translate"
                    placement="top">
                    <i class="fa fa-whatsapp"></i>
                  </button>
                  <button 
                    class="btn btn-xs btn-success compact-btn"
                    (click)="startEditingMyWhatsappLink()">
                    <i class="fa fa-edit"></i>
                    <span class="d-none d-sm-inline ms-1">{{ currentUser.whatsappLink ? ('FRIENDS.EDIT_WHATSAPP_LINK' | translate) : ('FRIENDS.ADD_WHATSAPP_LINK' | translate) }}</span>
                  </button>
                </div>
                <small class="text-muted d-block">
                  <i class="fa fa-info-circle"></i> 
                  {{ 'FRIENDS.USER_PHONE_NUMBER' | translate }}
                </small>
              </div>
              
              <!-- Edit WhatsApp Link Form -->
              <div *ngIf="editingMyWhatsappLink" class="whatsapp-link-edit">
                <div class="input-group mb-2">
                  <span class="input-group-text">
                    <i class="fa fa-whatsapp"></i>
                  </span>
                  <div class="btn-group" ngbDropdown #countryDropdown="ngbDropdown" role="group">
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary btn-sm dropdown-toggle"
                      style="min-width: 150px; text-align: left;"
                      ngbDropdownToggle
                      id="countryCodeDropdown">
                      <ng-container *ngIf="getSelectedCountry() as selectedCountry; else noCountry">
                        <span class="fi fi-{{ selectedCountry.flag }}" style="margin-right: 5px;"></span>
                        <span>{{ selectedCountry.code }}</span>
                      </ng-container>
                      <ng-template #noCountry>
                        <span>Select Country</span>
                      </ng-template>
                    </button>
                    <div class="dropdown-menu" ngbDropdownMenu aria-labelledby="countryCodeDropdown" style="max-height: 300px; overflow-y: auto; font-size: 0.875rem;">
                      <button 
                        *ngFor="let country of countryCodes" 
                        class="dropdown-item"
                        type="button"
                        (click)="selectCountryCode(country.code, countryDropdown)"
                        style="display: flex; align-items: center; font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                        <span class="fi fi-{{ country.flag }}" style="margin-right: 8px; font-size: 1em;"></span>
                        <span>{{ country.code }} - {{ country.name }}</span>
                      </button>
                    </div>
                  </div>
                  <input 
                    type="text" 
                    class="form-control form-control-sm"
                    [(ngModel)]="myWhatsappLink"
                    (keypress)="onPhoneNumberKeyPress($event)"
                    [placeholder]="'FRIENDS.WHATSAPP_PHONE_PLACEHOLDER' | translate"
                    pattern="[0-9]*"
                    inputmode="numeric">
                </div>
                <small class="text-muted d-block mb-2">
                  <i class="fa fa-info-circle"></i>
                  {{ 'FRIENDS.WHATSAPP_PHONE_NOTE' | translate }}
                </small>
                <div class="d-flex gap-2">
                  <button 
                    type="button"
                    class="btn btn-xs btn-success compact-btn"
                    (click)="saveMyWhatsappLink()"
                    [disabled]="loading || !isValidPhoneNumber(myWhatsappLink)">
                    <i class="fa fa-save"></i>
                    <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.SAVE' | translate }}</span>
                  </button>
                  <button 
                    class="btn btn-xs btn-secondary compact-btn"
                    (click)="cancelEditingMyWhatsappLink()">
                    <i class="fa fa-times"></i>
                    <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.CANCEL' | translate }}</span>
                  </button>
                </div>
                <small class="text-muted" *ngIf="myWhatsappLink && !isValidPhoneNumber(myWhatsappLink)">
                  {{ 'FRIENDS.INVALID_PHONE_NUMBER' | translate }}
                </small>
              </div>
            </div>
            </ng-template>
          </div>
        </div>
        </div>
      </div>
      </div>

      <!-- Right: Friends Grid with Origin Info -->
      <div class="myuser-grid-right">
        <div *ngIf="getFriendsForDisplay().length === 0" class="no-results">
          <i class="fa fa-user-friends fa-3x"></i>
          <p>{{ 'FRIENDS.NO_FRIENDS' | translate }}</p>
        </div>

        <div *ngIf="getFriendsForDisplay().length > 0 || getGroupMembersNotFriends().length > 0" class="friends-grid-section">
          <!-- Direct Friends Section -->
          <div *ngIf="getFriendsForDisplay().length > 0" class="mb-4">
            <h6 class="mb-3 d-flex justify-content-between align-items-center">
              <span>
                <i class="fa fa-heart me-2"></i>
                {{ 'FRIENDS.MY_FRIENDS' | translate }} ({{ getFriendsForDisplay().length }})
              </span>
              <button 
                class="btn btn-sm btn-outline-primary"
                (click)="refreshConnectionStatus()"
                [ngbTooltip]="'FRIENDS.REFRESH_STATUS' | translate"
                placement="top">
                <i class="fa fa-refresh me-1"></i>
                {{ 'FRIENDS.REFRESH' | translate }}
              </button>
            </h6>
            <div class="table-responsive">
              <table class="table table-hover table-sm friends-grid-table">
                <thead>
                  <tr>
                    <th style="width: 50px;"></th>
                    <th>{{ 'FRIENDS.NAME' | translate }}</th>
                    <th>{{ 'FRIENDS.USERNAME' | translate }}</th>
                    <th>{{ 'FRIENDS.ORIGIN' | translate }}</th>
                    <th>{{ 'FRIENDS.ACTIONS' | translate }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let friend of getSortedFriendsForDisplay(); let i = index" 
                      [class.table-active]="selectedFriendIndex === i"
                      (click)="selectedFriendIndex = i"
                      style="cursor: pointer;">
                    <td style="text-align: center; vertical-align: middle;">
                      <div class="d-flex align-items-center justify-content-center gap-2">
                        <span class="status-indicator connection-indicator" 
                              [style.background-color]="getUserOnlineStatus(getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).id).online ? '#28a745' : '#dc3545'"
                              [style.border]="getUserOnlineStatus(getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).id).online ? '2px solid #28a745' : '2px solid #dc3545'"
                              [ngbTooltip]="getUserOnlineStatus(getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).id).online ? ('FRIENDS.ONLINE' | translate) : ('FRIENDS.OFFLINE' | translate)"
                              placement="top"></span>
                        <span class="status-indicator visibility-indicator" 
                              [style.background-color]="(getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).visible !== undefined && getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).visible !== null) ? (getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).visible ? '#28a745' : '#dc3545') : '#28a745'"
                              [style.border]="(getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).visible !== undefined && getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).visible !== null) ? (getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).visible ? '2px solid #28a745' : '2px solid #dc3545') : '2px solid #28a745'"
                              [ngbTooltip]="(getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).visible !== undefined && getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).visible !== null) ? (getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).visible ? ('FRIENDS.VISIBLE' | translate) : ('FRIENDS.HIDDEN' | translate)) : ('FRIENDS.VISIBLE' | translate)"
                              placement="top"></span>
                      </div>
                    </td>
                    <td>
                      <i class="fa fa-user-circle me-2"></i>
                      {{ getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).firstName }} {{ getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).lastName }}
                    </td>
                    <td>
                      <i class="fa fa-at"></i> {{ getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).userName }}
                    </td>
                    <td>
                      <span *ngIf="getFriendshipOrigin(friend).type === 'direct'" class="origin-badge direct-badge">
                        <i class="fa fa-heart me-1"></i>{{ 'FRIENDS.DIRECT_FRIENDSHIP' | translate }}
                      </span>
                      <span *ngIf="getFriendshipOrigin(friend).type === 'both' && getFriendshipOrigin(friend).groups && getFriendshipOrigin(friend).groups!.length > 0" class="origin-badge both-badge">
                        <i class="fa fa-heart me-1"></i>{{ 'FRIENDS.DIRECT_FRIENDSHIP' | translate }} + 
                        <i class="fa fa-users me-1"></i>
                        <span *ngFor="let groupName of getFriendshipOrigin(friend).groups; let last = last">
                          {{ groupName }}<span *ngIf="!last">, </span>
                        </span>
                      </span>
                    </td>
                    <td>
                      <button 
                        *ngIf="getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).whatsappLink"
                        class="btn btn-xs btn-success compact-btn"
                        (click)="openWhatsAppLink(getOtherUserFromFriend(friend, hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).whatsappLink!); $event.stopPropagation()"
                        [ngbTooltip]="'FRIENDS.OPEN_WHATSAPP' | translate"
                        placement="top">
                        <i class="fa fa-whatsapp"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Group Members (Not Friends) Section -->
          <div *ngIf="getGroupMembersNotFriends().length > 0">
            <h6 class="mb-3">
              <i class="fa fa-users me-2"></i>
              {{ 'FRIENDS.GROUP_MEMBERS_NOT_FRIENDS' | translate }} ({{ getGroupMembersNotFriends().length }})
            </h6>
            <div class="table-responsive">
              <table class="table table-hover table-sm friends-grid-table">
                <thead>
                  <tr>
                    <th style="width: 30px;"></th>
                    <th>{{ 'FRIENDS.NAME' | translate }}</th>
                    <th>{{ 'FRIENDS.USERNAME' | translate }}</th>
                    <th>{{ 'FRIENDS.GROUPS' | translate }}</th>
                    <th>{{ 'FRIENDS.ACTIONS' | translate }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of getGroupMembersNotFriends()" 
                      style="cursor: pointer;">
                    <td style="text-align: center; vertical-align: middle;">
                      <span class="status-indicator" 
                            [style.background-color]="getUserOnlineStatus(item.member.id).online ? '#28a745' : '#dc3545'"
                            [style.border]="getUserOnlineStatus(item.member.id).online ? '2px solid #28a745' : '2px solid #dc3545'"
                            style="width: 12px; height: 12px; border-radius: 50%; display: inline-block;"
                            [ngbTooltip]="getUserOnlineStatus(item.member.id).online ? ('FRIENDS.ONLINE' | translate) : ('FRIENDS.OFFLINE' | translate)"
                            placement="top"></span>
                    </td>
                    <td>
                      <i class="fa fa-user-circle me-2"></i>
                      {{ item.member.firstName }} {{ item.member.lastName }}
                    </td>
                    <td>
                      <i class="fa fa-at"></i> {{ item.member.userName }}
                    </td>
                    <td>
                      <span class="origin-badge group-badge">
                        <i class="fa fa-users me-1"></i>
                        <span *ngFor="let groupName of item.groups; let last = last">
                          {{ groupName }}<span *ngIf="!last">, </span>
                        </span>
                      </span>
                    </td>
                    <td>
                      <button 
                        *ngIf="item.member.whatsappLink"
                        class="btn btn-xs btn-success compact-btn"
                        (click)="openWhatsAppLink(item.member.whatsappLink!)"
                        [ngbTooltip]="'FRIENDS.OPEN_WHATSAPP' | translate"
                        placement="top">
                        <i class="fa fa-whatsapp"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Friendship Origin Info -->
          <div class="friendship-origin-card mt-3" *ngIf="selectedFriendIndex !== null && getSortedFriendsForDisplay()[selectedFriendIndex]">
            <h6 class="mb-3">
              <i class="fa fa-info-circle me-2"></i>
              {{ 'FRIENDS.FRIENDSHIP_ORIGIN' | translate }}
            </h6>
            <div *ngIf="getSortedFriendsForDisplay()[selectedFriendIndex]">
              <p class="mb-2">
                <strong>{{ getOtherUserFromFriend(getSortedFriendsForDisplay()[selectedFriendIndex], hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).firstName }} {{ getOtherUserFromFriend(getSortedFriendsForDisplay()[selectedFriendIndex], hasAdminRole() && selectedUserForUpdate ? selectedUserForUpdate : currentUser).lastName }}</strong>
              </p>
              <div *ngIf="getFriendshipOrigin(getSortedFriendsForDisplay()[selectedFriendIndex]).type === 'direct'" class="origin-info">
                <p class="text-success">
                  <i class="fa fa-heart me-2"></i>
                  {{ 'FRIENDS.DIRECT_FRIENDSHIP' | translate }}
                </p>
                <p class="text-muted compact-text">
                  {{ 'FRIENDS.FRIENDS_SINCE' | translate }}: {{ getSortedFriendsForDisplay()[selectedFriendIndex].friendshipDate | date:'short' }}
                </p>
              </div>
              <div *ngIf="getFriendshipOrigin(getSortedFriendsForDisplay()[selectedFriendIndex]).type === 'both'" class="origin-info">
                <p class="text-success">
                  <i class="fa fa-heart me-2"></i>
                  {{ 'FRIENDS.DIRECT_FRIENDSHIP' | translate }}
                </p>
                <p class="text-muted compact-text mb-2">
                  {{ 'FRIENDS.FRIENDS_SINCE' | translate }}: {{ getSortedFriendsForDisplay()[selectedFriendIndex].friendshipDate | date:'short' }}
                </p>
                <p class="text-info">
                  <i class="fa fa-users me-2"></i>
                  {{ 'FRIENDS.COMMON_GROUPS' | translate }}
                </p>
                <div *ngIf="getFriendshipOrigin(getSortedFriendsForDisplay()[selectedFriendIndex]).groups && getFriendshipOrigin(getSortedFriendsForDisplay()[selectedFriendIndex]).groups!.length > 0">
                  <ul class="group-list">
                    <li *ngFor="let groupName of getFriendshipOrigin(getSortedFriendsForDisplay()[selectedFriendIndex]).groups">
                      <i class="fa fa-users me-1"></i>{{ groupName }}
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content: Friend Groups -->
  <div *ngIf="activeTab === 'groups'" class="tab-content">
    <!-- Search Filter and Create Button on same line -->
    <div *ngIf="!isCreatingGroup && !editingGroupId" class="d-flex gap-2 align-items-center mb-3">
      <div class="flex-grow-1">
        <div class="input-group">
          <span class="input-group-text">
            <i class="fa fa-search"></i>
          </span>
          <input 
            type="text" 
            class="form-control" 
            [(ngModel)]="searchFilter"
            [placeholder]="'FRIENDS.SEARCH_GROUPS_PLACEHOLDER' | translate">
        </div>
      </div>
      <button 
        class="btn btn-primary btn-sm"
        (click)="startCreatingGroup()">
        <i class="fa fa-plus"></i>
        {{ 'FRIENDS.CREATE_GROUP' | translate }}
      </button>
    </div>

    <!-- Create Group Form -->
    <div *ngIf="isCreatingGroup" class="card mb-3">
      <div class="card-header">
        <h5>{{ 'FRIENDS.CREATE_NEW_GROUP' | translate }}</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="newGroupName" class="form-label">{{ 'FRIENDS.GROUP_NAME' | translate }}</label>
          <input 
            type="text" 
            class="form-control" 
            id="newGroupName"
            [(ngModel)]="newGroupName"
            [placeholder]="'FRIENDS.ENTER_GROUP_NAME' | translate">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ 'FRIENDS.SELECT_MEMBERS' | translate }}</label>
          <div *ngIf="friends.length === 0" class="alert alert-info">
            {{ 'FRIENDS.NO_FRIENDS_TO_ADD' | translate }}
          </div>
          <div *ngIf="friends.length > 0" class="friends-selection">
            <div *ngFor="let friend of friends" class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                [id]="'friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                [checked]="isMemberSelected(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                (change)="toggleGroupMember(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
              <label 
                class="form-check-label" 
                [for]="'friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }} ({{ getOtherUser(friend).userName }})
              </label>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-success" (click)="createFriendGroup()" [disabled]="loading">
            <i class="fa fa-check"></i>
            {{ 'FRIENDS.CREATE' | translate }}
          </button>
          <button class="btn btn-secondary" (click)="cancelCreatingGroup()" [disabled]="loading">
            <i class="fa fa-times"></i>
            {{ 'FRIENDS.CANCEL' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Groups List -->
    <div *ngIf="getFilteredGroups().length === 0 && !isCreatingGroup && friendGroups.length === 0" class="no-results">
      <i class="fa fa-users fa-3x"></i>
      <p>{{ 'FRIENDS.NO_GROUPS' | translate }}</p>
    </div>

    <!-- No Results from Filter -->
    <div *ngIf="friendGroups.length > 0 && getFilteredGroups().length === 0 && !isCreatingGroup" class="no-results">
      <i class="fa fa-search fa-3x"></i>
      <p>{{ 'FRIENDS.NO_GROUPS_FOUND' | translate }}</p>
    </div>

    <div *ngIf="getFilteredGroups().length > 0" class="groups-list">
      <div *ngFor="let group of getFilteredGroups()" class="group-card card mb-2">
        <!-- Card Header with Group Name -->
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fa fa-users me-2"></i>
            {{ group.name }}
          </h5>
        </div>
        <div class="card-body compact-card-body">
          <!-- Badge and Action buttons on same line -->
          <div class="d-flex justify-content-between align-items-center mb-2 gap-2 flex-wrap">
            <div class="d-flex gap-2">
              <div *ngIf="isGroupOwner(group)" class="group-status-tag owner-tag">
                <i class="fa fa-crown text-warning"></i>
                <span class="ms-1">{{ 'FRIENDS.OWNER' | translate }}</span>
              </div>
              <div *ngIf="isGroupAuthorized(group)" class="group-status-tag authorized-tag">
                <i class="fa fa-user-check text-info"></i>
                <span class="ms-1">{{ 'FRIENDS.AUTHORIZED_TO_USE' | translate }}</span>
              </div>
              <div *ngIf="isGroupMember(group)" class="group-status-tag member-tag">
                <i class="fa fa-user text-secondary"></i>
                <span class="ms-1">{{ 'FRIENDS.MEMBER' | translate }}</span>
              </div>
            </div>
            <!-- Action buttons for owner - Right side of badges -->
            <div *ngIf="isGroupOwner(group) && editingGroupId !== group.id" class="d-flex gap-1">
              <button 
                class="btn btn-outline-primary btn-xs compact-btn"
                (click)="startEditingGroup(group)"
                [ngbTooltip]="'FRIENDS.EDIT' | translate"
                placement="top">
                <i class="fa fa-edit"></i>
              </button>
              <button 
                class="btn btn-outline-danger btn-xs compact-btn"
                (click)="deleteFriendGroup(group.id)"
                [ngbTooltip]="'FRIENDS.DELETE' | translate"
                placement="top">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
          <div *ngIf="editingGroupId !== group.id">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <!-- Discussion and WhatsApp Buttons - Below action buttons -->
                <div class="d-flex justify-content-start gap-1 mb-2 flex-wrap">
                  <!-- Discussion Button -->
                  <button 
                    class="btn btn-primary btn-xs compact-btn"
                    (click)="openDiscussionModal(group); $event.stopPropagation()"
                    title="Open Discussion">
                    <i class="fa fa-comments me-1"></i>
                    Discussion
                  </button>
                  <!-- WhatsApp Button (if link exists) -->
                  <button 
                    *ngIf="hasWhatsAppLink(group)"
                    class="btn btn-success btn-xs compact-btn"
                    (click)="openWhatsAppLink(group); $event.stopPropagation()"
                    [ngbTooltip]="'FRIENDS.OPEN_WHATSAPP' | translate"
                    placement="top">
                    <i class="fa fa-whatsapp"></i>
                  </button>
                </div>
                <!-- Discussion Link Display (if exists) -->
                <div *ngIf="group.discussionId" class="mb-2">
                  <p class="text-muted compact-text mb-2">
                    <i class="fa fa-comments profile-icon"></i>
                    <strong class="profile-label">Discussion:</strong> 
                    <a 
                      href="#" 
                      (click)="openDiscussionModal(group); $event.preventDefault()" 
                      class="text-decoration-none text-primary profile-value"
                      title="Click to open discussion">
                      {{ group.discussionId }}
                    </a>
                  </p>
                </div>
                <p class="text-muted compact-text mb-2">
                  <i class="fa fa-crown profile-icon"></i>
                  <strong class="profile-label">{{ 'FRIENDS.GROUP_OWNER' | translate }}:</strong> 
                  <span class="profile-value">{{ group.owner.firstName }} {{ group.owner.lastName }} (<i class="fa fa-at"></i> {{ group.owner.userName }})</span>
                </p>
                <p class="text-muted compact-text mb-2">
                  <i class="fa fa-calendar profile-icon"></i>
                  <strong class="profile-label">{{ 'FRIENDS.CREATION_DATE' | translate }}:</strong> 
                  <span class="profile-value">{{ group.creationDate | date:'short' }}</span>
                </p>
                <div class="members-section mt-2">
                  <h6 class="compact-subtitle mb-2">
                    <i class="fa fa-users profile-icon"></i>
                    <strong>{{ group.members.length }} {{ 'FRIENDS.MEMBERS' | translate }}</strong>
                  </h6>
                  <div *ngIf="group.members.length === 0" class="text-muted compact-text">
                    {{ 'FRIENDS.NO_MEMBERS' | translate }}
                  </div>
                  <div *ngIf="group.members.length > 0" class="members-list mt-1">
                    <div *ngFor="let member of group.members" class="member-item compact-member p-1 mb-1 border rounded">
                      <div class="d-flex align-items-center">
                        <div class="user-avatar me-2">
                          <i class="fa fa-user-circle compact-avatar text-muted"></i>
                        </div>
                        <div class="member-details flex-grow-1">
                          <div class="compact-text fw-bold mb-1">{{ member.firstName }} {{ member.lastName }}</div>
                          <div class="text-muted compact-text">
                            <i class="fa fa-at profile-icon"></i> 
                            <span class="profile-value">{{ member.userName }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Authorized Users Section (only for owner) -->
                <div *ngIf="isGroupOwner(group)" class="authorized-users-section mt-2">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="compact-subtitle mb-0">
                      <i class="fa fa-user-check profile-icon"></i>
                      <strong>{{ 'FRIENDS.AUTHORIZED_USERS' | translate }}</strong>
                      <span *ngIf="group.authorizedUsers && group.authorizedUsers.length > 0" class="authorized-count-tag">
                        {{ group.authorizedUsers.length }}
                      </span>
                    </h6>
                    <button 
                      *ngIf="managingAuthorizedUsersGroupId !== group.id"
                      class="btn btn-xs btn-outline-primary compact-btn"
                      (click)="startManagingAuthorizedUsers(group)">
                      <i class="fa fa-edit"></i>
                      <span class="d-none d-sm-inline ms-1">{{ 'FRIENDS.MANAGE' | translate }}</span>
                    </button>
                  </div>
                  <div *ngIf="managingAuthorizedUsersGroupId !== group.id">
                    <div *ngIf="!group.authorizedUsers || group.authorizedUsers.length === 0" class="text-muted compact-text">
                      {{ 'FRIENDS.NO_AUTHORIZED_USERS' | translate }}
                    </div>
                    <div *ngIf="group.authorizedUsers && group.authorizedUsers.length > 0" class="authorized-users-list mt-1">
                      <div *ngFor="let authorizedUser of group.authorizedUsers" class="authorized-user-item compact-member p-1 mb-1 border rounded bg-light">
                        <div class="d-flex align-items-center justify-content-between">
                          <div class="d-flex align-items-center">
                            <div class="user-avatar me-2">
                              <i class="fa fa-user-check compact-avatar text-success"></i>
                            </div>
                            <div>
                              <div class="compact-text fw-bold mb-1">{{ authorizedUser.firstName }} {{ authorizedUser.lastName }}</div>
                              <div class="text-muted compact-text">
                                <i class="fa fa-at profile-icon"></i> 
                                <span class="profile-value">{{ authorizedUser.userName }}</span>
                              </div>
                            </div>
                          </div>
                          <button 
                            class="btn btn-xs btn-danger compact-btn"
                            (click)="unauthorizeUser(group.id, authorizedUser.id)">
                            <i class="fa fa-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Manage Authorized Users Form -->
                  <div *ngIf="managingAuthorizedUsersGroupId === group.id" class="manage-authorized-users-form mt-2 p-2 border rounded bg-light">
                    <h6 class="compact-subtitle mb-2">{{ 'FRIENDS.SELECT_AUTHORIZED_USERS' | translate }}</h6>
                    <p class="text-muted compact-text mb-2">
                      {{ 'FRIENDS.AUTHORIZED_USERS_HELP' | translate }}
                    </p>
                    <div *ngIf="friends.length === 0" class="alert alert-info compact-alert">
                      {{ 'FRIENDS.NO_FRIENDS_TO_AUTHORIZE' | translate }}
                    </div>
                    <div *ngIf="friends.length > 0" class="friends-selection">
                      <div *ngFor="let friend of friends" class="form-check mb-1">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          [id]="'authorize-' + group.id + '-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                          [checked]="isAuthorizedUserSelected(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                          (change)="toggleAuthorizedUser(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                        <label 
                          class="form-check-label compact-text" 
                          [for]="'authorize-' + group.id + '-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                          {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }} ({{ getOtherUser(friend).userName }})
                          <span *ngIf="isUserAuthorized(group, friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)" class="authorized-user-tag ms-1">
                            <i class="fa fa-check-circle text-success"></i>
                            <span class="ms-1">{{ 'FRIENDS.AUTHORIZED' | translate }}</span>
                          </span>
                        </label>
                      </div>
                    </div>
                    <div class="d-flex gap-1 mt-2">
                      <button class="btn btn-success btn-xs compact-btn" (click)="saveAuthorizedUsers()" [disabled]="loading">
                        <i class="fa fa-check"></i>
                        {{ 'FRIENDS.SAVE' | translate }}
                      </button>
                      <button class="btn btn-secondary btn-xs compact-btn" (click)="cancelManagingAuthorizedUsers()" [disabled]="loading">
                        <i class="fa fa-times"></i>
                        {{ 'FRIENDS.CANCEL' | translate }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Group Form -->
          <div *ngIf="editingGroupId === group.id">
            <div class="mb-2">
              <label for="editingGroupName" class="form-label compact-text">{{ 'FRIENDS.GROUP_NAME' | translate }}</label>
              <input 
                type="text" 
                class="form-control form-control-sm"
                id="editingGroupName"
                [(ngModel)]="editingGroupName">
            </div>
            <div class="mb-2">
              <label for="editingGroupWhatsappLink" class="form-label compact-text">
                <i class="fa fa-whatsapp me-1"></i>
                WhatsApp Group Link
              </label>
              <input 
                type="url" 
                class="form-control form-control-sm"
                id="editingGroupWhatsappLink"
                [(ngModel)]="editingGroupWhatsappLink"
                placeholder="https://chat.whatsapp.com/...">
              <small class="form-text text-muted compact-text">
                Enter the WhatsApp group invite link (optional)
              </small>
            </div>
            <div class="mb-2">
              <label class="form-label compact-text">{{ 'FRIENDS.SELECT_MEMBERS' | translate }}</label>
              <div *ngIf="friends.length > 0" class="friends-selection">
                <div *ngFor="let friend of friends" class="form-check mb-1">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [id]="'edit-friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                    [checked]="isEditingMemberSelected(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                    (change)="toggleEditingGroupMember(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                  <label 
                    class="form-check-label compact-text" 
                    [for]="'edit-friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                    {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }} ({{ getOtherUser(friend).userName }})
                  </label>
                </div>
              </div>
            </div>
            <div class="d-flex gap-1">
              <button class="btn btn-success btn-xs compact-btn" (click)="updateFriendGroup()" [disabled]="loading">
                <i class="fa fa-check"></i>
                {{ 'FRIENDS.SAVE' | translate }}
              </button>
              <button class="btn btn-secondary btn-xs compact-btn" (click)="cancelEditingGroup()" [disabled]="loading">
                <i class="fa fa-times"></i>
                {{ 'FRIENDS.CANCEL' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

