<div class="friends-container">
  <div class="friends-header">
    <h2>
      <i class="fa fa-users"></i>
      {{ 'FRIENDS.TITLE' | translate }}
    </h2>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
    <i class="fa fa-exclamation-triangle"></i>
    {{ errorMessage }}
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="text-center">
    <i class="fa fa-spinner fa-spin fa-3x"></i>
    <p>{{ 'FRIENDS.LOADING' | translate }}</p>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'users'"
        (click)="setActiveTab('users')"
        type="button">
        <i class="fa fa-user-plus"></i>
        {{ 'FRIENDS.ALL_USERS' | translate }}
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'requests'"
        (click)="setActiveTab('requests')"
        type="button">
        <i class="fa fa-envelope"></i>
        {{ 'FRIENDS.REQUESTS' | translate }}
        <span *ngIf="pendingRequests.length > 0" class="badge bg-danger">{{ pendingRequests.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'friends'"
        (click)="setActiveTab('friends')"
        type="button">
        <i class="fa fa-user-friends"></i>
        {{ 'FRIENDS.MY_FRIENDS' | translate }}
        <span *ngIf="friends.length > 0" class="badge bg-success">{{ friends.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button 
        class="nav-link" 
        [class.active]="activeTab === 'groups'"
        (click)="setActiveTab('groups')"
        type="button">
        <i class="fa fa-users"></i>
        {{ 'FRIENDS.FRIEND_GROUPS' | translate }}
        <span *ngIf="friendGroups.length > 0" class="badge bg-info">{{ friendGroups.length }}</span>
      </button>
    </li>
  </ul>

  <!-- Tab Content: All Users -->
  <div *ngIf="activeTab === 'users'" class="tab-content">
    <!-- Invite by Email Section -->
    <div class="invite-section mb-4 p-3 bg-light rounded">
      <h5><i class="fa fa-envelope"></i> {{ 'FRIENDS.INVITE_BY_EMAIL' | translate }}</h5>
      <div class="input-group mb-2">
        <span class="input-group-text">
          <i class="fa fa-at"></i>
        </span>
        <input 
          type="email" 
          class="form-control" 
          [(ngModel)]="inviteEmail"
          (blur)="checkEmailExists()"
          (keyup.enter)="checkEmailExists()"
          [placeholder]="'FRIENDS.ENTER_EMAIL' | translate"
          [disabled]="checkingEmail || sendingInvite">
        <button 
          class="btn btn-outline-secondary" 
          type="button"
          (click)="checkEmailExists()"
          [disabled]="!inviteEmail || checkingEmail || sendingInvite">
          <i class="fa fa-search" *ngIf="!checkingEmail"></i>
          <i class="fa fa-spinner fa-spin" *ngIf="checkingEmail"></i>
          {{ 'FRIENDS.CHECK_EMAIL' | translate }}
        </button>
      </div>
      
      <!-- Email Check Result -->
      <div *ngIf="emailCheckResult !== null" class="mt-2">
        <div *ngIf="emailExists" class="alert alert-info">
          <i class="fa fa-info-circle"></i>
          {{ 'FRIENDS.EMAIL_EXISTS' | translate }}
          <span *ngIf="emailCheckResult.userName"> ({{ emailCheckResult.userName }})</span>
        </div>
        <div *ngIf="!emailExists" class="alert alert-success">
          <i class="fa fa-check-circle"></i>
          {{ 'FRIENDS.EMAIL_NOT_REGISTERED' | translate }}
          <button 
            class="btn btn-success btn-sm ms-2"
            (click)="sendInvitation()"
            [disabled]="sendingInvite">
            <i class="fa fa-paper-plane" *ngIf="!sendingInvite"></i>
            <i class="fa fa-spinner fa-spin" *ngIf="sendingInvite"></i>
            {{ 'FRIENDS.INVITE_TO_PATTOOL' | translate }}
          </button>
        </div>
      </div>
    </div>

    <div class="search-container">
      <div class="input-group mb-3">
        <span class="input-group-text">
          <i class="fa fa-search"></i>
        </span>
        <input 
          type="text" 
          class="form-control" 
          [(ngModel)]="searchFilter"
          [placeholder]="'FRIENDS.SEARCH_PLACEHOLDER' | translate">
      </div>
    </div>

    <div class="users-list">
      <div *ngFor="let user of getFilteredUsers()" class="user-card">
        <div class="user-info">
          <div class="user-avatar">
            <i class="fa fa-user-circle fa-3x"></i>
          </div>
          <div class="user-details">
            <h5>{{ user.firstName }} {{ user.lastName }}</h5>
            <p class="text-muted">
              <i class="fa fa-at"></i> {{ user.userName }}
            </p>
            <p class="text-muted small">
              <i class="fa fa-envelope"></i> {{ user.addressEmail }}
            </p>
            <p class="text-muted small" *ngIf="user.registrationDate">
              <i class="fa fa-calendar-plus-o"></i> 
              {{ 'FRIENDS.REGISTERED_ON' | translate }}: {{ user.registrationDate | date:'short' }}
            </p>
            <p class="text-muted small" *ngIf="user.lastConnectionDate">
              <i class="fa fa-clock-o"></i> 
              {{ 'FRIENDS.LAST_CONNECTION' | translate }}: {{ user.lastConnectionDate | date:'short' }}
            </p>
          </div>
        </div>
        <div class="user-actions">
          <button 
            *ngIf="getUserStatus(user) === 'none'"
            class="btn btn-primary btn-sm"
            (click)="sendFriendRequest(user.id)">
            <i class="fa fa-user-plus"></i>
            {{ 'FRIENDS.SEND_REQUEST' | translate }}
          </button>
          <button 
            *ngIf="getUserStatus(user) === 'pending'"
            class="btn btn-warning btn-sm"
            disabled>
            <i class="fa fa-clock"></i>
            {{ 'FRIENDS.PENDING_REQUEST' | translate }}
          </button>
          <button 
            *ngIf="getUserStatus(user) === 'sent'"
            class="btn btn-info btn-sm"
            disabled>
            <i class="fa fa-paper-plane"></i>
            {{ 'FRIENDS.REQUEST_SENT' | translate }}
          </button>
          <span 
            *ngIf="getUserStatus(user) === 'friend'"
            class="badge bg-success">
            <i class="fa fa-check"></i>
            {{ 'FRIENDS.FRIEND' | translate }}
          </span>
        </div>
      </div>

      <div *ngIf="getFilteredUsers().length === 0" class="no-results">
        <i class="fa fa-search fa-3x"></i>
        <p>{{ 'FRIENDS.NO_USERS_FOUND' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Tab Content: Friend Requests -->
  <div *ngIf="activeTab === 'requests'" class="tab-content">
    <div *ngIf="pendingRequests.length === 0" class="no-results">
      <i class="fa fa-inbox fa-3x"></i>
      <p>{{ 'FRIENDS.NO_PENDING_REQUESTS' | translate }}</p>
    </div>

    <div *ngIf="pendingRequests.length > 0" class="requests-list">
      <div *ngFor="let request of pendingRequests" class="request-card">
        <div class="request-info">
          <div class="user-avatar">
            <i class="fa fa-user-circle fa-3x"></i>
          </div>
          <div class="request-details">
            <h5>{{ request.requester.firstName }} {{ request.requester.lastName }}</h5>
            <p class="text-muted">
              <i class="fa fa-at"></i> {{ request.requester.userName }}
            </p>
            <p class="text-muted small" *ngIf="request.requester.registrationDate">
              <i class="fa fa-calendar-plus-o"></i> 
              {{ 'FRIENDS.REGISTERED_ON' | translate }}: {{ request.requester.registrationDate | date:'short' }}
            </p>
            <p class="text-muted small">
              <i class="fa fa-clock"></i>
              {{ 'FRIENDS.REQUESTED_ON' | translate }}: {{ request.requestDate | date:'short' }}
            </p>
          </div>
        </div>
        <div class="request-actions">
          <button 
            class="btn btn-success btn-sm"
            (click)="approveRequest(request.id)">
            <i class="fa fa-check"></i>
            {{ 'FRIENDS.APPROVE' | translate }}
          </button>
          <button 
            class="btn btn-danger btn-sm"
            (click)="rejectRequest(request.id)">
            <i class="fa fa-times"></i>
            {{ 'FRIENDS.REJECT' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content: My Friends -->
  <div *ngIf="activeTab === 'friends'" class="tab-content">
    <div *ngIf="friends.length === 0" class="no-results">
      <i class="fa fa-user-friends fa-3x"></i>
      <p>{{ 'FRIENDS.NO_FRIENDS' | translate }}</p>
    </div>

    <div *ngIf="friends.length > 0" class="friends-list">
      <div *ngFor="let friend of friends" class="friend-card">
        <div class="friend-info">
          <div class="user-avatar">
            <i class="fa fa-user-circle fa-3x"></i>
          </div>
          <div class="friend-details">
            <h5>{{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }}</h5>
            <p class="text-muted">
              <i class="fa fa-at"></i> {{ getOtherUser(friend).userName }}
            </p>
            <p class="text-muted small" *ngIf="getOtherUser(friend).registrationDate">
              <i class="fa fa-calendar-plus-o"></i> 
              {{ 'FRIENDS.REGISTERED_ON' | translate }}: {{ getOtherUser(friend).registrationDate | date:'short' }}
            </p>
            <p class="text-muted small" *ngIf="getOtherUser(friend).lastConnectionDate">
              <i class="fa fa-clock-o"></i> 
              {{ 'FRIENDS.LAST_CONNECTION' | translate }}: {{ getOtherUser(friend).lastConnectionDate | date:'short' }}
            </p>
            <p class="text-muted small">
              <i class="fa fa-calendar"></i>
              {{ 'FRIENDS.FRIENDS_SINCE' | translate }}: {{ friend.friendshipDate | date:'short' }}
            </p>
          </div>
        </div>
        <div class="friend-actions">
          <button 
            class="btn btn-danger btn-sm"
            (click)="removeFriend(friend.id)">
            <i class="fa fa-user-times"></i>
            {{ 'FRIENDS.REMOVE_FRIEND' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content: Friend Groups -->
  <div *ngIf="activeTab === 'groups'" class="tab-content">
    <div class="mb-3">
      <button 
        *ngIf="!isCreatingGroup && !editingGroupId"
        class="btn btn-primary"
        (click)="startCreatingGroup()">
        <i class="fa fa-plus"></i>
        {{ 'FRIENDS.CREATE_GROUP' | translate }}
      </button>
    </div>

    <!-- Create Group Form -->
    <div *ngIf="isCreatingGroup" class="card mb-3">
      <div class="card-header">
        <h5>{{ 'FRIENDS.CREATE_NEW_GROUP' | translate }}</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="newGroupName" class="form-label">{{ 'FRIENDS.GROUP_NAME' | translate }}</label>
          <input 
            type="text" 
            class="form-control" 
            id="newGroupName"
            [(ngModel)]="newGroupName"
            [placeholder]="'FRIENDS.ENTER_GROUP_NAME' | translate">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ 'FRIENDS.SELECT_MEMBERS' | translate }}</label>
          <div *ngIf="friends.length === 0" class="alert alert-info">
            {{ 'FRIENDS.NO_FRIENDS_TO_ADD' | translate }}
          </div>
          <div *ngIf="friends.length > 0" class="friends-selection">
            <div *ngFor="let friend of friends" class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                [id]="'friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                [checked]="isMemberSelected(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                (change)="toggleGroupMember(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
              <label 
                class="form-check-label" 
                [for]="'friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }} ({{ getOtherUser(friend).userName }})
              </label>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-success" (click)="createFriendGroup()" [disabled]="loading">
            <i class="fa fa-check"></i>
            {{ 'FRIENDS.CREATE' | translate }}
          </button>
          <button class="btn btn-secondary" (click)="cancelCreatingGroup()" [disabled]="loading">
            <i class="fa fa-times"></i>
            {{ 'FRIENDS.CANCEL' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Groups List -->
    <div *ngIf="friendGroups.length === 0 && !isCreatingGroup" class="no-results">
      <i class="fa fa-users fa-3x"></i>
      <p>{{ 'FRIENDS.NO_GROUPS' | translate }}</p>
    </div>

    <div *ngIf="friendGroups.length > 0" class="groups-list">
      <div *ngFor="let group of friendGroups" class="group-card card mb-3">
        <div class="card-body">
          <div *ngIf="editingGroupId !== group.id">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5>{{ group.name }}</h5>
                <p class="text-muted small">
                  <i class="fa fa-user"></i>
                  {{ 'FRIENDS.CREATED_BY' | translate }}: <strong>{{ group.owner.firstName }} {{ group.owner.lastName }}</strong> (<i class="fa fa-at"></i> {{ group.owner.userName }})
                </p>
                <p class="text-muted small">
                  <i class="fa fa-calendar"></i>
                  {{ 'FRIENDS.CREATED_ON' | translate }}: {{ group.creationDate | date:'short' }}
                </p>
                <div class="members-section mt-3">
                  <h6>
                    <i class="fa fa-users"></i>
                    {{ group.members.length }} {{ 'FRIENDS.MEMBERS' | translate }}
                  </h6>
                  <div *ngIf="group.members.length === 0" class="text-muted small">
                    {{ 'FRIENDS.NO_MEMBERS' | translate }}
                  </div>
                  <div *ngIf="group.members.length > 0" class="members-list mt-2">
                    <div *ngFor="let member of group.members" class="member-item p-2 mb-2 border rounded">
                      <div class="d-flex align-items-start">
                        <div class="user-avatar me-3">
                          <i class="fa fa-user-circle fa-2x text-muted"></i>
                        </div>
                        <div class="member-details flex-grow-1">
                          <h6 class="mb-1">{{ member.firstName }} {{ member.lastName }}</h6>
                          <p class="text-muted small mb-1">
                            <i class="fa fa-at"></i> {{ member.userName }}
                          </p>
                          <p class="text-muted small mb-1" *ngIf="member.addressEmail">
                            <i class="fa fa-envelope"></i> {{ member.addressEmail }}
                          </p>
                          <p class="text-muted small mb-1" *ngIf="member.registrationDate">
                            <i class="fa fa-calendar-plus-o"></i> 
                            {{ 'FRIENDS.REGISTERED_ON' | translate }}: {{ member.registrationDate | date:'short' }}
                          </p>
                          <p class="text-muted small mb-0" *ngIf="member.lastConnectionDate">
                            <i class="fa fa-clock-o"></i> 
                            {{ 'FRIENDS.LAST_CONNECTION' | translate }}: {{ member.lastConnectionDate | date:'short' }}
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Authorized Users Section (only for owner) -->
                <div *ngIf="isGroupOwner(group)" class="authorized-users-section mt-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6>
                      <i class="fa fa-user-check"></i>
                      {{ 'FRIENDS.AUTHORIZED_USERS' | translate }}
                      <span *ngIf="group.authorizedUsers && group.authorizedUsers.length > 0" class="badge bg-info">
                        {{ group.authorizedUsers.length }}
                      </span>
                    </h6>
                    <button 
                      *ngIf="managingAuthorizedUsersGroupId !== group.id"
                      class="btn btn-sm btn-outline-primary"
                      (click)="startManagingAuthorizedUsers(group)">
                      <i class="fa fa-edit"></i>
                      {{ 'FRIENDS.MANAGE' | translate }}
                    </button>
                  </div>
                  <div *ngIf="managingAuthorizedUsersGroupId !== group.id">
                    <div *ngIf="!group.authorizedUsers || group.authorizedUsers.length === 0" class="text-muted small">
                      {{ 'FRIENDS.NO_AUTHORIZED_USERS' | translate }}
                    </div>
                    <div *ngIf="group.authorizedUsers && group.authorizedUsers.length > 0" class="authorized-users-list mt-2">
                      <div *ngFor="let authorizedUser of group.authorizedUsers" class="authorized-user-item p-2 mb-2 border rounded bg-light">
                        <div class="d-flex align-items-center justify-content-between">
                          <div class="d-flex align-items-center">
                            <div class="user-avatar me-3">
                              <i class="fa fa-user-check fa-2x text-success"></i>
                            </div>
                            <div>
                              <h6 class="mb-0">{{ authorizedUser.firstName }} {{ authorizedUser.lastName }}</h6>
                              <p class="text-muted small mb-0">
                                <i class="fa fa-at"></i> {{ authorizedUser.userName }}
                              </p>
                            </div>
                          </div>
                          <button 
                            class="btn btn-sm btn-danger"
                            (click)="unauthorizeUser(group.id, authorizedUser.id)">
                            <i class="fa fa-times"></i>
                            {{ 'FRIENDS.REMOVE' | translate }}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Manage Authorized Users Form -->
                  <div *ngIf="managingAuthorizedUsersGroupId === group.id" class="manage-authorized-users-form mt-3 p-3 border rounded bg-light">
                    <h6 class="mb-3">{{ 'FRIENDS.SELECT_AUTHORIZED_USERS' | translate }}</h6>
                    <p class="text-muted small mb-3">
                      {{ 'FRIENDS.AUTHORIZED_USERS_HELP' | translate }}
                    </p>
                    <div *ngIf="friends.length === 0" class="alert alert-info">
                      {{ 'FRIENDS.NO_FRIENDS_TO_AUTHORIZE' | translate }}
                    </div>
                    <div *ngIf="friends.length > 0" class="friends-selection">
                      <div *ngFor="let friend of friends" class="form-check mb-2">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          [id]="'authorize-' + group.id + '-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                          [checked]="isAuthorizedUserSelected(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                          (change)="toggleAuthorizedUser(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                        <label 
                          class="form-check-label" 
                          [for]="'authorize-' + group.id + '-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                          {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }} ({{ getOtherUser(friend).userName }})
                          <span *ngIf="isUserAuthorized(group, friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)" class="badge bg-success ms-2">
                            {{ 'FRIENDS.AUTHORIZED' | translate }}
                          </span>
                        </label>
                      </div>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                      <button class="btn btn-success btn-sm" (click)="saveAuthorizedUsers()" [disabled]="loading">
                        <i class="fa fa-check"></i>
                        {{ 'FRIENDS.SAVE' | translate }}
                      </button>
                      <button class="btn btn-secondary btn-sm" (click)="cancelManagingAuthorizedUsers()" [disabled]="loading">
                        <i class="fa fa-times"></i>
                        {{ 'FRIENDS.CANCEL' | translate }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex flex-column align-items-end">
                <div class="d-flex gap-2 mb-2">
                  <button 
                    class="btn btn-sm btn-info"
                    (click)="openDiscussionModal(group)">
                    <i class="fa fa-comment-dots"></i>
                    Discussion
                  </button>
                </div>
                <div class="d-flex gap-2" *ngIf="isGroupOwner(group)">
                  <button 
                    class="btn btn-sm btn-primary"
                    (click)="startEditingGroup(group)">
                    <i class="fa fa-edit"></i>
                    {{ 'FRIENDS.EDIT' | translate }}
                  </button>
                  <button 
                    class="btn btn-sm btn-danger"
                    (click)="deleteFriendGroup(group.id)">
                    <i class="fa fa-trash"></i>
                    {{ 'FRIENDS.DELETE' | translate }}
                  </button>
                </div>
                <div *ngIf="isGroupOwner(group)" class="badge bg-success mt-2">
                  <i class="fa fa-crown"></i>
                  {{ 'FRIENDS.OWNER' | translate }}
                </div>
              </div>
              <div *ngIf="isGroupAuthorized(group)" class="badge bg-info">
                <i class="fa fa-user-check"></i>
                {{ 'FRIENDS.AUTHORIZED_TO_USE' | translate }}
              </div>
              <div *ngIf="isGroupMember(group)" class="badge bg-secondary">
                <i class="fa fa-user"></i>
                {{ 'FRIENDS.MEMBER' | translate }}
              </div>
            </div>
          </div>

          <!-- Edit Group Form -->
          <div *ngIf="editingGroupId === group.id">
            <div class="mb-3">
              <label for="editingGroupName" class="form-label">{{ 'FRIENDS.GROUP_NAME' | translate }}</label>
              <input 
                type="text" 
                class="form-control" 
                id="editingGroupName"
                [(ngModel)]="editingGroupName">
            </div>
            <div class="mb-3">
              <label class="form-label">{{ 'FRIENDS.SELECT_MEMBERS' | translate }}</label>
              <div *ngIf="friends.length > 0" class="friends-selection">
                <div *ngFor="let friend of friends" class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [id]="'edit-friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                    [checked]="isEditingMemberSelected(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)"
                    (change)="toggleEditingGroupMember(friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                  <label 
                    class="form-check-label" 
                    [for]="'edit-friend-' + (friend.user1.id === currentUser.id ? friend.user2.id : friend.user1.id)">
                    {{ getOtherUser(friend).firstName }} {{ getOtherUser(friend).lastName }} ({{ getOtherUser(friend).userName }})
                  </label>
                </div>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-success btn-sm" (click)="updateFriendGroup()" [disabled]="loading">
                <i class="fa fa-check"></i>
                {{ 'FRIENDS.SAVE' | translate }}
              </button>
              <button class="btn btn-secondary btn-sm" (click)="cancelEditingGroup()" [disabled]="loading">
                <i class="fa fa-times"></i>
                {{ 'FRIENDS.CANCEL' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

